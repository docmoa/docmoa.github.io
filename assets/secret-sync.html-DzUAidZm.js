import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{o as n,c as a,h as e}from"./app-DVMlqOhY.js";const t="/assets/secret-sync-1-BH69r4NY.png",p="/assets/secret-sync-2-DkzLtsap.png",c={},o=e(`<h1 id="vault-secret를-aws-secret-manager-연동" tabindex="-1"><a class="header-anchor" href="#vault-secret를-aws-secret-manager-연동"><span>Vault Secret를 AWS Secret manager 연동</span></a></h1><blockquote><p>Secret Sync 공식 자료: <a href="https://developer.hashicorp.com/vault/docs/sync" target="_blank" rel="noopener noreferrer">Secret Sync</a><br> AWS Secret Manager Sync 자료: <a href="https://developer.hashicorp.com/vault/docs/sync/awssm" target="_blank" rel="noopener noreferrer">Secret Manager Sync</a></p></blockquote><p>현대의 IT 환경에서는 다양한 클라우드 서비스를 사용하는 것이 일반적입니다.<br> 대부분의 경우 AWS를 주로 사용하지만, AWS를 비롯한 클라우드 서비스 제공자(CSP)에서 간헐적으로 발생하는 서비스 이슈를 경험할 때가 있습니다. 특히, AWS 리전의 장애가 발생할 경우를 대비하여, GCP나 Azure, 나아가 IDC를 백업 용도로 고려하는 것이 중요합니다.<br> 관리형 Kubernetes와 같은 관리형 서비스의 대책도 중요하지만, 오늘은 관리형 Secret 도구에 대한 대처 방안에 대해 알아보겠습니다.</p><p>Vault를 사용하면 여러 CSP의 Sync를 통해 하나의 Vault Secret으로 여러 CSP에 Secret을 동기화할 수 있습니다. 이를 통해 각 CSP의 관리형 Kubernetes 환경에 동일한 Secret을 적용할 수 있어, 애플리케이션의 Secret 형상을 일관되게 유지하고 관리할 수 있습니다.</p><p>이제, 이 기능을 어떻게 적용할 수 있는지 알아보겠습니다.</p><h2 id="vault-secret과-aws-secret-manager의-비밀정보를-동기화-과정" tabindex="-1"><a class="header-anchor" href="#vault-secret과-aws-secret-manager의-비밀정보를-동기화-과정"><span>Vault Secret과 AWS Secret Manager의 비밀정보를 동기화 과정</span></a></h2><ol><li>먼저 Vault Policy는 다음과 같이 필요합니다.</li></ol><div class="language-hcl" data-highlighter="prismjs" data-ext="hcl" data-title="hcl"><pre class="language-hcl"><code><span class="line">path <span class="token string">&quot;sys/sync/*&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">capabilities</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;read&quot;</span>, <span class="token string">&quot;list&quot;</span>, <span class="token string">&quot;create&quot;</span>, <span class="token string">&quot;update&quot;</span>, <span class="token string">&quot;delete&quot;</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"> </span>
<span class="line">path <span class="token string">&quot;secret_sync/*&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">capabilities</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;read&quot;</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre></div><ol start="2"><li>Secret Engine을 만들고 데이터를 넣도록 하겠습니다.</li></ol><div class="language-hcl" data-highlighter="prismjs" data-ext="hcl" data-title="hcl"><pre class="language-hcl"><code><span class="line"><span class="token keyword">resource <span class="token type variable">&quot;vault_mount&quot;</span></span> <span class="token string">&quot;secret_sync&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">path</span>        <span class="token punctuation">=</span> <span class="token string">&quot;secret_sync&quot;</span></span>
<span class="line">  <span class="token property">type</span>        <span class="token punctuation">=</span> <span class="token string">&quot;kv&quot;</span></span>
<span class="line">  <span class="token property">options</span>     <span class="token punctuation">=</span> <span class="token punctuation">{</span> <span class="token property">version</span> <span class="token punctuation">=</span> <span class="token string">&quot;2&quot;</span> <span class="token punctuation">}</span></span>
<span class="line">  <span class="token property">description</span> <span class="token punctuation">=</span> <span class="token string">&quot;KV Version 2 secret engine mount&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">resource <span class="token type variable">&quot;vault_kv_secret_v2&quot;</span></span> <span class="token string">&quot;secret_sync&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">mount</span>                      <span class="token punctuation">=</span> vault_mount.secret_sync.path</span>
<span class="line">  <span class="token property">name</span>                       <span class="token punctuation">=</span> <span class="token string">&quot;dev&quot;</span></span>
<span class="line">  <span class="token property">cas</span>                        <span class="token punctuation">=</span> <span class="token number">1</span></span>
<span class="line">  <span class="token property">delete_all_versions</span>        <span class="token punctuation">=</span> <span class="token boolean">true</span></span>
<span class="line">  <span class="token property">data_json</span>                  <span class="token punctuation">=</span> jsonencode(local.secrets_map)</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre></div><ul><li>더미 데이터는 다음과 같습니다.</li></ul><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ <span class="token function">cat</span> secret.csv</span>
<span class="line"></span>
<span class="line">key,secret_path,secret_key,secret_value</span>
<span class="line"><span class="token number">1</span>,path1,oEyzn3Ko,ueWXdREVkbO8</span>
<span class="line"><span class="token number">2</span>,path2,L1wxhMoU,McY5TAQDQFfQ</span>
<span class="line"><span class="token number">3</span>,path3,92ky4qgj,onahCbfYh8IN</span>
<span class="line"><span class="token number">4</span>,path4,oj2aquZr,YvPZOwthQpii</span>
<span class="line"><span class="token number">5</span>,path5,vIqHT6mI,xRRxYsMwklPK</span>
<span class="line"><span class="token number">6</span>,path6,C6dsxbmR,Gryegjb99vvR</span>
<span class="line"><span class="token number">7</span>,path7,e5ksUpsi,hLNFqIFF7gl7</span>
<span class="line"><span class="token number">8</span>,path8,1K7TRAIC,r4uSkISmyvWp</span>
<span class="line"><span class="token number">9</span>,path9,xfTzJl3r,tSFrxHjhpXfs</span>
<span class="line"><span class="token number">10</span>,path10,72ABuQWZ,FthcwQESffIo</span>
<span class="line"></span></code></pre></div><ol start="3"><li>vault ui에서 정상적으로 배포된 secret을 확인합니다.</li></ol><figure><img src="`+t+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol start="4"><li>정상적으로 배포된 Vault Secret을 AWS Secret Manager에 Sync를 진행합니다.</li></ol><ul><li>Terraform code는 다음과 같습니다.</li></ul><div class="language-hcl" data-highlighter="prismjs" data-ext="hcl" data-title="hcl"><pre class="language-hcl"><code><span class="line"><span class="token comment"># name template 참고 링크: https://developer.hashicorp.com/vault/docs/sync#name-template</span></span>
<span class="line"><span class="token keyword">resource <span class="token type variable">&quot;vault_secrets_sync_aws_destination&quot;</span></span> <span class="token string">&quot;static_aws&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">name</span>                 <span class="token punctuation">=</span> <span class="token string">&quot;aws_secret_sync&quot;</span></span>
<span class="line">  <span class="token property">access_key_id</span>        <span class="token punctuation">=</span> var.aws_access_key_id</span>
<span class="line">  <span class="token property">secret_access_key</span>    <span class="token punctuation">=</span> var.aws_secret_access_key</span>
<span class="line">  <span class="token property">region</span>               <span class="token punctuation">=</span> <span class="token string">&quot;ap-northeast-2&quot;</span></span>
<span class="line">  <span class="token property">secret_name_template</span> <span class="token punctuation">=</span> <span class="token string">&quot;vault_{{ .MountAccessor | lowercase }}_{{ .SecretPath | lowercase }}&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">resource <span class="token type variable">&quot;vault_secrets_sync_association&quot;</span></span> <span class="token string">&quot;static_gh_token&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">name</span>        <span class="token punctuation">=</span> vault_secrets_sync_aws_destination.static_aws.name</span>
<span class="line">  <span class="token property">type</span>        <span class="token punctuation">=</span> vault_secrets_sync_aws_destination.static_aws.type</span>
<span class="line">  <span class="token property">mount</span>       <span class="token punctuation">=</span> <span class="token string">&quot;secret_sync&quot;</span></span>
<span class="line">  <span class="token property">secret_name</span> <span class="token punctuation">=</span> <span class="token string">&quot;dev&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre></div><ol start="5"><li>배포를 진행하고 AWS Console에서 확인하면 다음과 같습니다.</li></ol><div class="hint-container info"><p class="hint-container-title">Vault Secret의 License가 없어, 공식홈페이지의 결과 화면입니다.</p><figure><img src="`+p+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></div><h2 id="secret-sync-기능은-다음의-서비스의-동기화를-지원하고-있습니다" tabindex="-1"><a class="header-anchor" href="#secret-sync-기능은-다음의-서비스의-동기화를-지원하고-있습니다"><span>Secret Sync 기능은 다음의 서비스의 동기화를 지원하고 있습니다.</span></a></h2><ul><li>aws</li><li>azure</li><li>gcp</li><li>github</li><li>vercel</li></ul><div class="hint-container info"><p class="hint-container-title">참고</p><p>github action에서는 다음과 같이 활용도 가능합니다.</p><div class="language-yaml" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Login to AWS ECR</span>
<span class="line">  <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">    echo &quot;Set vars&quot;</span>
<span class="line">    AWS_ACCOUNT_ID=$(echo &quot;$AWS_ACCOUNT_ID&quot; | jq -r &#39;.AWS_ACCOUNT_ID&#39;)</span>
<span class="line">    AWS_ACCESS_KEY_ID=$(echo &quot;$AWS_ACCESS_KEY_ID&quot; | jq -r &#39;.AWS_ACCESS_KEY_ID&#39;)</span>
<span class="line">    AWS_SECRET_ACCESS_KEY=$(echo &quot;$AWS_SECRET_ACCESS_KEY&quot; | jq -r &#39;.AWS_SECRET_ACCESS_KEY&#39;)</span>
<span class="line">    echo &quot;Login to AWS ECR&quot;</span>
<span class="line">    aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com</span></span>
<span class="line">  <span class="token key atrule">env</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">AWS_DEFAULT_REGION</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> vars.AWS_DEFAULT_REGION <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token key atrule">AWS_ACCOUNT_ID</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.VAULT_KV_5047F8B7_AWS_ACCOUNT_ID <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token key atrule">AWS_ACCESS_KEY_ID</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.VAULT_KV_5047F8B7_AWS_ACCESS_KEY_ID <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token key atrule">AWS_SECRET_ACCESS_KEY</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.VAULT_KV_5047F8B7_AWS_SECRET_ACCESS_KEY <span class="token punctuation">}</span><span class="token punctuation">}</span>      </span>
<span class="line"></span></code></pre></div></div>`,22),l=[o];function r(i,u){return n(),a("div",null,l)}const _=s(c,[["render",r],["__file","secret-sync.html.vue"]]),g=JSON.parse('{"path":"/04-HashiCorp/06-Vault/04-UseCase/secret-sync.html","title":"Vault Secret를 AWS Secret manager 연동","lang":"ko-KR","frontmatter":{"head":[["meta",{"name":"Vault Secret를 AWS Secret manager 연동","content":"CSP Secret을 Vault로 관리"}],["meta",{"property":"og:url","content":"https://docmoa.github.io/04-HashiCorp/06-Vault/04-UseCase/secret-sync.html"}],["meta",{"property":"og:site_name","content":"docmoa"}],["meta",{"property":"og:title","content":"Vault Secret를 AWS Secret manager 연동"}],["meta",{"property":"og:description","content":"Vault Secret를 AWS Secret manager 연동 Secret Sync 공식 자료: Secret Sync AWS Secret Manager Sync 자료: Secret Manager Sync 현대의 IT 환경에서는 다양한 클라우드 서비스를 사용하는 것이 일반적입니다. 대부분의 경우 AWS를 주로 사용하..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"ko-KR"}],["meta",{"property":"og:updated_time","content":"2024-09-04T13:13:08.000Z"}],["meta",{"property":"article:author","content":"unghee"}],["meta",{"property":"article:tag","content":"SecretManager"}],["meta",{"property":"article:tag","content":"vault"}],["meta",{"property":"article:tag","content":"aws"}],["meta",{"property":"article:modified_time","content":"2024-09-04T13:13:08.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Vault Secret를 AWS Secret manager 연동\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2024-09-04T13:13:08.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"unghee\\"}]}"]],"author":"unghee","tag":["SecretManager","vault","aws"],"description":"Vault Secret를 AWS Secret manager 연동 Secret Sync 공식 자료: Secret Sync AWS Secret Manager Sync 자료: Secret Manager Sync 현대의 IT 환경에서는 다양한 클라우드 서비스를 사용하는 것이 일반적입니다. 대부분의 경우 AWS를 주로 사용하..."},"headers":[{"level":2,"title":"Vault Secret과 AWS Secret Manager의 비밀정보를 동기화 과정","slug":"vault-secret과-aws-secret-manager의-비밀정보를-동기화-과정","link":"#vault-secret과-aws-secret-manager의-비밀정보를-동기화-과정","children":[]},{"level":2,"title":"Secret Sync 기능은 다음의 서비스의 동기화를 지원하고 있습니다.","slug":"secret-sync-기능은-다음의-서비스의-동기화를-지원하고-있습니다","link":"#secret-sync-기능은-다음의-서비스의-동기화를-지원하고-있습니다","children":[]}],"git":{"createdTime":1725080348000,"updatedTime":1725455588000,"contributors":[{"name":"Great-Stone","email":"hahohh@gmail.com","commits":1},{"name":"ung","email":"ung@mz.co.kr","commits":1}]},"readingTime":{"minutes":5.42,"words":325},"filePathRelative":"04-HashiCorp/06-Vault/04-UseCase/secret-sync.md","localizedDate":"2024년 8월 31일","excerpt":"\\n<blockquote>\\n<p>Secret Sync 공식 자료: <a href=\\"https://developer.hashicorp.com/vault/docs/sync\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">Secret Sync</a><br>\\nAWS Secret Manager Sync 자료: <a href=\\"https://developer.hashicorp.com/vault/docs/sync/awssm\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">Secret Manager Sync</a></p>\\n</blockquote>","copyright":{"author":"unghee"},"autoDesc":true}');export{_ as comp,g as data};
