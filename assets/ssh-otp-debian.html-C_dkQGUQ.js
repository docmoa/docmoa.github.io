import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as o,o as c,c as r,b as h,w as e,h as l,g as a,a as s}from"./app-DVMlqOhY.js";const u={},d=l(`<h1 id="ssh-otp-debian-계열" tabindex="-1"><a class="header-anchor" href="#ssh-otp-debian-계열"><span>SSH OTP - Debian 계열</span></a></h1><blockquote><p><a href="https://learn.hashicorp.com/tutorials/vault/pki-engine" target="_blank" rel="noopener noreferrer">https://learn.hashicorp.com/tutorials/vault/pki-engine</a></p></blockquote><h2 id="vault설정" tabindex="-1"><a class="header-anchor" href="#vault설정"><span>Vault설정</span></a></h2><p>시크릿 엔진 활성화</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ vault secrets <span class="token builtin class-name">enable</span> <span class="token parameter variable">-path</span> <span class="token function">ssh</span> <span class="token function">ssh</span></span>
<span class="line"></span></code></pre></div><p>롤 생성</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ vault <span class="token function">write</span> ssh/roles/otp_key_role <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token assign-left variable">key_type</span><span class="token operator">=</span>otp <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token assign-left variable">default_user</span><span class="token operator">=</span>test <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token assign-left variable">allowed_users</span><span class="token operator">=</span>test <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token assign-left variable">key_bits</span><span class="token operator">=</span><span class="token number">2048</span> <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token assign-left variable">cidr_list</span><span class="token operator">=</span><span class="token number">172.28</span>.128.0/24</span>
<span class="line">Success<span class="token operator">!</span> Data written to: ssh/roles/otp_key_role</span>
<span class="line"></span></code></pre></div><blockquote><p>e.g. cidr_list=127.0.0.1/32,172.28.128.1/32 or 0.0.0.0/0</p></blockquote><h2 id="대상-서버-설정" tabindex="-1"><a class="header-anchor" href="#대상-서버-설정"><span>대상 서버 설정</span></a></h2><h3 id="접속할-사용자-생성" tabindex="-1"><a class="header-anchor" href="#접속할-사용자-생성"><span>접속할 사용자 생성</span></a></h3><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ <span class="token function">sudo</span> adduser <span class="token builtin class-name">test</span></span>
<span class="line"></span></code></pre></div><h3 id="vault-ssh-helper-구성-config-hcl" tabindex="-1"><a class="header-anchor" href="#vault-ssh-helper-구성-config-hcl"><span>vault-ssh-helper 구성 &lt;config.hcl&gt;</span></a></h3><blockquote><p><a href="https://github.com/hashicorp/vault-ssh-helper" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/vault-ssh-helper</a></p></blockquote><div class="language-ruby" data-highlighter="prismjs" data-ext="rb" data-title="rb"><pre class="language-ruby"><code><span class="line">vault_addr <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;http://172.28.128.21:8200&quot;</span></span></span>
<span class="line">ssh_mount_point <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;ssh&quot;</span></span></span>
<span class="line">namespace <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;&quot;</span></span></span>
<span class="line">tls_skip_verify <span class="token operator">=</span> <span class="token boolean">true</span></span>
<span class="line">allowed_roles <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;*&quot;</span></span></span>
<span class="line">allowed_cidr_list <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;0.0.0.0/0&quot;</span></span></span>
<span class="line"></span></code></pre></div><h3 id="vault-ssh-helper-다운로드" tabindex="-1"><a class="header-anchor" href="#vault-ssh-helper-다운로드"><span>vault-ssh-helper 다운로드</span></a></h3><blockquote><p><a href="https://releases.hashicorp.com/vault-ssh-helper/" target="_blank" rel="noopener noreferrer">https://releases.hashicorp.com/vault-ssh-helper/</a><br> tls를 사용하지 않는 경우. <code>-dev</code></p></blockquote><p>아래와 같이 검증</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">vault-ssh-helper -verify-only <span class="token parameter variable">-config</span><span class="token operator">=</span>config.hcl <span class="token parameter variable">-dev</span></span>
<span class="line"></span></code></pre></div><h3 id="pam-d-설정" tabindex="-1"><a class="header-anchor" href="#pam-d-설정"><span>pam.d 설정</span></a></h3>`,19),m=s("p",null,[s("code",null,"/etc/pam.d/sshd"),a(" 파일의 "),s("code",null,"@include common-auth"),a(" 부분을 다음과 같이 변경 추가")],-1),v=s("div",{class:"language-properties","data-highlighter":"prismjs","data-ext":"properties","data-title":"properties"},[s("pre",{class:"language-properties"},[s("code",null,[s("span",{class:"line"},[s("span",{class:"token comment"},"#@include common-auth")]),a(`
`),s("span",{class:"line"},[s("span",{class:"token key attr-name"},"auth"),a(),s("span",{class:"token value attr-value"},"requisite pam_exec.so quiet expose_authtok log=/tmp/vaultssh.log /usr/local/bin/vault-ssh-helper -config=/etc/vault-ssh-helper.d/config.hcl -dev")]),a(`
`),s("span",{class:"line"},[s("span",{class:"token key attr-name"},"auth"),a(),s("span",{class:"token value attr-value"},"optional pam_unix.so not_set_pass use_first_pass nodelay")]),a(`
`),s("span",{class:"line"})])])],-1),g=s("p",null,[s("code",null,"/etc/pam.d/common-auth"),a(" 파일의 "),s("code",null,"auth [success=1 dufault=ignore]"),a(" 아래 2줄 추가")],-1),k=s("div",{class:"language-properties line-numbers-mode","data-highlighter":"prismjs","data-ext":"properties","data-title":"properties"},[s("pre",{class:"language-properties"},[s("code",null,[s("span",{class:"line"},[s("span",{class:"token comment"},'# here are the per-package modules (the "Primary" block)')]),a(`
`),s("span",{class:"line"},[s("span",{class:"token key attr-name"},"auth"),a(),s("span",{class:"token value attr-value"},"   [success=1 default=ignore]      pam_unix.so nullok_secure")]),a(`
`),s("span",{class:"line highlighted"},[s("span",{class:"token key attr-name"},"auth"),a(),s("span",{class:"token value attr-value"},"   [success=3 default=ignore]      pam_exec.so quiet expose_authtok log=/tmp/vaultssh.log /usr/local/bin/vault-ssh-helper -config=/etc/vault-ssh-helper.d/config.hcl -dev")]),a(`
`),s("span",{class:"line highlighted"},[s("span",{class:"token key attr-name"},"auth"),a(),s("span",{class:"token value attr-value"},"   [success=2 default=ignore]      pam_unix.so not_set_pass use_first_pass nodelay")]),a(`
`),s("span",{class:"line"},[s("span",{class:"token comment"},"# here's the fallback if no module succeeds")]),a(`
`),s("span",{class:"line"},[s("span",{class:"token key attr-name"},"auth"),a(),s("span",{class:"token value attr-value"},"   requisite                       pam_deny.so")]),a(`
`),s("span",{class:"line"},[s("span",{class:"token comment"},"# prime the stack with a positive return value if there isn't one already;")]),a(`
`),s("span",{class:"line"},[s("span",{class:"token comment"},"# this avoids us returning an error just because nothing sets a success code")]),a(`
`),s("span",{class:"line"},[s("span",{class:"token comment"},"# since the modules above will each just jump around")]),a(`
`),s("span",{class:"line"},[s("span",{class:"token key attr-name"},"auth"),a(),s("span",{class:"token value attr-value"},"   required                        pam_permit.so")]),a(`
`),s("span",{class:"line"},[s("span",{class:"token comment"},'# and here are more per-package modules (the "Additional" block)')]),a(`
`),s("span",{class:"line"},[s("span",{class:"token key attr-name"},"auth"),a(),s("span",{class:"token value attr-value"},"   optional                        pam_cap.so ")]),a(`
`),s("span",{class:"line"},[s("span",{class:"token comment"},"# end of pam-auth-update config")]),a(`
`),s("span",{class:"line"})])]),s("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),b=l(`<h3 id="ssh-설정" tabindex="-1"><a class="header-anchor" href="#ssh-설정"><span>ssh 설정</span></a></h3><p><code>/etc/ssh/sshd_config</code> 파일의 <code>ChallengeResponseAuthentication</code> 부분을 수정</p><blockquote><p>이미 있는 옵션은 값 수정, 없는 옵션은 추가</p></blockquote><div class="language-properties" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="line"><span class="token key attr-name">ChallengeResponseAuthentication</span> <span class="token value attr-value">yes</span></span>
<span class="line"><span class="token key attr-name">UsePAM</span> <span class="token value attr-value">yes</span></span>
<span class="line"><span class="token key attr-name">PasswordAuthentication</span> <span class="token value attr-value">no</span></span>
<span class="line"></span></code></pre></div><h3 id="ssh-서비스-재시작" tabindex="-1"><a class="header-anchor" href="#ssh-서비스-재시작"><span>ssh 서비스 재시작</span></a></h3><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ systemctl restart <span class="token function">ssh</span></span>
<span class="line"></span></code></pre></div><h2 id="테스트" tabindex="-1"><a class="header-anchor" href="#테스트"><span>테스트</span></a></h2><p>otp 발급</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ vault <span class="token function">write</span> ssh/creds/otp_key_role <span class="token assign-left variable">ip</span><span class="token operator">=</span><span class="token number">172.28</span>.128.31</span>
<span class="line">Key                Value</span>
<span class="line">---                -----</span>
<span class="line">lease_id           ssh/creds/otp_key_role/r2SFjhwt3brVT0msL1KEq2Dv</span>
<span class="line">lease_duration     768h</span>
<span class="line">lease_renewable    <span class="token boolean">false</span></span>
<span class="line"><span class="token function">ip</span>                 <span class="token number">172.28</span>.128.31</span>
<span class="line">key                f8a32d6c-beec-383c-62d6-3718b367f88d</span>
<span class="line">key_type           otp</span>
<span class="line">port               <span class="token number">22</span></span>
<span class="line">username           <span class="token builtin class-name">test</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="접속-방법-1-ssh" tabindex="-1"><a class="header-anchor" href="#접속-방법-1-ssh"><span>접속 방법 1. ssh</span></a></h3><blockquote><p>Password: 에 앞서 요청한 롤의 credential 값의 <code>key</code> 를 넣어준다.</p></blockquote><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ <span class="token function">ssh</span> test@172.28.128.31</span>
<span class="line">Password:</span>
<span class="line"></span></code></pre></div><h3 id="접속-방법-2-vault-ssh" tabindex="-1"><a class="header-anchor" href="#접속-방법-2-vault-ssh"><span>접속 방법 2. vault ssh</span></a></h3><blockquote><p>Vault로 해당 ssh otp에 권한이 있는 사용자인 경우 <code>sshpass</code> 가 설치되어있으면 자동 입력</p></blockquote><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ vault <span class="token function">ssh</span> <span class="token parameter variable">-role</span> otp_key_role <span class="token parameter variable">-mode</span> otp test@172.28.128.31</span>
<span class="line">or</span>
<span class="line">$ vault <span class="token function">ssh</span> <span class="token parameter variable">-role</span> otp_key_role <span class="token parameter variable">-mode</span> otp -strict-host-key-checking<span class="token operator">=</span>no test@172.28.128.31</span>
<span class="line"></span></code></pre></div>`,15);function _(f,y){const p=o("Tabs");return c(),r("div",null,[d,h(p,{id:"55",data:[{id:"기존 PW 방식을 대체"},{id:"기존 PW와 함께 사용"}]},{title0:e(({value:n,isActive:t})=>[a("기존 PW 방식을 대체")]),title1:e(({value:n,isActive:t})=>[a("기존 PW와 함께 사용")]),tab0:e(({value:n,isActive:t})=>[m,v]),tab1:e(({value:n,isActive:t})=>[g,k]),_:1}),b])}const S=i(u,[["render",_],["__file","ssh-otp-debian.html.vue"]]),j=JSON.parse('{"path":"/04-HashiCorp/06-Vault/02-Secret_Engine/ssh-otp-debian.html","title":"SSH OTP - Debian 계열","lang":"ko-KR","frontmatter":{"description":"Vault SSH Ubuntu에 구성하는 예제","tag":["vault","SSH","OTP","Debian","Ubuntu"],"head":[["meta",{"property":"og:url","content":"https://docmoa.github.io/04-HashiCorp/06-Vault/02-Secret_Engine/ssh-otp-debian.html"}],["meta",{"property":"og:site_name","content":"docmoa"}],["meta",{"property":"og:title","content":"SSH OTP - Debian 계열"}],["meta",{"property":"og:description","content":"Vault SSH Ubuntu에 구성하는 예제"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"ko-KR"}],["meta",{"property":"og:updated_time","content":"2023-10-25T07:28:39.000Z"}],["meta",{"property":"article:tag","content":"vault"}],["meta",{"property":"article:tag","content":"SSH"}],["meta",{"property":"article:tag","content":"OTP"}],["meta",{"property":"article:tag","content":"Debian"}],["meta",{"property":"article:tag","content":"Ubuntu"}],["meta",{"property":"article:modified_time","content":"2023-10-25T07:28:39.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"SSH OTP - Debian 계열\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2023-10-25T07:28:39.000Z\\",\\"author\\":[]}"]]},"headers":[{"level":2,"title":"Vault설정","slug":"vault설정","link":"#vault설정","children":[]},{"level":2,"title":"대상 서버 설정","slug":"대상-서버-설정","link":"#대상-서버-설정","children":[{"level":3,"title":"접속할 사용자 생성","slug":"접속할-사용자-생성","link":"#접속할-사용자-생성","children":[]},{"level":3,"title":"vault-ssh-helper 구성 <config.hcl>","slug":"vault-ssh-helper-구성-config-hcl","link":"#vault-ssh-helper-구성-config-hcl","children":[]},{"level":3,"title":"vault-ssh-helper 다운로드","slug":"vault-ssh-helper-다운로드","link":"#vault-ssh-helper-다운로드","children":[]},{"level":3,"title":"pam.d 설정","slug":"pam-d-설정","link":"#pam-d-설정","children":[]},{"level":3,"title":"ssh 설정","slug":"ssh-설정","link":"#ssh-설정","children":[]},{"level":3,"title":"ssh 서비스 재시작","slug":"ssh-서비스-재시작","link":"#ssh-서비스-재시작","children":[]}]},{"level":2,"title":"테스트","slug":"테스트","link":"#테스트","children":[{"level":3,"title":"접속 방법 1. ssh","slug":"접속-방법-1-ssh","link":"#접속-방법-1-ssh","children":[]},{"level":3,"title":"접속 방법 2. vault ssh","slug":"접속-방법-2-vault-ssh","link":"#접속-방법-2-vault-ssh","children":[]}]}],"git":{"createdTime":1628563561000,"updatedTime":1698218919000,"contributors":[{"name":"Great-Stone","email":"hahohh@gmail.com","commits":5},{"name":"Administrator","email":"admin@example.com","commits":2}]},"readingTime":{"minutes":5.55,"words":333},"filePathRelative":"04-HashiCorp/06-Vault/02-Secret_Engine/ssh-otp-debian.md","localizedDate":"2021년 8월 10일","excerpt":"\\n<blockquote>\\n<p><a href=\\"https://learn.hashicorp.com/tutorials/vault/pki-engine\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">https://learn.hashicorp.com/tutorials/vault/pki-engine</a></p>\\n</blockquote>\\n<h2>Vault설정</h2>\\n<p>시크릿 엔진 활성화</p>\\n<div class=\\"language-bash\\" data-highlighter=\\"prismjs\\" data-ext=\\"sh\\" data-title=\\"sh\\"><pre class=\\"language-bash\\"><code><span class=\\"line\\">$ vault secrets <span class=\\"token builtin class-name\\">enable</span> <span class=\\"token parameter variable\\">-path</span> <span class=\\"token function\\">ssh</span> <span class=\\"token function\\">ssh</span></span>\\n<span class=\\"line\\"></span></code></pre></div>"}');export{S as comp,j as data};
