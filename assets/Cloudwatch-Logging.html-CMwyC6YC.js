import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{o as s,c as a,h as e}from"./app-DVMlqOhY.js";const p="/assets/Cloudwatch-logging-Nomad-B1kkD22-.png",t="/assets/Cloudwatch-logging-aws-DrZcdlMF.png",o={},l=e(`<h1 id="docker-log-driver-and-cloudwatch-on-nomad" tabindex="-1"><a class="header-anchor" href="#docker-log-driver-and-cloudwatch-on-nomad"><span>Docker log driver and Cloudwatch on Nomad</span></a></h1><p>docker 런타임에는 log driver로 &quot;awslogs&quot;를 지원합니다.<br><a href="https://docs.docker.com/config/containers/logging/awslogs/" target="_blank" rel="noopener noreferrer">https://docs.docker.com/config/containers/logging/awslogs/</a></p><div class="hint-container tip"><p class="hint-container-title">팁</p><p>Nomad에서 docker 자체의 로깅을 사용하므로서, Nomad에서 실행되는 docker 기반 컨테이너의 로깅이 특정 환경에 락인되는것을 방지합니다.</p></div><div class="hint-container warning"><p class="hint-container-title">경고</p><p>AWS 환경이 아닌 외부 구성 시, 해당 노드에 Cloudwath 기록을 위한 Policy를 갖는 IAM의 credential 정보가 환경변수 또는 <code>~/.aws/credential</code> 구성이 필요합니다.</p></div><h2 id="ec2-instance-role-구성" tabindex="-1"><a class="header-anchor" href="#ec2-instance-role-구성"><span>EC2 Instance Role 구성</span></a></h2><p>Nomad 구성 시 Cloudwatch에 대한 EC2 Instance의 IAM 구성이 필요합니다. 아래 Terraform 구성의 예를 참고하세요.</p><ul><li>loging driver의 구성에 따라 <code>aws_iam_role_policy</code>에 설정하는 필요한 권한에 차이가 있을 수 있습니다.</li><li>예를 들어 docker loging 구성에서 <code>awslogs-create-group = true</code> 옵션을 추가하려는 경우 <code>logs:CreateLogGroup</code> 정책이 필요합니다.</li><li>권한에 대한 상세 설명은 다음 링크를 참고합니다. <a href="https://docs.aws.amazon.com/ko_kr/AmazonCloudWatch/latest/logs/permissions-reference-cwl.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/ko_kr/AmazonCloudWatch/latest/logs/permissions-reference-cwl.html</a></li></ul><div class="language-hcl line-numbers-mode" data-highlighter="prismjs" data-ext="hcl" data-title="hcl"><pre class="language-hcl"><code><span class="line"><span class="token comment">## 생략 ##</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">resource <span class="token type variable">&quot;aws_iam_instance_profile&quot;</span></span> <span class="token string">&quot;ec2_profile&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">name</span> <span class="token punctuation">=</span> <span class="token string">&quot;ec2_profile&quot;</span></span>
<span class="line">  <span class="token property">role</span> <span class="token punctuation">=</span> aws_iam_role.role.name</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">resource <span class="token type variable">&quot;aws_iam_role&quot;</span></span> <span class="token string">&quot;role&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">name</span> <span class="token punctuation">=</span> <span class="token string">&quot;my_role&quot;</span></span>
<span class="line"></span>
<span class="line">  <span class="token property">assume_role_policy</span> <span class="token punctuation">=</span> jsonencode(<span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">Version</span> <span class="token punctuation">=</span> <span class="token string">&quot;2012-10-17&quot;</span></span>
<span class="line">    <span class="token property">Statement</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">Action</span> <span class="token punctuation">=</span> <span class="token string">&quot;sts:AssumeRole&quot;</span></span>
<span class="line">        <span class="token property">Effect</span> <span class="token punctuation">=</span> <span class="token string">&quot;Allow&quot;</span></span>
<span class="line">        <span class="token property">Sid</span>    <span class="token punctuation">=</span> <span class="token string">&quot;&quot;</span></span>
<span class="line">        <span class="token property">Principal</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token property">Service</span> <span class="token punctuation">=</span> <span class="token string">&quot;ec2.amazonaws.com&quot;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span>,</span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">}</span>)</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">resource <span class="token type variable">&quot;aws_iam_role_policy&quot;</span></span> <span class="token string">&quot;cloudwatch_policy&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">name</span>        <span class="token punctuation">=</span> <span class="token string">&quot;cloudwatch_policy&quot;</span></span>
<span class="line">  <span class="token property">role</span>        <span class="token punctuation">=</span> aws_iam_role.role.id</span>
<span class="line">  </span>
<span class="line">  <span class="token property">policy</span> <span class="token punctuation">=</span> jsonencode(<span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">Version</span> <span class="token punctuation">=</span> <span class="token string">&quot;2012-10-17&quot;</span></span>
<span class="line">    <span class="token property">Statement</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">Action</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span></span>
<span class="line highlighted">          <span class="token string">&quot;logs:CreateLogStream&quot;</span>,</span>
<span class="line highlighted">          <span class="token string">&quot;logs:PutLogEvents&quot;</span>,</span>
<span class="line highlighted">          <span class="token string">&quot;logs:CreateLogGroup&quot;</span></span>
<span class="line">        <span class="token punctuation">]</span></span>
<span class="line">        <span class="token property">Effect</span>   <span class="token punctuation">=</span> <span class="token string">&quot;Allow&quot;</span></span>
<span class="line">        <span class="token property">Resource</span> <span class="token punctuation">=</span> <span class="token string">&quot;*&quot;</span></span>
<span class="line">      <span class="token punctuation">}</span>,</span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">}</span>)</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">resource <span class="token type variable">&quot;aws_instance&quot;</span></span> <span class="token string">&quot;example&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">ami</span>           <span class="token punctuation">=</span> <span class="token string">&quot;ami-04e6fcf8cfe3b09ea&quot;</span></span>
<span class="line">  <span class="token property">instance_type</span> <span class="token punctuation">=</span> <span class="token string">&quot;t2.micro&quot;</span></span>
<span class="line">  <span class="token property">key_name</span>      <span class="token punctuation">=</span> aws_key_pair.web_admin.key_name</span>
<span class="line">  <span class="token property">vpc_security_group_ids</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span></span>
<span class="line">    aws_security_group.ssh.id</span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line highlighted">  <span class="token property">iam_instance_profile</span> <span class="token punctuation">=</span> aws_iam_instance_profile.ec2_profile.name</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="nomad-job의-docker-driver에-logging-설정" tabindex="-1"><a class="header-anchor" href="#nomad-job의-docker-driver에-logging-설정"><span>Nomad Job의 Docker Driver에 Logging 설정</span></a></h2><p>Nomad에서 docker 드라이버 사용시 적용되는 기본 log driver는 <code>json-file</code> 입니다. 추가 설정을 통해 docker가 지원하는 다양한 log driver를 사용할 수 있습니다. (<a href="https://www.nomadproject.io/docs/drivers/docker#logging" target="_blank" rel="noopener noreferrer">FluentD 샘플</a>)</p><ul><li>구성에 필요한 정보는 Docker의 공식 문서를 참고 합니다. : <a href="https://docs.docker.com/config/containers/logging/configure/" target="_blank" rel="noopener noreferrer">https://docs.docker.com/config/containers/logging/configure/</a></li><li>기존 docker cli 상에 구성했던 <code>--log-driver</code> 같은 옵션의 정의가 HCL형태로 정의됩니다.</li><li>HCL 문법을 따르므로, 몇몇 상이한 표현방식이 있을 수 있습니다. 예를들어 로그 날짜 구성에 사용되는 <code>&quot;\\[%Y-%m-%d\\]&quot;</code> 에서 <code>[</code> 같은 특수문자 표기를 위해 <code>\\</code>를 한번만 넣었다면, <code>&quot;\\\\[%Y-%m-%d\\\\]&quot;</code> 같이 두번 넣어야 할수도 있습니다.</li></ul><p>구성 예제는 아래와 같습니다.</p><div class="language-hcl line-numbers-mode" data-highlighter="prismjs" data-ext="hcl" data-title="hcl"><pre class="language-hcl"><code><span class="line">job <span class="token string">&quot;api&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token property">datacenters</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;dc1&quot;</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token property">type</span> <span class="token punctuation">=</span> <span class="token string">&quot;service&quot;</span></span>
<span class="line"></span>
<span class="line">  group <span class="token string">&quot;api&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">network</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">mode</span> <span class="token punctuation">=</span> <span class="token string">&quot;bridge&quot;</span></span>
<span class="line">      port <span class="token string">&quot;api&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">to</span> <span class="token punctuation">=</span> <span class="token number">9001</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">service</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">name</span> <span class="token punctuation">=</span> <span class="token string">&quot;count-api&quot;</span></span>
<span class="line">      <span class="token property">port</span> <span class="token punctuation">=</span> <span class="token string">&quot;api&quot;</span></span>
<span class="line">      <span class="token keyword">connect</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">sidecar_service</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    task <span class="token string">&quot;web&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">driver</span> <span class="token punctuation">=</span> <span class="token string">&quot;docker&quot;</span></span>
<span class="line">      <span class="token keyword">config</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">image</span> <span class="token punctuation">=</span> <span class="token string">&quot;hashicorpnomad/counter-api:v1&quot;</span></span>
<span class="line">        <span class="token property">ports</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;api&quot;</span><span class="token punctuation">]</span></span>
<span class="line highlighted">        <span class="token keyword">logging</span> <span class="token punctuation">{</span></span>
<span class="line highlighted">          <span class="token property">type</span> <span class="token punctuation">=</span> <span class="token string">&quot;awslogs&quot;</span></span>
<span class="line highlighted">          <span class="token keyword">config</span> <span class="token punctuation">{</span></span>
<span class="line highlighted">            <span class="token property">awslogs-region</span> <span class="token punctuation">=</span> <span class="token string">&quot;ap-northeast-2&quot;</span></span>
<span class="line highlighted">            <span class="token property">awslogs-group</span> <span class="token punctuation">=</span> <span class="token string">&quot;myGroup&quot;</span></span>
<span class="line highlighted">            <span class="token property">awslogs-create-group</span> <span class="token punctuation">=</span> <span class="token boolean">true</span></span>
<span class="line highlighted">            <span class="token property">awslogs-datetime-format</span> <span class="token punctuation">=</span> <span class="token string">&quot;\\\\[%Y-%m-%dT%H:%M:%S\\\\+09:00\\\\]&quot;</span></span>
<span class="line highlighted">          <span class="token punctuation">}</span></span>
<span class="line highlighted">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="log-확인" tabindex="-1"><a class="header-anchor" href="#log-확인"><span>Log 확인</span></a></h2><p>Nomad의 로그 출력을 확인합니다.<br><img src="`+p+'" alt="NomadLog" loading="lazy"></p><p>Cloudwatch에 로그 출력을 확인합니다.<br><img src="'+t+'" alt="NomadLog" loading="lazy"></p>',16),i=[l];function c(r,u){return s(),a("div",null,i)}const g=n(o,[["render",c],["__file","Cloudwatch-Logging.html.vue"]]),m=JSON.parse('{"path":"/04-HashiCorp/07-Nomad/02-Config/Cloudwatch-Logging.html","title":"Docker log driver and Cloudwatch on Nomad","lang":"ko-KR","frontmatter":{"description":"Nomad docker job logging into Cloudwatch","tag":["Nomad","AWS","Cloudwatch","log"],"head":[["meta",{"property":"og:url","content":"https://docmoa.github.io/04-HashiCorp/07-Nomad/02-Config/Cloudwatch-Logging.html"}],["meta",{"property":"og:site_name","content":"docmoa"}],["meta",{"property":"og:title","content":"Docker log driver and Cloudwatch on Nomad"}],["meta",{"property":"og:description","content":"Nomad docker job logging into Cloudwatch"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"ko-KR"}],["meta",{"property":"og:updated_time","content":"2023-09-18T13:12:54.000Z"}],["meta",{"property":"article:tag","content":"Nomad"}],["meta",{"property":"article:tag","content":"AWS"}],["meta",{"property":"article:tag","content":"Cloudwatch"}],["meta",{"property":"article:tag","content":"log"}],["meta",{"property":"article:modified_time","content":"2023-09-18T13:12:54.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Docker log driver and Cloudwatch on Nomad\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2023-09-18T13:12:54.000Z\\",\\"author\\":[]}"]]},"headers":[{"level":2,"title":"EC2 Instance Role 구성","slug":"ec2-instance-role-구성","link":"#ec2-instance-role-구성","children":[]},{"level":2,"title":"Nomad Job의 Docker Driver에 Logging 설정","slug":"nomad-job의-docker-driver에-logging-설정","link":"#nomad-job의-docker-driver에-logging-설정","children":[]},{"level":2,"title":"Log 확인","slug":"log-확인","link":"#log-확인","children":[]}],"git":{"createdTime":1639533195000,"updatedTime":1695042774000,"contributors":[{"name":"Administrator","email":"admin@example.com","commits":3},{"name":"Great-Stone","email":"hahohh@gmail.com","commits":1}]},"readingTime":{"minutes":4.27,"words":256},"filePathRelative":"04-HashiCorp/07-Nomad/02-Config/Cloudwatch-Logging.md","localizedDate":"2021년 12월 15일","excerpt":"\\n<p>docker 런타임에는 log driver로 \\"awslogs\\"를 지원합니다.<br>\\n<a href=\\"https://docs.docker.com/config/containers/logging/awslogs/\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">https://docs.docker.com/config/containers/logging/awslogs/</a></p>\\n<div class=\\"hint-container tip\\">\\n<p class=\\"hint-container-title\\">팁</p>\\n<p>Nomad에서 docker 자체의 로깅을 사용하므로서, Nomad에서 실행되는 docker 기반 컨테이너의 로깅이 특정 환경에 락인되는것을 방지합니다.</p>\\n</div>"}');export{g as comp,m as data};
