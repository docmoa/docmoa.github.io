import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{o as a,c as n,h as e}from"./app-DVMlqOhY.js";const t={},l=e(`<h1 id="vault-agent-with-aws-secret" tabindex="-1"><a class="header-anchor" href="#vault-agent-with-aws-secret"><span>Vault Agent (with aws secret)</span></a></h1><blockquote><p>참고 URL : <a href="https://learn.hashicorp.com/tutorials/vault/agent-aws" target="_blank" rel="noopener noreferrer">https://learn.hashicorp.com/tutorials/vault/agent-aws</a></p></blockquote><details class="hint-container details"><summary>Test ENV</summary><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ sw_vers</span>
<span class="line">ProductName:	macOS</span>
<span class="line">ProductVersion:	<span class="token number">12.4</span></span>
<span class="line"></span>
<span class="line">$ vault version</span>
<span class="line">Vault v1.11.0</span>
<span class="line"></span></code></pre></div></details><h2 id="_1-vault-server-dev-mode" tabindex="-1"><a class="header-anchor" href="#_1-vault-server-dev-mode"><span>1. Vault Server (dev mode)</span></a></h2><h3 id="_1-1-vault-setup" tabindex="-1"><a class="header-anchor" href="#_1-1-vault-setup"><span>1.1 Vault Setup</span></a></h3><h4 id="vault-start-dev-mode" tabindex="-1"><a class="header-anchor" href="#vault-start-dev-mode"><span>Vault Start Dev mode</span></a></h4><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">vault server <span class="token parameter variable">-dev</span> -dev-root-token-id<span class="token operator">=</span>root</span>
<span class="line"></span></code></pre></div><h4 id="vault-env" tabindex="-1"><a class="header-anchor" href="#vault-env"><span>Vault Env</span></a></h4><blockquote><p>Another terminal</p></blockquote><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable">VAULT_ADDR</span><span class="token operator">=</span>http://127.0.0.1:8200</span>
<span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable">VAULT_TOKEN</span><span class="token operator">=</span>root</span>
<span class="line"></span></code></pre></div><h3 id="_1-2-dynamic-sectet-sample-aws" tabindex="-1"><a class="header-anchor" href="#_1-2-dynamic-sectet-sample-aws"><span>1.2 Dynamic Sectet Sample (AWS)</span></a></h3><h4 id="setup-aws-env" tabindex="-1"><a class="header-anchor" href="#setup-aws-env"><span>Setup AWS Env</span></a></h4><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_ACCESS_KEY</span><span class="token operator">=</span>AKIAU3NXXXXX</span>
<span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_SECRET_KEY</span><span class="token operator">=</span>Rex3GPUKO3++123</span>
<span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_REGION</span><span class="token operator">=</span>ap-northeast-2</span>
<span class="line"></span></code></pre></div><h4 id="enable-aws-secret-engine" tabindex="-1"><a class="header-anchor" href="#enable-aws-secret-engine"><span>Enable AWS Secret Engine</span></a></h4><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">vault secrets <span class="token builtin class-name">enable</span> aws</span>
<span class="line"></span></code></pre></div><h4 id="aws-secret-engine-configuration" tabindex="-1"><a class="header-anchor" href="#aws-secret-engine-configuration"><span>AWS Secret Engine Configuration</span></a></h4><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">vault <span class="token function">write</span> aws/config/root <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token assign-left variable">access_key</span><span class="token operator">=</span><span class="token variable">$AWS_ACCESS_KEY</span> <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token assign-left variable">secret_key</span><span class="token operator">=</span><span class="token variable">$AWS_SECRET_KEY</span> <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token assign-left variable">region</span><span class="token operator">=</span><span class="token variable">$AWS_REGION</span></span>
<span class="line"></span></code></pre></div><h4 id="aws-secret-engine-lease-change" tabindex="-1"><a class="header-anchor" href="#aws-secret-engine-lease-change"><span>AWS Secret Engine Lease change</span></a></h4><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">vault <span class="token function">write</span> /aws/config/lease <span class="token assign-left variable">lease</span><span class="token operator">=</span>1m <span class="token assign-left variable">lease_max</span><span class="token operator">=</span>1m</span>
<span class="line"></span></code></pre></div><h4 id="role-setup-e-g-s3" tabindex="-1"><a class="header-anchor" href="#role-setup-e-g-s3"><span>Role setup (e.g. s3)</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">vault <span class="token function">write</span> aws/roles/s3 <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token assign-left variable">credential_type</span><span class="token operator">=</span>iam_user <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token assign-left variable">policy_document</span><span class="token operator">=</span>-<span class="token operator">&lt;&lt;</span><span class="token string">EOF</span>
<span class="line">{</span>
<span class="line">  &quot;Version&quot;: &quot;2012-10-17&quot;,</span>
<span class="line">  &quot;Statement&quot;: [</span>
<span class="line">    {</span>
<span class="line">      &quot;Effect&quot;: &quot;Allow&quot;,</span>
<span class="line">      &quot;Action&quot;: [</span>
<span class="line">     		&quot;s3:PutObject&quot;,</span>
<span class="line">      	&quot;s3:PutObjectAcl&quot;</span>
<span class="line">      ],</span>
<span class="line">      &quot;Resource&quot;: &quot;*&quot;</span>
<span class="line">    }</span>
<span class="line">  ]</span>
<span class="line">}</span>
<span class="line">EOF</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="test-aws-secret" tabindex="-1"><a class="header-anchor" href="#test-aws-secret"><span>Test AWS Secret</span></a></h4><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ vault <span class="token function">write</span> <span class="token parameter variable">-force</span> aws/creds/s3</span>
<span class="line">Key                Value</span>
<span class="line">---                -----</span>
<span class="line">lease_id           aws/creds/s3/w5hPWazlpWu4jKHUyR0WBnbZ</span>
<span class="line">lease_duration     1m</span>
<span class="line">lease_renewable    <span class="token boolean">true</span></span>
<span class="line">access_key         AKIAU3NXDWRUCYVDBEYM</span>
<span class="line">secret_key         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</span>
<span class="line">security_token     <span class="token operator">&lt;</span>nil<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre></div><h3 id="_1-3-approle-setup" tabindex="-1"><a class="header-anchor" href="#_1-3-approle-setup"><span>1.3 Approle Setup</span></a></h3><h4 id="vault-policy-for-aws" tabindex="-1"><a class="header-anchor" href="#vault-policy-for-aws"><span>Vault Policy for AWS</span></a></h4><div class="language-text" data-highlighter="prismjs" data-ext="text" data-title="text"><pre class="language-text"><code><span class="line">cat &lt;&lt;EOF | vault policy write aws_policy -</span>
<span class="line">path &quot;aws/creds/s3&quot; {</span>
<span class="line">  capabilities = [&quot;read&quot;,&quot;update&quot;]</span>
<span class="line">}</span>
<span class="line">EOF</span>
<span class="line"></span></code></pre></div><h4 id="approle-create" tabindex="-1"><a class="header-anchor" href="#approle-create"><span>Approle Create</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ vault auth <span class="token builtin class-name">enable</span> approle</span>
<span class="line"></span>
<span class="line">Success<span class="token operator">!</span> Enabled approle auth method at: approle/</span>
<span class="line"></span>
<span class="line">$ vault <span class="token function">write</span> auth/approle/role/aws-cred <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token assign-left variable">secret_id_ttl</span><span class="token operator">=</span>120m <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token assign-left variable">token_ttl</span><span class="token operator">=</span>60m <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token assign-left variable">token_max_ttl</span><span class="token operator">=</span>120m <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token assign-left variable">policies</span><span class="token operator">=</span><span class="token string">&quot;aws_policy&quot;</span></span>
<span class="line">    </span>
<span class="line">Success<span class="token operator">!</span> Data written to: auth/approle/role/aws-cred</span>
<span class="line"></span>
<span class="line">$ vault <span class="token builtin class-name">read</span> auth/approle/role/aws-cred/role-id</span>
<span class="line"></span>
<span class="line">Key        Value</span>
<span class="line">---        -----</span>
<span class="line">role_id    430111ee-5955-aa83-a53d-924b7e11ac36</span>
<span class="line"></span>
<span class="line">$ vault <span class="token function">write</span> <span class="token parameter variable">-f</span> auth/approle/role/aws-cred/secret-id</span>
<span class="line"></span>
<span class="line">Key                   Value</span>
<span class="line">---                   -----</span>
<span class="line">secret_id             7f86b671-2f47-f841-18a4-c36ca34ab8d8</span>
<span class="line">secret_id_accessor    9ad4256a-acc6-e8c0-f7fe-7633e66b1318</span>
<span class="line">secret_id_ttl         2h</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>role_id</code>는 Pipeline 작성에 사용</li></ul><h2 id="_2-vault-agent" tabindex="-1"><a class="header-anchor" href="#_2-vault-agent"><span>2. Vault Agent</span></a></h2><h3 id="_2-1-vault-config" tabindex="-1"><a class="header-anchor" href="#_2-1-vault-config"><span>2.1 Vault Config</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> ./vault-agent-config.hcl</span></span>
<span class="line">pid_file = &quot;./pidfile&quot;</span>
<span class="line"></span>
<span class="line">listener &quot;tcp&quot; {</span>
<span class="line">	address = &quot;127.0.0.1:9200&quot;</span>
<span class="line">	tls_disable = true</span>
<span class="line">	# tls_cert_file = &quot;/path/to/cert.pem&quot;</span>
<span class="line">  # tls_key_file = &quot;/path/to/key.pem&quot;</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">cache {</span>
<span class="line">  use_auto_auth_token = true</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">auto_auth {</span>
<span class="line">  method  {</span>
<span class="line">    type = &quot;approle&quot;</span>
<span class="line">    config = {</span>
<span class="line">      role_id_file_path = &quot;./role_id.txt&quot;</span>
<span class="line">      secret_id_file_path = &quot;./secret_id.txt&quot;</span>
<span class="line">    }</span>
<span class="line">  }</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">vault {</span>
<span class="line">  address = &quot;http://127.0.0.1:8200&quot;</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line"># template 은 여러개 설정 가능</span>
<span class="line">template {</span>
<span class="line">  source      = &quot;./aws_cred.tpl&quot;</span>
<span class="line">  destination = &quot;./aws_cred.txt&quot;</span>
<span class="line">  command     = &quot;cat ./aws_cred.txt&quot; # 생략 가능</span>
<span class="line">}</span>
<span class="line">EOF</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-vault-template" tabindex="-1"><a class="header-anchor" href="#_2-2-vault-template"><span>2.2 Vault Template</span></a></h3><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> ./aws_cred.tpl</span></span>
<span class="line">{{- with secret &quot;aws/creds/s3&quot; -}}</span>
<span class="line">aws_access_key={{ .Data.access_key | toJSON }}</span>
<span class="line">aws_secret_key={{ .Data.secret_key | toJSON }}</span>
<span class="line">{{- end }}</span>
<span class="line">EOF</span></span>
<span class="line"></span></code></pre></div><h2 id="_3-vault-agent" tabindex="-1"><a class="header-anchor" href="#_3-vault-agent"><span>3. Vault Agent</span></a></h2><h3 id="_3-1-run-vault-agent" tabindex="-1"><a class="header-anchor" href="#_3-1-run-vault-agent"><span>3.1 Run Vault Agent</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ vault <span class="token builtin class-name">read</span> <span class="token parameter variable">-field</span> role_id auth/approle/role/aws-cred/role-id <span class="token operator">&gt;</span> ./role_id.txt</span>
<span class="line"></span>
<span class="line">$ vault <span class="token function">write</span> <span class="token parameter variable">-f</span> <span class="token parameter variable">-field</span> secret_id auth/approle/role/aws-cred/secret-id <span class="token operator">&gt;</span> ./secret_id.txt</span>
<span class="line"></span>
<span class="line">$ vault agent <span class="token parameter variable">-config</span><span class="token operator">=</span>./vault-agent-config.hcl</span>
<span class="line"><span class="token operator">==</span><span class="token operator">&gt;</span> Vault agent started<span class="token operator">!</span> Log data will stream <span class="token keyword">in</span> below:</span>
<span class="line"></span>
<span class="line"><span class="token operator">==</span><span class="token operator">&gt;</span> Vault agent configuration:</span>
<span class="line"></span>
<span class="line">           Api Address <span class="token number">1</span>: http://127.0.0.1:9200</span>
<span class="line">           Api Address <span class="token number">2</span>: http://bufconn</span>
<span class="line">                     Cgo: disabled</span>
<span class="line">               Log Level: info</span>
<span class="line">                 Version: Vault v1.11.0, built <span class="token number">2022</span>-06-17T15:48:44Z</span>
<span class="line">             Version Sha: ea296ccf58507b25051bc0597379c467046eb2f1</span>
<span class="line"></span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:08.726+0900 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  sink.file: creating <span class="token function">file</span> sink</span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:08.727+0900 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  sink.file: <span class="token function">file</span> sink configured: <span class="token assign-left variable">path</span><span class="token operator">=</span>/tmp/vault_agent <span class="token assign-left variable">mode</span><span class="token operator">=</span>-rw-r-----</span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:08.728+0900 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  sink.server: starting sink server</span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:08.730+0900 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  template.server: starting template server</span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:08.730+0900 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  auth.handler: starting auth handler</span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:08.730+0900 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  auth.handler: authenticating</span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:08.736+0900 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">(</span>runner<span class="token punctuation">)</span> creating new runner <span class="token punctuation">(</span>dry: false, once: <span class="token boolean">false</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:08.739+0900 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  auth.handler: authentication successful, sending token to sinks</span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:08.740+0900 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  auth.handler: starting renewal process</span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:08.740+0900 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  sink.file: token written: <span class="token assign-left variable">path</span><span class="token operator">=</span>/tmp/vault_agent</span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:08.743+0900 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">(</span>runner<span class="token punctuation">)</span> creating watcher</span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:08.745+0900 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  auth.handler: renewed auth token</span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:08.745+0900 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  template.server: template server received new token</span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:08.745+0900 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">(</span>runner<span class="token punctuation">)</span> stopping</span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:08.745+0900 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">(</span>runner<span class="token punctuation">)</span> creating new runner <span class="token punctuation">(</span>dry: false, once: <span class="token boolean">false</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:08.745+0900 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">(</span>runner<span class="token punctuation">)</span> creating watcher</span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:08.747+0900 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">(</span>runner<span class="token punctuation">)</span> starting</span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:11.635+0900 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">(</span>runner<span class="token punctuation">)</span> rendered <span class="token string">&quot;./aws_cred.tpl&quot;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;./aws_cred.txt&quot;</span></span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:11.635+0900 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">(</span>runner<span class="token punctuation">)</span> executing <span class="token builtin class-name">command</span> <span class="token string">&quot;[<span class="token entity" title="\\&quot;">\\&quot;</span>cat ./aws_cred.txt<span class="token entity" title="\\&quot;">\\&quot;</span>]&quot;</span> from <span class="token string">&quot;./aws_cred.tpl&quot;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;./aws_cred.txt&quot;</span></span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:11.637+0900 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">(</span>child<span class="token punctuation">)</span> spawning: <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token function">cat</span> ./aws_cred.txt</span>
<span class="line"><span class="token assign-left variable">aws_access_key</span><span class="token operator">=</span><span class="token string">&quot;AKIAU3NXDWRUHRF5SJDM&quot;</span></span>
<span class="line"><span class="token assign-left variable">aws_secret_key</span><span class="token operator">=</span><span class="token string">&quot;sErZfcuGnrZBAWoWCn5ackM/AWtp0iFHBR2RKP8a&quot;</span></span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:54.978+0900 <span class="token punctuation">[</span>WARN<span class="token punctuation">]</span> vault.read<span class="token punctuation">(</span>aws/creds/s3<span class="token punctuation">)</span>: TTL of <span class="token string">&quot;1m&quot;</span> exceeded the effective max_ttl of <span class="token string">&quot;17s&quot;</span><span class="token punctuation">;</span> TTL value is capped accordingly</span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:54.978+0900 <span class="token punctuation">[</span>WARN<span class="token punctuation">]</span> vault.read<span class="token punctuation">(</span>aws/creds/s3<span class="token punctuation">)</span>: renewer <span class="token keyword">done</span> <span class="token punctuation">(</span>maybe the lease expired<span class="token punctuation">)</span></span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:57.422+0900 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">(</span>runner<span class="token punctuation">)</span> rendered <span class="token string">&quot;./aws_cred.tpl&quot;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;./aws_cred.txt&quot;</span></span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:57.422+0900 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">(</span>runner<span class="token punctuation">)</span> executing <span class="token builtin class-name">command</span> <span class="token string">&quot;[<span class="token entity" title="\\&quot;">\\&quot;</span>cat ./aws_cred.txt<span class="token entity" title="\\&quot;">\\&quot;</span>]&quot;</span> from <span class="token string">&quot;./aws_cred.tpl&quot;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;./aws_cred.txt&quot;</span></span>
<span class="line"><span class="token number">2022</span>-06-30T17:17:57.422+0900 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">(</span>child<span class="token punctuation">)</span> spawning: <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token function">cat</span> ./aws_cred.txt</span>
<span class="line"><span class="token assign-left variable">aws_access_key</span><span class="token operator">=</span><span class="token string">&quot;AKIAU3NXDWRUETMPDDOH&quot;</span></span>
<span class="line"><span class="token assign-left variable">aws_secret_key</span><span class="token operator">=</span><span class="token string">&quot;FKBZd/xTdHGxoOf4eZ+L4KUQ99NXblOV4UCZIKyo&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ <span class="token function">watch</span> <span class="token function">cat</span> ./aws_cred.txt</span>
<span class="line">Every <span class="token number">2</span>.0s: <span class="token function">cat</span> ./aws_cred.txt                             gs-C02CT3ZFML85: Thu Jun <span class="token number">30</span> <span class="token number">17</span>:19:01 <span class="token number">2022</span></span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">aws_access_key</span><span class="token operator">=</span><span class="token string">&quot;AKIAU3NXDWRUHRF5SJDM&quot;</span></span>
<span class="line"><span class="token assign-left variable">aws_secret_key</span><span class="token operator">=</span><span class="token string">&quot;sErZfcuGnrZBAWoWCn5ackM/AWtp0iFHBR2RKP8a&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token operator">&lt;&lt;</span> expire 되면 다시 발급 됨 <span class="token operator">&gt;&gt;</span></span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">aws_access_key</span><span class="token operator">=</span><span class="token string">&quot;AKIAU3NXDWRUOOG33CPC&quot;</span></span>
<span class="line"><span class="token assign-left variable">aws_secret_key</span><span class="token operator">=</span><span class="token string">&quot;tJ1Hjxx45ra7RRqRkHcB5LhLbPstdSC2p8oBa3ZF&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-vault-agent-api-endpoint" tabindex="-1"><a class="header-anchor" href="#_3-2-vault-agent-api-endpoint"><span>3.2 Vault Agent API Endpoint</span></a></h3><p>Vault Agent로는 X-Vault-Token 없이 API 호출 가능</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ <span class="token function">curl</span> <span class="token parameter variable">-X</span> GET http://127.0.0.1:9200/v1/aws/creds/s3 <span class="token operator">|</span> jq <span class="token string">&#39;.data&#39;</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string">&quot;access_key&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;AKIAU3NXDWRUJJ4UW2P2&quot;</span>,</span>
<span class="line">  <span class="token string">&quot;secret_key&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;BeI7xebPR75nXSJ9mzSsyh8P3qiwhCx5mqlh76R0&quot;</span>,</span>
<span class="line">  <span class="token string">&quot;security_token&quot;</span><span class="token builtin class-name">:</span> null</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre></div><h3 id="_3-3-vault-systemd-sample" tabindex="-1"><a class="header-anchor" href="#_3-3-vault-systemd-sample"><span>3.3 Vault Systemd Sample</span></a></h3><div class="language-ini line-numbers-mode" data-highlighter="prismjs" data-ext="ini" data-title="ini"><pre class="language-ini"><code><span class="line"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">Unit</span><span class="token punctuation">]</span></span></span>
<span class="line"><span class="token key attr-name">Description</span><span class="token punctuation">=</span><span class="token value attr-value">Nomad Agent</span></span>
<span class="line"><span class="token key attr-name">Requires</span><span class="token punctuation">=</span><span class="token value attr-value">consul-online.target</span></span>
<span class="line"><span class="token key attr-name">After</span><span class="token punctuation">=</span><span class="token value attr-value">consul-online.target</span></span>
<span class="line"></span>
<span class="line"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">Service</span><span class="token punctuation">]</span></span></span>
<span class="line"><span class="token key attr-name">KillMode</span><span class="token punctuation">=</span><span class="token value attr-value">process</span></span>
<span class="line"><span class="token key attr-name">KillSignal</span><span class="token punctuation">=</span><span class="token value attr-value">SIGINT</span></span>
<span class="line"><span class="token key attr-name">Environment</span><span class="token punctuation">=</span><span class="token value attr-value">VAULT_ADDR=http://active.vault.service.consul:8200</span></span>
<span class="line"><span class="token key attr-name">Environment</span><span class="token punctuation">=</span><span class="token value attr-value">VAULT_SKIP_VERIFY=true</span></span>
<span class="line"><span class="token key attr-name">ExecStartPre</span><span class="token punctuation">=</span><span class="token value attr-value">/usr/local/bin/vault agent -config /etc/vault-agent.d/vault-agent.hcl</span></span>
<span class="line"><span class="token key attr-name">ExecStart</span><span class="token punctuation">=</span><span class="token value attr-value">/usr/bin/nomad-vault.sh</span></span>
<span class="line"><span class="token key attr-name">ExecReload</span><span class="token punctuation">=</span><span class="token value attr-value">/bin/kill -HUP $MAINPID</span></span>
<span class="line"><span class="token key attr-name">Restart</span><span class="token punctuation">=</span><span class="token value attr-value">on-failure</span></span>
<span class="line"><span class="token key attr-name">RestartSec</span><span class="token punctuation">=</span><span class="token value attr-value">2</span></span>
<span class="line"><span class="token key attr-name">StartLimitBurst</span><span class="token punctuation">=</span><span class="token value attr-value">3</span></span>
<span class="line"><span class="token key attr-name">StartLimitIntervalSec</span><span class="token punctuation">=</span><span class="token value attr-value">10</span></span>
<span class="line"><span class="token key attr-name">LimitNOFILE</span><span class="token punctuation">=</span><span class="token value attr-value">65536</span></span>
<span class="line"></span>
<span class="line"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">Install</span><span class="token punctuation">]</span></span></span>
<span class="line"><span class="token key attr-name">WantedBy</span><span class="token punctuation">=</span><span class="token value attr-value">multi-user.target</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,43),p=[l];function i(c,o){return a(),n("div",null,p)}const d=s(t,[["render",i],["__file","vault-agent.html.vue"]]),v=JSON.parse('{"path":"/04-HashiCorp/06-Vault/06-Config/vault-agent.html","title":"Vault Agent (with aws secret)","lang":"ko-KR","frontmatter":{"description":"Vault Agent Configuration","tag":["Vault","AWS","Configuration","Agent"],"head":[["meta",{"property":"og:url","content":"https://docmoa.github.io/04-HashiCorp/06-Vault/06-Config/vault-agent.html"}],["meta",{"property":"og:site_name","content":"docmoa"}],["meta",{"property":"og:title","content":"Vault Agent (with aws secret)"}],["meta",{"property":"og:description","content":"Vault Agent Configuration"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"ko-KR"}],["meta",{"property":"og:updated_time","content":"2023-09-18T13:12:54.000Z"}],["meta",{"property":"article:tag","content":"Vault"}],["meta",{"property":"article:tag","content":"AWS"}],["meta",{"property":"article:tag","content":"Configuration"}],["meta",{"property":"article:tag","content":"Agent"}],["meta",{"property":"article:modified_time","content":"2023-09-18T13:12:54.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Vault Agent (with aws secret)\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2023-09-18T13:12:54.000Z\\",\\"author\\":[]}"]]},"headers":[{"level":2,"title":"1. Vault Server (dev mode)","slug":"_1-vault-server-dev-mode","link":"#_1-vault-server-dev-mode","children":[{"level":3,"title":"1.1 Vault Setup","slug":"_1-1-vault-setup","link":"#_1-1-vault-setup","children":[]},{"level":3,"title":"1.2 Dynamic Sectet Sample (AWS)","slug":"_1-2-dynamic-sectet-sample-aws","link":"#_1-2-dynamic-sectet-sample-aws","children":[]},{"level":3,"title":"1.3 Approle Setup","slug":"_1-3-approle-setup","link":"#_1-3-approle-setup","children":[]}]},{"level":2,"title":"2. Vault Agent","slug":"_2-vault-agent","link":"#_2-vault-agent","children":[{"level":3,"title":"2.1 Vault Config","slug":"_2-1-vault-config","link":"#_2-1-vault-config","children":[]},{"level":3,"title":"2.2 Vault Template","slug":"_2-2-vault-template","link":"#_2-2-vault-template","children":[]}]},{"level":2,"title":"3. Vault Agent","slug":"_3-vault-agent","link":"#_3-vault-agent","children":[{"level":3,"title":"3.1 Run Vault Agent","slug":"_3-1-run-vault-agent","link":"#_3-1-run-vault-agent","children":[]},{"level":3,"title":"3.2 Vault Agent API Endpoint","slug":"_3-2-vault-agent-api-endpoint","link":"#_3-2-vault-agent-api-endpoint","children":[]},{"level":3,"title":"3.3 Vault Systemd Sample","slug":"_3-3-vault-systemd-sample","link":"#_3-3-vault-systemd-sample","children":[]}]}],"git":{"createdTime":1656577693000,"updatedTime":1695042774000,"contributors":[{"name":"Administrator","email":"admin@example.com","commits":1},{"name":"Great-Stone","email":"hahohh@gmail.com","commits":1}]},"readingTime":{"minutes":13.85,"words":831},"filePathRelative":"04-HashiCorp/06-Vault/06-Config/vault-agent.md","localizedDate":"2022년 6월 30일","excerpt":"\\n<blockquote>\\n<p>참고 URL : <a href=\\"https://learn.hashicorp.com/tutorials/vault/agent-aws\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">https://learn.hashicorp.com/tutorials/vault/agent-aws</a></p>\\n</blockquote>\\n<details class=\\"hint-container details\\"><summary>Test ENV</summary>\\n<div class=\\"language-bash\\" data-highlighter=\\"prismjs\\" data-ext=\\"sh\\" data-title=\\"sh\\"><pre class=\\"language-bash\\"><code><span class=\\"line\\">$ sw_vers</span>\\n<span class=\\"line\\">ProductName:\\tmacOS</span>\\n<span class=\\"line\\">ProductVersion:\\t<span class=\\"token number\\">12.4</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\">$ vault version</span>\\n<span class=\\"line\\">Vault v1.11.0</span>\\n<span class=\\"line\\"></span></code></pre></div></details>"}');export{d as comp,v as data};
