import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{o as a,c as n,h as e}from"./app-DVMlqOhY.js";const t="/assets/3044639378-Ba20dN9J.png?width=760",l="/assets/3044606085-B10ZP7cx.png?width=760",p="/assets/3044639401-DaqRZ6X9.png?width=760",i="/assets/3044540515-DdI_F-iM.png?width=760",c="/assets/3044540525-Dh260Qus.png?width=760",o={},u=e(`<h1 id="eks-vault-sidecar를-활용한-logrotate-설정" tabindex="-1"><a class="header-anchor" href="#eks-vault-sidecar를-활용한-logrotate-설정"><span>EKS Vault sidecar를 활용한 logrotate 설정</span></a></h1><blockquote><ul><li><a href="#eksvaultsidecar%EB%A5%BC%ED%99%9C%EC%9A%A9%ED%95%9Clogrotate%EC%84%A4%EC%A0%95-%EC%B0%B8%EA%B3%A0:https://github.com/hansemerkur/vault-logrotate">참고: https://github.com/HanseMerkur/vault-logrotate</a></li><li><a href="#eksvaultsidecar%EB%A5%BC%ED%99%9C%EC%9A%A9%ED%95%9Clogrotate%EC%84%A4%EC%A0%95-%EC%B0%B8%EA%B3%A0:%EB%B2%84%EC%A0%84%ED%99%95%EC%9D%B8">참고: 버전 확인</a></li></ul></blockquote><table><thead><tr><th style="text-align:center;"></th><th style="text-align:center;">확인 버전</th></tr></thead><tbody><tr><td style="text-align:center;">eks cluster</td><td style="text-align:center;">v1.24</td></tr><tr><td style="text-align:center;">aws cli</td><td style="text-align:center;">v2.10.1</td></tr><tr><td style="text-align:center;">eks ctl</td><td style="text-align:center;">v0.130.0</td></tr><tr><td style="text-align:center;">helm</td><td style="text-align:center;">v3.10.3</td></tr></tbody></table><h2 id="_1-efs-csi-driver-설치" tabindex="-1"><a class="header-anchor" href="#_1-efs-csi-driver-설치"><span>1. EFS CSI Driver 설치</span></a></h2><h3 id="_1-1-iam-정책을-만들-json-파일-가져오기-iam-policy-example-json" tabindex="-1"><a class="header-anchor" href="#_1-1-iam-정책을-만들-json-파일-가져오기-iam-policy-example-json"><span>1.1 IAM 정책을 만들 json 파일 가져오기 iam-policy-example.json</span></a></h3><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line"><span class="token function">curl</span> <span class="token parameter variable">-O</span> https://raw.githubusercontent.com/kubernetes-sigs/aws-efs-csi-driver/master/docs/iam-policy-example.json</span>
<span class="line"></span></code></pre></div><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="iam-policy-example.json"><pre class="language-json"><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;Version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2012-10-17&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;Statement&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Allow&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;Action&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token string">&quot;elasticfilesystem:DescribeAccessPoints&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;elasticfilesystem:DescribeFileSystems&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;elasticfilesystem:DescribeMountTargets&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;ec2:DescribeAvailabilityZones&quot;</span></span>
<span class="line">      <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;\\*&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Allow&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;Action&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token string">&quot;elasticfilesystem:CreateAccessPoint&quot;</span></span>
<span class="line">      <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;\\*&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;Condition&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;StringLike&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token property">&quot;aws:RequestTag/efs.csi.aws.com/cluster&quot;</span><span class="token operator">:</span> <span class="token string">&quot;true&quot;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Allow&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;Action&quot;</span><span class="token operator">:</span> <span class="token string">&quot;elasticfilesystem:DeleteAccessPoint&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;\\*&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;Condition&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;StringEquals&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token property">&quot;aws:ResourceTag/efs.csi.aws.com/cluster&quot;</span><span class="token operator">:</span> <span class="token string">&quot;true&quot;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2-iam-정책" tabindex="-1"><a class="header-anchor" href="#_1-2-iam-정책"><span>1.2 IAM 정책</span></a></h3><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">aws iam create-policy <span class="token punctuation">\\</span></span>
<span class="line">  --policy-name AmazonEKS<span class="token punctuation">\\</span>_EFS_CSI_Driver_Policy <span class="token punctuation">\\</span></span>
<span class="line">  --policy-document file://iam-policy-example.json</span>
<span class="line"></span></code></pre></div><h3 id="_1-3-클러스터의-oidc-공급자-url" tabindex="-1"><a class="header-anchor" href="#_1-3-클러스터의-oidc-공급자-url"><span>1.3 클러스터의 OIDC 공급자 URL</span></a></h3><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">aws eks describe-cluster <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">--name</span> my-cluster <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">--query</span> <span class="token string">&quot;cluster.identity.oidc.issuer&quot;</span> <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">--output</span> text <span class="token punctuation">\\</span></span>
<span class="line">  https://oidc.eks.region-code.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE</span>
<span class="line"></span></code></pre></div><h3 id="_1-4-trust-policy" tabindex="-1"><a class="header-anchor" href="#_1-4-trust-policy"><span>1.4 trust-policy</span></a></h3><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="trust-policy.json"><pre class="language-json"><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;Version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2012-10-17&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;Statement&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Allow&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;Principal&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;Federated&quot;</span><span class="token operator">:</span> <span class="token string">&quot;arn:aws:iam::111122223333:oidc-provider/oidc.eks.region-code.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE&quot;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;Action&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sts:AssumeRoleWithWebIdentity&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;Condition&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;StringEquals&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token property">&quot;oidc.eks.region-code.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE:sub&quot;</span><span class="token operator">:</span><span class="token string">&quot;system:serviceaccount:kube-system:efs-csi-controller-sa&quot;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-4-역할-생성" tabindex="-1"><a class="header-anchor" href="#_1-4-역할-생성"><span>1.4 역할 생성</span></a></h3><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">aws iam create-role <span class="token punctuation">\\</span></span>
<span class="line">  --role-name AmazonEKS<span class="token punctuation">\\</span>_EFS<span class="token punctuation">\\</span>_CSI<span class="token punctuation">\\</span>_DriverRole <span class="token punctuation">\\</span></span>
<span class="line">  --assume-role-policy-document file://<span class="token string">&quot;trust-policy.json&quot;</span></span>
<span class="line"></span></code></pre></div><h3 id="_1-5-iam-정책을-역할에-연결" tabindex="-1"><a class="header-anchor" href="#_1-5-iam-정책을-역할에-연결"><span>1.5 IAM 정책을 역할에 연결</span></a></h3><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">aws iam attach-role-policy <span class="token punctuation">\\</span></span>
<span class="line">  --policy-arn arn:aws:iam::111122223333:policy/AmazonEKS<span class="token punctuation">\\</span>_EFS<span class="token punctuation">\\</span>_CSI<span class="token punctuation">\\</span>_Driver<span class="token punctuation">\\</span>_Policy <span class="token punctuation">\\</span></span>
<span class="line">  --role-name AmazonEKS<span class="token punctuation">\\</span>_EFS<span class="token punctuation">\\</span>_CSI<span class="token punctuation">\\</span>_DriverRole</span>
<span class="line"></span></code></pre></div><h3 id="_1-6-생성한-iam-역할의-arn이-추가된-kubernetes-sa을-생성" tabindex="-1"><a class="header-anchor" href="#_1-6-생성한-iam-역할의-arn이-추가된-kubernetes-sa을-생성"><span>1.6 생성한 IAM 역할의 ARN이 추가된 Kubernetes SA을 생성</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> aws<span class="token punctuation">-</span>efs<span class="token punctuation">-</span>csi<span class="token punctuation">-</span>driver</span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> efs<span class="token punctuation">-</span>csi<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>sa</span>
<span class="line">    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system</span>
<span class="line">    <span class="token key atrule">annotations</span><span class="token punctuation">:</span> </span>
<span class="line">    <span class="token key atrule">eks.amazonaws.com/role-arn</span><span class="token punctuation">:</span> arn<span class="token punctuation">:</span>aws<span class="token punctuation">:</span>iam<span class="token punctuation">:</span><span class="token punctuation">:</span>111122223333<span class="token punctuation">:</span>role/AmazonEKS\\_EFS\\_CSI\\_DriverRole</span>
<span class="line">kubectl apply <span class="token punctuation">-</span>f efs<span class="token punctuation">-</span>service<span class="token punctuation">-</span>account.yaml</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-amazon-efs-드라이버-설치" tabindex="-1"><a class="header-anchor" href="#_2-amazon-efs-드라이버-설치"><span>2. Amazon EFS 드라이버 설치</span></a></h2><h3 id="_2-1-helm-리포지토리를-추가" tabindex="-1"><a class="header-anchor" href="#_2-1-helm-리포지토리를-추가"><span>2.1 Helm 리포지토리를 추가</span></a></h3><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">helm repo <span class="token function">add</span> aws-efs-csi-driver https://kubernetes-sigs.github.io/aws-efs-csi-driver/</span>
<span class="line"></span></code></pre></div><h3 id="_2-2-리포지토리를-업데이트" tabindex="-1"><a class="header-anchor" href="#_2-2-리포지토리를-업데이트"><span>2.2 리포지토리를 업데이트</span></a></h3><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">helm repo update</span>
<span class="line"></span></code></pre></div><h3 id="_2-3-helm-차트를-사용하여-드라이버-릴리스를-설치" tabindex="-1"><a class="header-anchor" href="#_2-3-helm-차트를-사용하여-드라이버-릴리스를-설치"><span>2.3 Helm 차트를 사용하여 드라이버 릴리스를 설치</span></a></h3><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">helm upgrade <span class="token parameter variable">-i</span> aws-efs-csi-driver aws-efs-csi-driver/aws-efs-csi-driver <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">--namespace</span> kube-system <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">--set</span> <span class="token assign-left variable">image.repository</span><span class="token operator">=</span><span class="token number">602401143452</span>.dkr.ecr.region-code.amazonaws.com/eks/aws-efs-csi-driver <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">--set</span> <span class="token assign-left variable">controller.serviceAccount.create</span><span class="token operator">=</span>false <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">--set</span> <span class="token assign-left variable">controller.serviceAccount.name</span><span class="token operator">=</span>efs-csi-controller-sa</span>
<span class="line"></span></code></pre></div><h3 id="_2-4-efs-생성" tabindex="-1"><a class="header-anchor" href="#_2-4-efs-생성"><span>2.4 EFS 생성</span></a></h3><figure><img src="`+t+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_2-4-efs-sg-생성-후-설정" tabindex="-1"><a class="header-anchor" href="#_2-4-efs-sg-생성-후-설정"><span>2.4 EFS SG 생성 후 설정</span></a></h3><figure><img src="'+l+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_2-5-storageclass-yaml로-배포" tabindex="-1"><a class="header-anchor" href="#_2-5-storageclass-yaml로-배포"><span>2.5 storageclass.yaml로 배포</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="sc.yaml"><pre class="language-yaml"><code><span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass</span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> efs<span class="token punctuation">-</span>sc</span>
<span class="line"><span class="token key atrule">provisioner</span><span class="token punctuation">:</span> efs.csi.aws.com</span>
<span class="line"><span class="token key atrule">reclaimPolicy</span><span class="token punctuation">:</span> Retain</span>
<span class="line"><span class="token key atrule">parameters</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">provisioningMode</span><span class="token punctuation">:</span> efs<span class="token punctuation">-</span>ap</span>
<span class="line">    <span class="token key atrule">fileSystemId</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>생성한 EFS ID 기입<span class="token punctuation">}</span></span>
<span class="line">    <span class="token key atrule">directoryPerms</span><span class="token punctuation">:</span> <span class="token string">&quot;700&quot;</span></span>
<span class="line">    <span class="token key atrule">gidRangeStart</span><span class="token punctuation">:</span> <span class="token string">&quot;1000&quot;</span></span>
<span class="line">    <span class="token key atrule">gidRangeEnd</span><span class="token punctuation">:</span> <span class="token string">&quot;2000&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">kubectl apply sc.yaml</span>
<span class="line"></span></code></pre></div><h2 id="_3-helm으로-vault-sidecar를-활용한-logrotate-yaml-파일-준비" tabindex="-1"><a class="header-anchor" href="#_3-helm으로-vault-sidecar를-활용한-logrotate-yaml-파일-준비"><span>3. helm으로 Vault sidecar를 활용한 logrotate yaml 파일 준비</span></a></h2><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="cm-logrotate.yaml"><pre class="language-yaml"><code><span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> logrotate<span class="token punctuation">-</span>config</span>
<span class="line"><span class="token key atrule">data</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">logrotate.conf</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">    </span>
<span class="line">     /vault/audit/*.txt {       </span>
<span class="line">     missingok              </span>
<span class="line">     compress               </span>
<span class="line">     maxsize 1M             </span>
<span class="line">     crate                  </span>
<span class="line">     dateext                </span>
<span class="line">     dateformat -%Y-%m-%d_%H</span>
<span class="line">     postrotate             </span>
<span class="line">         pkill -HUP vault   </span>
<span class="line">     endscript              </span></span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-1-vault-helm으로-배포" tabindex="-1"><a class="header-anchor" href="#_3-1-vault-helm으로-배포"><span>3.1 vault helm으로 배포</span></a></h3><h4 id="_3-1-1-license-secret-생성" tabindex="-1"><a class="header-anchor" href="#_3-1-1-license-secret-생성"><span>3.1.1 license secret 생성</span></a></h4><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line"><span class="token function">touch</span> vault.hclic <span class="token comment"># vault 라이센스 내용 첨부</span></span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">vaultsecret</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> vault.hclic<span class="token variable">)</span></span></span>
<span class="line"></span>
<span class="line">kubectl create secret generic vault-ent-license --from-literal<span class="token operator">=</span><span class="token string">&quot;license=<span class="token variable">\${vaultsecret}</span>&quot;</span></span>
<span class="line"></span></code></pre></div><h4 id="_3-1-2-eks-자격증명-secret-생성" tabindex="-1"><a class="header-anchor" href="#_3-1-2-eks-자격증명-secret-생성"><span>3.1.2 eks 자격증명 secret 생성</span></a></h4><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">kubectl create secret generic eks-creds <span class="token punctuation">\\</span></span>
<span class="line">  --from-literal<span class="token operator">=</span>AWS_ACCESS_KEY_ID<span class="token operator">=</span><span class="token string">&quot;[AWS_ACCESS_KEY_ID]&quot;</span> <span class="token punctuation">\\</span></span>
<span class="line">  --from-literal<span class="token operator">=</span>AWS_SECRET_ACCESS_KEY<span class="token operator">=</span><span class="token string">&quot;[AWS_SECRET_ACCESS_KEY]&quot;</span></span>
<span class="line"></span></code></pre></div><h4 id="_3-1-3-vault-helm-values-yaml-배포" tabindex="-1"><a class="header-anchor" href="#_3-1-3-vault-helm-values-yaml-배포"><span>3.1.3 vault helm values.yaml 배포</span></a></h4><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="values.yaml"><pre class="language-yaml"><code><span class="line"><span class="token key atrule">server</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token comment"># HUP signal for logrotate</span></span>
<span class="line">  <span class="token key atrule">shareProcessNamespace</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">  <span class="token comment"># Add the lograte config from a config map</span></span>
<span class="line">  <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logrotate<span class="token punctuation">-</span>config</span>
<span class="line">      <span class="token key atrule">configMap</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">name</span><span class="token punctuation">:</span> logrotate<span class="token punctuation">-</span>config</span>
<span class="line">  <span class="token comment"># And finally the container</span></span>
<span class="line">  <span class="token key atrule">extraContainers</span><span class="token punctuation">:</span></span>
<span class="line">   <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> auditlog<span class="token punctuation">-</span>rotator</span>
<span class="line">     <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>aws account ID<span class="token punctuation">]</span>.dkr.ecr.ap<span class="token punctuation">-</span>northeast<span class="token punctuation">-</span>2.amazonaws.com/hasicorp<span class="token punctuation">-</span>repo<span class="token punctuation">:</span>logrotate </span>
<span class="line">     <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always</span>
<span class="line">     <span class="token key atrule">env</span><span class="token punctuation">:</span></span>
<span class="line">       <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CRONTAB</span>
<span class="line">         <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;*/3 * * * *&quot;</span></span>
<span class="line">     <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></span>
<span class="line">     <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/logrotate.conf</span>
<span class="line">       <span class="token key atrule">name</span><span class="token punctuation">:</span> logrotate<span class="token punctuation">-</span>config</span>
<span class="line">       <span class="token key atrule">subPath</span><span class="token punctuation">:</span> logrotate.conf</span>
<span class="line">       <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">     <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /vault/audit</span>
<span class="line">       <span class="token key atrule">name</span><span class="token punctuation">:</span> audit</span>
<span class="line">  <span class="token key atrule">enterpriseLicense</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">secretName</span><span class="token punctuation">:</span> vault<span class="token punctuation">-</span>ent<span class="token punctuation">-</span>license</span>
<span class="line">  <span class="token key atrule">ha</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">raft</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">      <span class="token key atrule">config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">        ui = true</span></span>
<span class="line"></span>
<span class="line">        listener &quot;tcp&quot; <span class="token punctuation">{</span></span>
<span class="line">          tls_disable = 1</span>
<span class="line">          address = &quot;<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>8200&quot;</span>
<span class="line">          cluster_address = &quot;<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>8201&quot;</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        seal &quot;awskms&quot; <span class="token punctuation">{</span></span>
<span class="line">           region     = &quot;ap<span class="token punctuation">-</span>northeast<span class="token punctuation">-</span>2&quot;</span>
<span class="line">           kms_key_id = &quot;<span class="token punctuation">[</span>kms_key_id<span class="token punctuation">]</span>&quot;</span>
<span class="line">         <span class="token punctuation">}</span></span>
<span class="line">        storage &quot;raft&quot; <span class="token punctuation">{</span></span>
<span class="line">          path = &quot;/vault/data&quot;</span>
<span class="line">          retry_join <span class="token punctuation">{</span></span>
<span class="line">            leader_api_addr = &quot;https<span class="token punctuation">:</span>//vault<span class="token punctuation">-</span>0.vault<span class="token punctuation">-</span>internal<span class="token punctuation">:</span>8200&quot;</span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">          retry_join <span class="token punctuation">{</span></span>
<span class="line">            leader_api_addr = &quot;https<span class="token punctuation">:</span>//vault<span class="token punctuation">-</span>1.vault<span class="token punctuation">-</span>internal<span class="token punctuation">:</span>8200&quot;</span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">          retry_join <span class="token punctuation">{</span></span>
<span class="line">            leader_api_addr = &quot;https<span class="token punctuation">:</span>//vault<span class="token punctuation">-</span>2.vault<span class="token punctuation">-</span>internal<span class="token punctuation">:</span>8200&quot;</span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">         <span class="token punctuation">}</span></span>
<span class="line">        service_registration &quot;kubernetes&quot; <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">  <span class="token key atrule">image</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">repository</span><span class="token punctuation">:</span> hashicorp/vault<span class="token punctuation">-</span>enterprise</span>
<span class="line">    <span class="token key atrule">tag</span><span class="token punctuation">:</span> 1.12.1<span class="token punctuation">-</span>ent</span>
<span class="line">  <span class="token key atrule">extraSecretEnvironmentVars</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">envName</span><span class="token punctuation">:</span> AWS_ACCESS_KEY_ID</span>
<span class="line">      <span class="token key atrule">secretName</span><span class="token punctuation">:</span> eks<span class="token punctuation">-</span>creds</span>
<span class="line">      <span class="token key atrule">secretKey</span><span class="token punctuation">:</span> AWS_ACCESS_KEY_ID</span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">envName</span><span class="token punctuation">:</span> AWS_SECRET_ACCESS_KEY</span>
<span class="line">      <span class="token key atrule">secretName</span><span class="token punctuation">:</span> eks<span class="token punctuation">-</span>creds</span>
<span class="line">      <span class="token key atrule">secretKey</span><span class="token punctuation">:</span> AWS_SECRET_ACCESS_KEY</span>
<span class="line">  <span class="token key atrule">service</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">type</span><span class="token punctuation">:</span> LoadBalancer</span>
<span class="line">    <span class="token key atrule">loadBalancerClass</span><span class="token punctuation">:</span> service.k8s.aws/nlb</span>
<span class="line">    <span class="token key atrule">annotations</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">dataStorage</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">storageClass</span><span class="token punctuation">:</span> efs<span class="token punctuation">-</span>sc</span>
<span class="line">    <span class="token key atrule">size</span><span class="token punctuation">:</span> 100Gi</span>
<span class="line">  <span class="token key atrule">auditStorage</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> </span>
<span class="line">    <span class="token comment"># Size of the PVC created</span></span>
<span class="line">    <span class="token key atrule">size</span><span class="token punctuation">:</span> 100Gi</span>
<span class="line">    <span class="token comment"># Location where the PVC will be mounted.</span></span>
<span class="line">    <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/vault/audit&quot;</span></span>
<span class="line">    <span class="token comment"># Name of the storage class to use.  If null it will use the</span></span>
<span class="line">    <span class="token comment"># configured default Storage Class.</span></span>
<span class="line">    <span class="token key atrule">storageClass</span><span class="token punctuation">:</span> efs<span class="token punctuation">-</span>sc </span>
<span class="line">    <span class="token comment"># Access Mode of the storage device being used for the PVC</span></span>
<span class="line">    <span class="token key atrule">accessMode</span><span class="token punctuation">:</span> ReadWriteOnce</span>
<span class="line">    <span class="token comment"># Annotations to apply to the PVC</span></span>
<span class="line">    <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-1-3-helm-repo-등록-및-values-yaml-기반으로-vault-배포" tabindex="-1"><a class="header-anchor" href="#_3-1-3-helm-repo-등록-및-values-yaml-기반으로-vault-배포"><span>3.1.3 helm repo 등록 및 values.yaml 기반으로 vault 배포</span></a></h4><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">helm repo <span class="token function">add</span> hashicorp https://helm.releases.hashicorp.com</span>
<span class="line"></span>
<span class="line">helm repo list</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 설치</span></span>
<span class="line">helm <span class="token function">install</span> vault hashicorp/vault <span class="token parameter variable">-f</span> values.yaml</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 삭제</span></span>
<span class="line">helm uninstall vault hashicorp/vault <span class="token parameter variable">-f</span> values.yaml</span>
<span class="line"></span></code></pre></div><h4 id="_3-1-4-logrotate-적용-확인" tabindex="-1"><a class="header-anchor" href="#_3-1-4-logrotate-적용-확인"><span>3.1.4 logrotate 적용 확인</span></a></h4><figure><img src="`+p+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_3-1-5-auditlog-logrotate-설정-확인" tabindex="-1"><a class="header-anchor" href="#_3-1-5-auditlog-logrotate-설정-확인"><span>3.1.5 auditlog-logrotate 설정 확인</span></a></h4><figure><img src="'+i+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>1M가 넘어가면 새로 생성 된 파일들은 압축파일로 변환 설정</li></ul><figure><img src="'+c+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><hr><p>create by <a href="mailto:rlarlqja1001@gmail.com" target="_blank" rel="noopener noreferrer">rlarlqja1001@gmail.com</a></p>',52),r=[u];function d(k,v){return a(),n("div",null,r)}const g=s(o,[["render",d],["__file","vault-sidecat-logrotate.html.vue"]]),b=JSON.parse('{"path":"/04-HashiCorp/06-Vault/06-Config/vault-sidecat-logrotate.html","title":"EKS Vault sidecar를 활용한 logrotate 설정","lang":"ko-KR","frontmatter":{"description":"vault container logrotate","tag":["kubernetes","vault","logrotate"],"author":"gbkim","head":[["meta",{"property":"og:url","content":"https://docmoa.github.io/04-HashiCorp/06-Vault/06-Config/vault-sidecat-logrotate.html"}],["meta",{"property":"og:site_name","content":"docmoa"}],["meta",{"property":"og:title","content":"EKS Vault sidecar를 활용한 logrotate 설정"}],["meta",{"property":"og:description","content":"vault container logrotate"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"ko-KR"}],["meta",{"property":"og:updated_time","content":"2024-07-15T23:47:31.000Z"}],["meta",{"property":"article:author","content":"gbkim"}],["meta",{"property":"article:tag","content":"kubernetes"}],["meta",{"property":"article:tag","content":"vault"}],["meta",{"property":"article:tag","content":"logrotate"}],["meta",{"property":"article:modified_time","content":"2024-07-15T23:47:31.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"EKS Vault sidecar를 활용한 logrotate 설정\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2024-07-15T23:47:31.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"gbkim\\"}]}"]]},"headers":[{"level":2,"title":"1. EFS CSI Driver 설치","slug":"_1-efs-csi-driver-설치","link":"#_1-efs-csi-driver-설치","children":[{"level":3,"title":"1.1 IAM 정책을 만들 json 파일 가져오기 iam-policy-example.json","slug":"_1-1-iam-정책을-만들-json-파일-가져오기-iam-policy-example-json","link":"#_1-1-iam-정책을-만들-json-파일-가져오기-iam-policy-example-json","children":[]},{"level":3,"title":"1.2 IAM 정책","slug":"_1-2-iam-정책","link":"#_1-2-iam-정책","children":[]},{"level":3,"title":"1.3 클러스터의 OIDC 공급자 URL","slug":"_1-3-클러스터의-oidc-공급자-url","link":"#_1-3-클러스터의-oidc-공급자-url","children":[]},{"level":3,"title":"1.4 trust-policy","slug":"_1-4-trust-policy","link":"#_1-4-trust-policy","children":[]},{"level":3,"title":"1.4 역할 생성","slug":"_1-4-역할-생성","link":"#_1-4-역할-생성","children":[]},{"level":3,"title":"1.5 IAM 정책을 역할에 연결","slug":"_1-5-iam-정책을-역할에-연결","link":"#_1-5-iam-정책을-역할에-연결","children":[]},{"level":3,"title":"1.6 생성한 IAM 역할의 ARN이 추가된 Kubernetes SA을 생성","slug":"_1-6-생성한-iam-역할의-arn이-추가된-kubernetes-sa을-생성","link":"#_1-6-생성한-iam-역할의-arn이-추가된-kubernetes-sa을-생성","children":[]}]},{"level":2,"title":"2. Amazon EFS 드라이버 설치","slug":"_2-amazon-efs-드라이버-설치","link":"#_2-amazon-efs-드라이버-설치","children":[{"level":3,"title":"2.1 Helm 리포지토리를 추가","slug":"_2-1-helm-리포지토리를-추가","link":"#_2-1-helm-리포지토리를-추가","children":[]},{"level":3,"title":"2.2 리포지토리를 업데이트","slug":"_2-2-리포지토리를-업데이트","link":"#_2-2-리포지토리를-업데이트","children":[]},{"level":3,"title":"2.3 Helm 차트를 사용하여 드라이버 릴리스를 설치","slug":"_2-3-helm-차트를-사용하여-드라이버-릴리스를-설치","link":"#_2-3-helm-차트를-사용하여-드라이버-릴리스를-설치","children":[]},{"level":3,"title":"2.4 EFS 생성","slug":"_2-4-efs-생성","link":"#_2-4-efs-생성","children":[]},{"level":3,"title":"2.4 EFS SG 생성 후 설정","slug":"_2-4-efs-sg-생성-후-설정","link":"#_2-4-efs-sg-생성-후-설정","children":[]},{"level":3,"title":"2.5 storageclass.yaml로 배포","slug":"_2-5-storageclass-yaml로-배포","link":"#_2-5-storageclass-yaml로-배포","children":[]}]},{"level":2,"title":"3. helm으로 Vault sidecar를 활용한 logrotate yaml 파일 준비","slug":"_3-helm으로-vault-sidecar를-활용한-logrotate-yaml-파일-준비","link":"#_3-helm으로-vault-sidecar를-활용한-logrotate-yaml-파일-준비","children":[{"level":3,"title":"3.1 vault helm으로 배포","slug":"_3-1-vault-helm으로-배포","link":"#_3-1-vault-helm으로-배포","children":[]}]}],"git":{"createdTime":1721022299000,"updatedTime":1721087251000,"contributors":[{"name":"Great-Stone","email":"hahohh@gmail.com","commits":1},{"name":"ung","email":"ung@mz.co.kr","commits":1}]},"readingTime":{"minutes":11.88,"words":713},"filePathRelative":"04-HashiCorp/06-Vault/06-Config/vault-sidecat-logrotate.md","localizedDate":"2024년 7월 15일","excerpt":"\\n<blockquote>\\n<ul>\\n<li><a href=\\"#eksvaultsidecar%EB%A5%BC%ED%99%9C%EC%9A%A9%ED%95%9Clogrotate%EC%84%A4%EC%A0%95-%EC%B0%B8%EA%B3%A0:https://github.com/hansemerkur/vault-logrotate\\">참고: https://github.com/HanseMerkur/vault-logrotate</a></li>\\n<li><a href=\\"#eksvaultsidecar%EB%A5%BC%ED%99%9C%EC%9A%A9%ED%95%9Clogrotate%EC%84%A4%EC%A0%95-%EC%B0%B8%EA%B3%A0:%EB%B2%84%EC%A0%84%ED%99%95%EC%9D%B8\\">참고: 버전 확인</a></li>\\n</ul>\\n</blockquote>","copyright":{"author":"gbkim"}}');export{g as comp,b as data};
