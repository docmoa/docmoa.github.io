import{_ as a}from"./plugin-vue_export-helper-DlAUqK2U.js";import{o as s,c as n,h as e}from"./app-DVMlqOhY.js";const t="/assets/vault-login-mfa-totp-D5npPJCP.gif",l={},p=e(`<h1 id="mfa-login-with-vault-totp" tabindex="-1"><a class="header-anchor" href="#mfa-login-with-vault-totp"><span>MFA Login with Vault TOTP</span></a></h1><blockquote><p>HashiCorp Learn - Login MFA : <a href="https://learn.hashicorp.com/tutorials/vault/multi-factor-authentication" target="_blank" rel="noopener noreferrer">https://learn.hashicorp.com/tutorials/vault/multi-factor-authentication</a><br> Configure TOTP MFA Method : <a href="https://www.vaultproject.io/api-docs/secret/identity/mfa/totp" target="_blank" rel="noopener noreferrer">https://www.vaultproject.io/api-docs/secret/identity/mfa/totp</a><br> Vault Login MFA Overview : <a href="https://www.vaultproject.io/docs/auth/login-mfa" target="_blank" rel="noopener noreferrer">https://www.vaultproject.io/docs/auth/login-mfa</a><br> 1.10.3+ recommend : <a href="https://discuss.hashicorp.com/t/vault-1-10-3-released/39394" target="_blank" rel="noopener noreferrer">https://discuss.hashicorp.com/t/vault-1-10-3-released/39394</a></p></blockquote><h2 id="env-setup" tabindex="-1"><a class="header-anchor" href="#env-setup"><span>ENV Setup</span></a></h2><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ <span class="token assign-left variable">ROOT_TOKEN</span><span class="token operator">=</span>hvs<span class="token punctuation">..</span>.</span>
<span class="line">$ <span class="token assign-left variable">VAULT_ADDR</span><span class="token operator">=</span>https://<span class="token operator">&lt;</span>your-vault-addr<span class="token operator">&gt;</span>:8200</span>
<span class="line">$ <span class="token assign-left variable">MY_PASSWORD</span><span class="token operator">=</span>password</span>
<span class="line"></span>
<span class="line"><span class="token comment"># If you have NAMESPACE with Enterprise</span></span>
<span class="line">$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">VAULT_NAMESPACE</span><span class="token operator">=</span>admin</span>
<span class="line"></span></code></pre></div><h2 id="enable-username-and-password-auth-method" tabindex="-1"><a class="header-anchor" href="#enable-username-and-password-auth-method"><span>Enable username and password auth method</span></a></h2><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ <span class="token assign-left variable">VAULT_TOKEN</span><span class="token operator">=</span><span class="token variable">$ROOT_TOKEN</span> vault auth <span class="token builtin class-name">enable</span> userpass</span>
<span class="line"></span>
<span class="line">$ <span class="token assign-left variable">USERPASS_ACCESSOR</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token assign-left variable">VAULT_TOKEN</span><span class="token operator">=</span>$ROOT_TOKEN vault auth list <span class="token operator">|</span> <span class="token function">grep</span> userpass <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">&#39;{print $3}&#39;</span><span class="token variable">)</span></span></span>
<span class="line"></span>
<span class="line">$ <span class="token assign-left variable">VAULT_TOKEN</span><span class="token operator">=</span><span class="token variable">$ROOT_TOKEN</span> vault <span class="token function">write</span> auth/userpass/users/admin <span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token variable">$MY_PASSWORD</span></span>
<span class="line"></span></code></pre></div><h2 id="create-an-entity-and-alias" tabindex="-1"><a class="header-anchor" href="#create-an-entity-and-alias"><span>Create an entity and alias</span></a></h2><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ <span class="token assign-left variable">ENTITY_ID</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token assign-left variable">VAULT_TOKEN</span><span class="token operator">=</span>$ROOT_TOKEN vault <span class="token function">write</span> <span class="token parameter variable">-field</span><span class="token operator">=</span>id identity/entity <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">&quot;admin&quot;</span><span class="token variable">)</span></span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token variable">$ENTITY_ID</span></span>
<span class="line"></span>
<span class="line">$ <span class="token assign-left variable">VAULT_TOKEN</span><span class="token operator">=</span><span class="token variable">$ROOT_TOKEN</span> vault <span class="token function">write</span> identity/entity-alias <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">&quot;admin&quot;</span> <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token assign-left variable">canonical_id</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$ENTITY_ID</span>&quot;</span> <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token assign-left variable">mount_accessor</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$USERPASS_ACCESSOR</span>&quot;</span></span>
<span class="line"></span></code></pre></div><h2 id="enable-mfa-method-totp" tabindex="-1"><a class="header-anchor" href="#enable-mfa-method-totp"><span>Enable MFA method (TOTP)</span></a></h2><blockquote><p><a href="https://www.vaultproject.io/api-docs/secret/identity/mfa/totp#parameters" target="_blank" rel="noopener noreferrer">https://www.vaultproject.io/api-docs/secret/identity/mfa/totp#parameters</a></p></blockquote><ul><li>identity/mfa/method/totp/generate : for current entity</li><li>identity/mfa/method/totp/admin-generate : manage to other entity</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ <span class="token assign-left variable">METHOD_ID</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>vault <span class="token function">write</span> <span class="token parameter variable">-field</span><span class="token operator">=</span>method_id identity/mfa/method/totp <span class="token assign-left variable">issuer</span><span class="token operator">=</span>HCP-Vault <span class="token assign-left variable">period</span><span class="token operator">=</span><span class="token number">30</span> <span class="token assign-left variable">key_size</span><span class="token operator">=</span><span class="token number">30</span> <span class="token assign-left variable">qr_size</span><span class="token operator">=</span><span class="token number">200</span> <span class="token assign-left variable">algorithm</span><span class="token operator">=</span>SHA256 <span class="token assign-left variable">digits</span><span class="token operator">=</span><span class="token number">6</span> <span class="token assign-left variable">name</span><span class="token operator">=</span>admin<span class="token variable">)</span></span></span>
<span class="line"></span>
<span class="line">$ <span class="token builtin class-name">echo</span> <span class="token variable">$METHOD_ID</span></span>
<span class="line"></span>
<span class="line">$ vault <span class="token builtin class-name">read</span> identity/mfa/method/totp/<span class="token variable">$METHOD_ID</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># vault write identity/mfa/method/totp/generate method_id=$METHOD_ID</span></span>
<span class="line">$ vault <span class="token function">write</span> identity/mfa/method/totp/admin-generate <span class="token assign-left variable">method_id</span><span class="token operator">=</span><span class="token variable">$METHOD_ID</span> <span class="token assign-left variable">entity_id</span><span class="token operator">=</span><span class="token variable">$ENTITY_ID</span></span>
<span class="line"></span>
<span class="line">Key        Value</span>
<span class="line">---        -----</span>
<span class="line">barcode    iVBORw0KGgoAAAANSUhEUgAAAM<span class="token punctuation">..</span>.</span>
<span class="line">url        otpauth://totp/Vault:307d6c16-6f5c<span class="token punctuation">..</span>.</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="create-login-enforcement" tabindex="-1"><a class="header-anchor" href="#create-login-enforcement"><span>Create login enforcement</span></a></h2><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ <span class="token assign-left variable">VAULT_TOKEN</span><span class="token operator">=</span><span class="token variable">$ROOT_TOKEN</span> vault <span class="token function">write</span> identity/mfa/login-enforcement/mylogin <span class="token punctuation">\\</span></span>
<span class="line">   <span class="token assign-left variable">mfa_method_ids</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$METHOD_ID</span>&quot;</span> <span class="token punctuation">\\</span></span>
<span class="line">   <span class="token assign-left variable">auth_method_accessors</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$USERPASS_ACCESSOR</span>&quot;</span></span>
<span class="line"></span></code></pre></div><h2 id="vault-otp-test-option" tabindex="-1"><a class="header-anchor" href="#vault-otp-test-option"><span>Vault OTP Test (Option)</span></a></h2><blockquote><p>That&#39;s able to use online QR generator</p></blockquote><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ vault secrets <span class="token builtin class-name">enable</span> totp</span>
<span class="line"></span>
<span class="line">$ vault <span class="token function">write</span> totp/keys/hcp-vault <span class="token assign-left variable">url</span><span class="token operator">=</span><span class="token string">&quot;otpauth://totp/HCP-Vault:0d0cf6f5-62e6-6914-5070-47e997e2aa...&quot;</span></span>
<span class="line"></span>
<span class="line">$ vault <span class="token builtin class-name">read</span> totp/code/hcp-vault</span>
<span class="line">Key     Value</span>
<span class="line">---     -----</span>
<span class="line">code    <span class="token number">714908</span></span>
<span class="line"></span></code></pre></div><h2 id="vault-login-userpass-totp" tabindex="-1"><a class="header-anchor" href="#vault-login-userpass-totp"><span>Vault Login Userpass + totp</span></a></h2><h3 id="cli" tabindex="-1"><a class="header-anchor" href="#cli"><span>CLI</span></a></h3><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ vault login <span class="token parameter variable">-method</span> userpass <span class="token assign-left variable">username</span><span class="token operator">=</span>admin <span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token variable">$MY_PASSWORD</span></span>
<span class="line"></span>
<span class="line">Enter the passphrase <span class="token keyword">for</span> methodID <span class="token string">&quot;0b9d2229-5d64-dc5d-87cc-0fd22775b918&quot;</span> of</span>
<span class="line"><span class="token builtin class-name">type</span> <span class="token string">&quot;totp&quot;</span><span class="token builtin class-name">:</span> <span class="token operator">&lt;</span>enter_totp<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre></div><h3 id="ui" tabindex="-1"><a class="header-anchor" href="#ui"><span>UI</span></a></h3><figure><img src="`+t+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>',22),o=[p];function i(r,c){return s(),n("div",null,o)}const h=a(l,[["render",i],["__file","mfa-login.html.vue"]]),m=JSON.parse('{"path":"/04-HashiCorp/06-Vault/03-Auth_Method/mfa-login.html","title":"MFA Login with Vault TOTP","lang":"ko-KR","frontmatter":{"description":"Vault Login에 Vault TOTP 기반 MFA 추가","tag":["vault auth","MFA"],"head":[["meta",{"property":"og:url","content":"https://docmoa.github.io/04-HashiCorp/06-Vault/03-Auth_Method/mfa-login.html"}],["meta",{"property":"og:site_name","content":"docmoa"}],["meta",{"property":"og:title","content":"MFA Login with Vault TOTP"}],["meta",{"property":"og:description","content":"Vault Login에 Vault TOTP 기반 MFA 추가"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"ko-KR"}],["meta",{"property":"og:updated_time","content":"2023-09-18T13:12:54.000Z"}],["meta",{"property":"article:tag","content":"vault auth"}],["meta",{"property":"article:tag","content":"MFA"}],["meta",{"property":"article:modified_time","content":"2023-09-18T13:12:54.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"MFA Login with Vault TOTP\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2023-09-18T13:12:54.000Z\\",\\"author\\":[]}"]]},"headers":[{"level":2,"title":"ENV Setup","slug":"env-setup","link":"#env-setup","children":[]},{"level":2,"title":"Enable username and password auth method","slug":"enable-username-and-password-auth-method","link":"#enable-username-and-password-auth-method","children":[]},{"level":2,"title":"Create an entity and alias","slug":"create-an-entity-and-alias","link":"#create-an-entity-and-alias","children":[]},{"level":2,"title":"Enable MFA method (TOTP)","slug":"enable-mfa-method-totp","link":"#enable-mfa-method-totp","children":[]},{"level":2,"title":"Create login enforcement","slug":"create-login-enforcement","link":"#create-login-enforcement","children":[]},{"level":2,"title":"Vault OTP Test (Option)","slug":"vault-otp-test-option","link":"#vault-otp-test-option","children":[]},{"level":2,"title":"Vault Login Userpass + totp","slug":"vault-login-userpass-totp","link":"#vault-login-userpass-totp","children":[{"level":3,"title":"CLI","slug":"cli","link":"#cli","children":[]},{"level":3,"title":"UI","slug":"ui","link":"#ui","children":[]}]}],"git":{"createdTime":1651826418000,"updatedTime":1695042774000,"contributors":[{"name":"Administrator","email":"admin@example.com","commits":5},{"name":"Great-Stone","email":"hahohh@gmail.com","commits":1}]},"readingTime":{"minutes":4.7,"words":282},"filePathRelative":"04-HashiCorp/06-Vault/03-Auth_Method/mfa-login.md","localizedDate":"2022년 5월 6일","excerpt":"\\n<blockquote>\\n<p>HashiCorp Learn - Login MFA : <a href=\\"https://learn.hashicorp.com/tutorials/vault/multi-factor-authentication\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">https://learn.hashicorp.com/tutorials/vault/multi-factor-authentication</a><br>\\nConfigure TOTP MFA Method : <a href=\\"https://www.vaultproject.io/api-docs/secret/identity/mfa/totp\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">https://www.vaultproject.io/api-docs/secret/identity/mfa/totp</a><br>\\nVault Login MFA Overview : <a href=\\"https://www.vaultproject.io/docs/auth/login-mfa\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">https://www.vaultproject.io/docs/auth/login-mfa</a><br>\\n1.10.3+ recommend : <a href=\\"https://discuss.hashicorp.com/t/vault-1-10-3-released/39394\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">https://discuss.hashicorp.com/t/vault-1-10-3-released/39394</a></p>\\n</blockquote>"}');export{h as comp,m as data};
