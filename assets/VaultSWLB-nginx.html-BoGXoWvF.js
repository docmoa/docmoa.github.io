import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{o as s,c as a,h as p}from"./app-DVMlqOhY.js";const e={},l=p(`<h1 id="vault-swlb용도의-nginx" tabindex="-1"><a class="header-anchor" href="#vault-swlb용도의-nginx"><span>Vault SWLB용도의 nginx</span></a></h1><ul><li>Vault의 HA구성 시에는 LB가 필요한데, LB대용으로 SWLB를 이용하여 Vault를 사용할 수 있다. <ul><li>해당 페이지에서는 nginx를 사용하였지만, HAproxy도 비슷하게 사용이 가능하다.</li></ul></li></ul><h1 id="nginx-job-파일" tabindex="-1"><a class="header-anchor" href="#nginx-job-파일"><span>nginx job 파일</span></a></h1><div class="language-hcl line-numbers-mode" data-highlighter="prismjs" data-ext="hcl" data-title="hcl"><pre class="language-hcl"><code><span class="line">job <span class="token string">&quot;nginx&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">datacenters</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;dc1&quot;</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line">  group <span class="token string">&quot;nginx&quot;</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">constraint</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">attribute</span> <span class="token punctuation">=</span> <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">$</span><span class="token punctuation">{</span>attr<span class="token punctuation">.</span>unique<span class="token punctuation">.</span>hostname<span class="token punctuation">}</span></span>&quot;</span></span>
<span class="line">      <span class="token property">value</span>     <span class="token punctuation">=</span> <span class="token string">&quot;slave0&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">#Vault tls가 있고 nomad client hcl 파일에 host volume이 명시되어 있는 설정 값</span></span>
<span class="line">    volume <span class="token string">&quot;cert-data&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">type</span>      <span class="token punctuation">=</span> <span class="token string">&quot;host&quot;</span></span>
<span class="line">      <span class="token property">source</span>    <span class="token punctuation">=</span> <span class="token string">&quot;cert-data&quot;</span></span>
<span class="line">      <span class="token property">read_only</span> <span class="token punctuation">=</span> <span class="token boolean">false</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">#실패 없이 되라고 행운의 숫자인 7을 4번 줌</span></span>
<span class="line">    <span class="token keyword">network</span> <span class="token punctuation">{</span></span>
<span class="line">      port <span class="token string">&quot;http&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">to</span>     <span class="token punctuation">=</span> <span class="token number">7777</span></span>
<span class="line">        <span class="token property">static</span> <span class="token punctuation">=</span> <span class="token number">7777</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">service</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">name</span> <span class="token punctuation">=</span> <span class="token string">&quot;nginx&quot;</span></span>
<span class="line">      <span class="token property">port</span> <span class="token punctuation">=</span> <span class="token string">&quot;http&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    task <span class="token string">&quot;nginx&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">driver</span> <span class="token punctuation">=</span> <span class="token string">&quot;docker&quot;</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">volume_mount</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">volume</span>      <span class="token punctuation">=</span> <span class="token string">&quot;cert-data&quot;</span></span>
<span class="line">        <span class="token property">destination</span> <span class="token punctuation">=</span> <span class="token string">&quot;/usr/local/cert&quot;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">config</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">image</span> <span class="token punctuation">=</span> <span class="token string">&quot;nginx&quot;</span></span>
<span class="line"></span>
<span class="line">        <span class="token property">ports</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token property">volumes</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span></span>
<span class="line">          <span class="token string">&quot;local:/etc/nginx/conf.d&quot;</span>,</span>
<span class="line"></span>
<span class="line">        <span class="token punctuation">]</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      <span class="token keyword">template</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">data</span> <span class="token punctuation">=</span> <span class="token heredoc string">&lt;&lt;EOF        </span>
<span class="line">#Vault는 active서버 1대외에는 전부 standby상태이며 </span>
<span class="line">#서비스 호출 시(write)에는 active 서비스만 호출해야함으로 아래와 같이 consul에서 서비스를 불러옴</span>
<span class="line"></span>
<span class="line">upstream backend {</span>
<span class="line">{{ range service &quot;active.vault&quot; }}</span>
<span class="line">  server {{ .Address }}:{{ .Port }};</span>
<span class="line">{{ else }}server 127.0.0.1:65535; # force a 502</span>
<span class="line">{{ end }}</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">server {</span>
<span class="line">   listen 7777 ssl;</span>
<span class="line">   #위에서 nomad host volume을 mount한 cert를 가져옴</span>
<span class="line">   ssl on;</span>
<span class="line">   ssl_certificate /usr/local/cert/vault/global-client-vault-0.pem;</span>
<span class="line">   ssl_certificate_key /usr/local/cert/vault/global-client-vault-0-key.pem;</span>
<span class="line">   #vault ui 접근 시 / -&gt; /ui redirect되기 때문에 location이 /외에는 되지 않는다.</span>
<span class="line">   location / {</span>
<span class="line">      proxy_pass https://backend;</span>
<span class="line">   }</span>
<span class="line">}</span>
<span class="line">EOF</span></span>
<span class="line"></span>
<span class="line">        <span class="token property">destination</span>   <span class="token punctuation">=</span> <span class="token string">&quot;local/load-balancer.conf&quot;</span></span>
<span class="line">        <span class="token property">change_mode</span>   <span class="token punctuation">=</span> <span class="token string">&quot;signal&quot;</span></span>
<span class="line">        <span class="token property">change_signal</span> <span class="token punctuation">=</span> <span class="token string">&quot;SIGHUP&quot;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      <span class="token keyword">resources</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">cpu</span> <span class="token punctuation">=</span> <span class="token number">100</span></span>
<span class="line">        <span class="token property">memory</span> <span class="token punctuation">=</span> <span class="token number">201</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,4),t=[l];function c(i,o){return s(),a("div",null,t)}const d=n(e,[["render",c],["__file","VaultSWLB-nginx.html.vue"]]),k=JSON.parse('{"path":"/04-HashiCorp/07-Nomad/05-SampleJob/VaultSWLB-nginx.html","title":"Vault SWLB용도의 nginx","lang":"ko-KR","frontmatter":{"description":"Nomad Sample","tag":["Nomad","Sample","Job","Vault","SWLB"],"head":[["meta",{"property":"og:url","content":"https://docmoa.github.io/04-HashiCorp/07-Nomad/05-SampleJob/VaultSWLB-nginx.html"}],["meta",{"property":"og:site_name","content":"docmoa"}],["meta",{"property":"og:title","content":"Vault SWLB용도의 nginx"}],["meta",{"property":"og:description","content":"Nomad Sample"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"ko-KR"}],["meta",{"property":"og:updated_time","content":"2023-09-18T13:12:54.000Z"}],["meta",{"property":"article:tag","content":"Nomad"}],["meta",{"property":"article:tag","content":"Sample"}],["meta",{"property":"article:tag","content":"Job"}],["meta",{"property":"article:tag","content":"Vault"}],["meta",{"property":"article:tag","content":"SWLB"}],["meta",{"property":"article:modified_time","content":"2023-09-18T13:12:54.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Vault SWLB용도의 nginx\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2023-09-18T13:12:54.000Z\\",\\"author\\":[]}"]]},"headers":[],"git":{"createdTime":1645433790000,"updatedTime":1695042774000,"contributors":[{"name":"ung","email":"swbs90@naver.com","commits":3},{"name":"Great-Stone","email":"hahohh@gmail.com","commits":1}]},"readingTime":{"minutes":2.65,"words":159},"filePathRelative":"04-HashiCorp/07-Nomad/05-SampleJob/VaultSWLB-nginx.md","localizedDate":"2022년 2월 21일","excerpt":"\\n<ul>\\n<li>Vault의 HA구성 시에는 LB가 필요한데, LB대용으로 SWLB를 이용하여 Vault를 사용할 수 있다.\\n<ul>\\n<li>해당 페이지에서는 nginx를 사용하였지만, HAproxy도 비슷하게 사용이 가능하다.</li>\\n</ul>\\n</li>\\n</ul>\\n<h1>nginx job 파일</h1>\\n<div class=\\"language-hcl\\" data-highlighter=\\"prismjs\\" data-ext=\\"hcl\\" data-title=\\"hcl\\"><pre class=\\"language-hcl\\"><code><span class=\\"line\\">job <span class=\\"token string\\">\\"nginx\\"</span> <span class=\\"token punctuation\\">{</span></span>\\n<span class=\\"line\\">  <span class=\\"token property\\">datacenters</span> <span class=\\"token punctuation\\">=</span> <span class=\\"token punctuation\\">[</span><span class=\\"token string\\">\\"dc1\\"</span><span class=\\"token punctuation\\">]</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\">  group <span class=\\"token string\\">\\"nginx\\"</span> <span class=\\"token punctuation\\">{</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\">    <span class=\\"token keyword\\">constraint</span> <span class=\\"token punctuation\\">{</span></span>\\n<span class=\\"line\\">      <span class=\\"token property\\">attribute</span> <span class=\\"token punctuation\\">=</span> <span class=\\"token string\\">\\"<span class=\\"token interpolation\\"><span class=\\"token punctuation\\">$</span><span class=\\"token punctuation\\">{</span>attr<span class=\\"token punctuation\\">.</span>unique<span class=\\"token punctuation\\">.</span>hostname<span class=\\"token punctuation\\">}</span></span>\\"</span></span>\\n<span class=\\"line\\">      <span class=\\"token property\\">value</span>     <span class=\\"token punctuation\\">=</span> <span class=\\"token string\\">\\"slave0\\"</span></span>\\n<span class=\\"line\\">    <span class=\\"token punctuation\\">}</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\">    <span class=\\"token comment\\">#Vault tls가 있고 nomad client hcl 파일에 host volume이 명시되어 있는 설정 값</span></span>\\n<span class=\\"line\\">    volume <span class=\\"token string\\">\\"cert-data\\"</span> <span class=\\"token punctuation\\">{</span></span>\\n<span class=\\"line\\">      <span class=\\"token property\\">type</span>      <span class=\\"token punctuation\\">=</span> <span class=\\"token string\\">\\"host\\"</span></span>\\n<span class=\\"line\\">      <span class=\\"token property\\">source</span>    <span class=\\"token punctuation\\">=</span> <span class=\\"token string\\">\\"cert-data\\"</span></span>\\n<span class=\\"line\\">      <span class=\\"token property\\">read_only</span> <span class=\\"token punctuation\\">=</span> <span class=\\"token boolean\\">false</span></span>\\n<span class=\\"line\\">    <span class=\\"token punctuation\\">}</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\">    <span class=\\"token comment\\">#실패 없이 되라고 행운의 숫자인 7을 4번 줌</span></span>\\n<span class=\\"line\\">    <span class=\\"token keyword\\">network</span> <span class=\\"token punctuation\\">{</span></span>\\n<span class=\\"line\\">      port <span class=\\"token string\\">\\"http\\"</span> <span class=\\"token punctuation\\">{</span></span>\\n<span class=\\"line\\">        <span class=\\"token property\\">to</span>     <span class=\\"token punctuation\\">=</span> <span class=\\"token number\\">7777</span></span>\\n<span class=\\"line\\">        <span class=\\"token property\\">static</span> <span class=\\"token punctuation\\">=</span> <span class=\\"token number\\">7777</span></span>\\n<span class=\\"line\\">      <span class=\\"token punctuation\\">}</span></span>\\n<span class=\\"line\\">    <span class=\\"token punctuation\\">}</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\">    <span class=\\"token keyword\\">service</span> <span class=\\"token punctuation\\">{</span></span>\\n<span class=\\"line\\">      <span class=\\"token property\\">name</span> <span class=\\"token punctuation\\">=</span> <span class=\\"token string\\">\\"nginx\\"</span></span>\\n<span class=\\"line\\">      <span class=\\"token property\\">port</span> <span class=\\"token punctuation\\">=</span> <span class=\\"token string\\">\\"http\\"</span></span>\\n<span class=\\"line\\">    <span class=\\"token punctuation\\">}</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\">    task <span class=\\"token string\\">\\"nginx\\"</span> <span class=\\"token punctuation\\">{</span></span>\\n<span class=\\"line\\">      <span class=\\"token property\\">driver</span> <span class=\\"token punctuation\\">=</span> <span class=\\"token string\\">\\"docker\\"</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\">      <span class=\\"token keyword\\">volume_mount</span> <span class=\\"token punctuation\\">{</span></span>\\n<span class=\\"line\\">        <span class=\\"token property\\">volume</span>      <span class=\\"token punctuation\\">=</span> <span class=\\"token string\\">\\"cert-data\\"</span></span>\\n<span class=\\"line\\">        <span class=\\"token property\\">destination</span> <span class=\\"token punctuation\\">=</span> <span class=\\"token string\\">\\"/usr/local/cert\\"</span></span>\\n<span class=\\"line\\">      <span class=\\"token punctuation\\">}</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\">      <span class=\\"token keyword\\">config</span> <span class=\\"token punctuation\\">{</span></span>\\n<span class=\\"line\\">        <span class=\\"token property\\">image</span> <span class=\\"token punctuation\\">=</span> <span class=\\"token string\\">\\"nginx\\"</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\">        <span class=\\"token property\\">ports</span> <span class=\\"token punctuation\\">=</span> <span class=\\"token punctuation\\">[</span><span class=\\"token string\\">\\"http\\"</span><span class=\\"token punctuation\\">]</span></span>\\n<span class=\\"line\\">        <span class=\\"token property\\">volumes</span> <span class=\\"token punctuation\\">=</span> <span class=\\"token punctuation\\">[</span></span>\\n<span class=\\"line\\">          <span class=\\"token string\\">\\"local:/etc/nginx/conf.d\\"</span>,</span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\">        <span class=\\"token punctuation\\">]</span></span>\\n<span class=\\"line\\">      <span class=\\"token punctuation\\">}</span></span>\\n<span class=\\"line\\">      <span class=\\"token keyword\\">template</span> <span class=\\"token punctuation\\">{</span></span>\\n<span class=\\"line\\">        <span class=\\"token property\\">data</span> <span class=\\"token punctuation\\">=</span> <span class=\\"token heredoc string\\">&lt;&lt;EOF        </span>\\n<span class=\\"line\\">#Vault는 active서버 1대외에는 전부 standby상태이며 </span>\\n<span class=\\"line\\">#서비스 호출 시(write)에는 active 서비스만 호출해야함으로 아래와 같이 consul에서 서비스를 불러옴</span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\">upstream backend {</span>\\n<span class=\\"line\\">{{ range service \\"active.vault\\" }}</span>\\n<span class=\\"line\\">  server {{ .Address }}:{{ .Port }};</span>\\n<span class=\\"line\\">{{ else }}server 127.0.0.1:65535; # force a 502</span>\\n<span class=\\"line\\">{{ end }}</span>\\n<span class=\\"line\\">}</span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\">server {</span>\\n<span class=\\"line\\">   listen 7777 ssl;</span>\\n<span class=\\"line\\">   #위에서 nomad host volume을 mount한 cert를 가져옴</span>\\n<span class=\\"line\\">   ssl on;</span>\\n<span class=\\"line\\">   ssl_certificate /usr/local/cert/vault/global-client-vault-0.pem;</span>\\n<span class=\\"line\\">   ssl_certificate_key /usr/local/cert/vault/global-client-vault-0-key.pem;</span>\\n<span class=\\"line\\">   #vault ui 접근 시 / -&gt; /ui redirect되기 때문에 location이 /외에는 되지 않는다.</span>\\n<span class=\\"line\\">   location / {</span>\\n<span class=\\"line\\">      proxy_pass https://backend;</span>\\n<span class=\\"line\\">   }</span>\\n<span class=\\"line\\">}</span>\\n<span class=\\"line\\">EOF</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\">        <span class=\\"token property\\">destination</span>   <span class=\\"token punctuation\\">=</span> <span class=\\"token string\\">\\"local/load-balancer.conf\\"</span></span>\\n<span class=\\"line\\">        <span class=\\"token property\\">change_mode</span>   <span class=\\"token punctuation\\">=</span> <span class=\\"token string\\">\\"signal\\"</span></span>\\n<span class=\\"line\\">        <span class=\\"token property\\">change_signal</span> <span class=\\"token punctuation\\">=</span> <span class=\\"token string\\">\\"SIGHUP\\"</span></span>\\n<span class=\\"line\\">      <span class=\\"token punctuation\\">}</span></span>\\n<span class=\\"line\\">      <span class=\\"token keyword\\">resources</span> <span class=\\"token punctuation\\">{</span></span>\\n<span class=\\"line\\">        <span class=\\"token property\\">cpu</span> <span class=\\"token punctuation\\">=</span> <span class=\\"token number\\">100</span></span>\\n<span class=\\"line\\">        <span class=\\"token property\\">memory</span> <span class=\\"token punctuation\\">=</span> <span class=\\"token number\\">201</span></span>\\n<span class=\\"line\\">      <span class=\\"token punctuation\\">}</span></span>\\n<span class=\\"line\\">    <span class=\\"token punctuation\\">}</span></span>\\n<span class=\\"line\\">  <span class=\\"token punctuation\\">}</span></span>\\n<span class=\\"line\\"><span class=\\"token punctuation\\">}</span></span>\\n<span class=\\"line\\"></span></code></pre></div>"}');export{d as comp,k as data};
