import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{o as s,c as a,h as e}from"./app-DVMlqOhY.js";const t={},l=e(`<h1 id="consul-sidecar-inject-not-working-on-k8s" tabindex="-1"><a class="header-anchor" href="#consul-sidecar-inject-not-working-on-k8s"><span>Consul Sidecar Inject not working on K8S</span></a></h1><blockquote><p>Consul Version : 1.9.x<br> Helm Chart : 0.30.0</p></blockquote><p>Consul을 쿠버네티스 상에 구성하게 되면 <code>annotation</code> 구성만으로도 쉽게 Sidecar를 애플리케이션과 함께 배포 가능하다.</p><p>참고 : <a href="https://www.consul.io/docs/k8s/connect#controlling-injection-via-annotation" target="_blank" rel="noopener noreferrer">Controlling Injection Via Annotation</a></p><div class="language-yaml" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="line"><span class="token key atrule">annotations</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">&#39;consul.hashicorp.com/connect-inject&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;true&#39;</span></span>
<span class="line"></span></code></pre></div><p>Consul Sidecar가 Pod 배포시 함께 구성되야 하는 것이 정상이나, Sidecar의 생성 실패나 이미지 가져오기 실패라는 언급도 없이 Sidecar의 injection이 동작하지 않는 경우가 있다.</p><h2 id="log-확인" tabindex="-1"><a class="header-anchor" href="#log-확인"><span>Log 확인</span></a></h2><p>쿠버네티스 상의 Consul을 구성하게 되면 injector가 Sidecar를 함께 배포하는 작업을 수행하므로 먼저 해당 컴포넌트의 로그를 확인한다.</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">kubectl logs <span class="token parameter variable">-n</span> consul <span class="token parameter variable">-l</span> <span class="token assign-left variable">component</span><span class="token operator">=</span>connect-injector <span class="token parameter variable">-f</span></span>
<span class="line"></span></code></pre></div><h2 id="kubernetes-api-확인" tabindex="-1"><a class="header-anchor" href="#kubernetes-api-확인"><span>Kubernetes API 확인</span></a></h2><p><code>annotation</code>의 동작은 쿠버네티스 컨트롤 플래인, 즉, 쿠버네티스의 API를 통해 요청되므로 해당 API를 통해 Consul에 접근이 가능한지 확인이 필요하다.<br> consul-inject에서 kubernetest api 접속이 불가하다면 <code>500</code>에러가 발생한다.</p><ol><li>api 접속을 위한 proxy를 활성화<div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ kubectl proxy</span>
<span class="line">Starting to serve on <span class="token number">127.0</span>.0.1:8001</span>
<span class="line"></span></code></pre></div></li><li>다른 터미널에서 API로 확인 <ul><li>정상인 경우</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ <span class="token function">curl</span> <span class="token parameter variable">-vv</span> localhost:8001/api/v1/namespaces/consul/services/https:consul-connect-injector-svc:443/proxy/health/ready</span>
<span class="line">*   Trying <span class="token number">127.0</span>.0.1<span class="token punctuation">..</span>.</span>
<span class="line">* TCP_NODELAY <span class="token builtin class-name">set</span></span>
<span class="line">* Connected to localhost <span class="token punctuation">(</span><span class="token number">127.0</span>.0.1<span class="token punctuation">)</span> port <span class="token number">8001</span> <span class="token punctuation">(</span><span class="token comment">#0)</span></span>
<span class="line"><span class="token operator">&gt;</span> GET /api/v1/namespaces/consul/services/https:consul-connect-injector-svc:443/proxy/health/ready HTTP/1.1</span>
<span class="line"><span class="token operator">&gt;</span> Host: localhost:8001</span>
<span class="line"><span class="token operator">&gt;</span> User-Agent: curl/7.61.1</span>
<span class="line"><span class="token operator">&gt;</span> Accept: */*</span>
<span class="line"><span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">204</span> No Content</span>
<span class="line"><span class="token operator">&lt;</span> Audit-Id: 52947d1d-0c90-47eb-8dc2-6c2efa0193fa</span>
<span class="line"><span class="token operator">&lt;</span> Cache-Control: no-cache, private</span>
<span class="line"><span class="token operator">&lt;</span> Date: Fri, 06 Aug <span class="token number">2021</span> <span class="token number">10</span>:15:21 GMT</span>
<span class="line"><span class="token operator">&lt;</span></span>
<span class="line">* Connection <span class="token comment">#0 to host localhost left intact</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>쿠버네티스 API 접근이 안되는 경우</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">*   Trying <span class="token number">127.0</span>.0.1<span class="token punctuation">..</span>.                                      </span>
<span class="line">* TCP_NODELAY <span class="token builtin class-name">set</span>                                            </span>
<span class="line">* Connected to localhost <span class="token punctuation">(</span><span class="token number">127.0</span>.0.1<span class="token punctuation">)</span> port <span class="token number">8001</span> <span class="token punctuation">(</span><span class="token comment">#0)          </span></span>
<span class="line"><span class="token operator">&gt;</span> GET /api/v1/namespaces/consul/services/https:consul-connect</span>
<span class="line">-injector-svc:443/proxy/health/ready HTTP/1.1                </span>
<span class="line"><span class="token operator">&gt;</span> Host: localhost:8001                                       </span>
<span class="line"><span class="token operator">&gt;</span> User-Agent: curl/7.61.1                                    </span>
<span class="line"><span class="token operator">&gt;</span> Accept: */*                                                </span>
<span class="line"><span class="token operator">&gt;</span>                                                            </span>
<span class="line"><span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">500</span> Internal Server Error                         </span>
<span class="line"><span class="token operator">&lt;</span> Audit-Id: acb30d91-d8db-463e-a91e-1e2a5382329e             </span>
<span class="line"><span class="token operator">&lt;</span> Cache-Control: no-cache, private                           </span>
<span class="line"><span class="token operator">&lt;</span> Content-Length: <span class="token number">178</span>                                        </span>
<span class="line"><span class="token operator">&lt;</span> Content-Type: application/json</span>
<span class="line"><span class="token operator">&lt;</span> Date: Fri, 06 Aug <span class="token number">2021</span> <span class="token number">11</span>:04:38 GMT                        </span>
<span class="line"><span class="token operator">&lt;</span>                                                            </span>
<span class="line"><span class="token punctuation">{</span>                                                            </span>
<span class="line">  <span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Status&quot;</span>,</span>
<span class="line">  <span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;v1&quot;</span>,                                        </span>
<span class="line">  <span class="token string">&quot;metadata&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>                                              </span>
<span class="line">                                                            </span>
<span class="line">  <span class="token punctuation">}</span>,                                                         </span>
<span class="line">  <span class="token string">&quot;status&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Failure&quot;</span>,                                       </span>
<span class="line">  <span class="token string">&quot;message&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;error trying to reach service: Address is not a</span>
<span class="line">  llowed&quot;</span>,                                                     </span>
<span class="line">  <span class="token string">&quot;code&quot;</span><span class="token builtin class-name">:</span> <span class="token number">500</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">* Connection <span class="token comment">#0 to host localhost left intact</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol>`,12),o=[l];function i(p,c){return s(),a("div",null,o)}const u=n(t,[["render",i],["__file","Consul Sidecar Inject not working on k8s.html.vue"]]),m=JSON.parse('{"path":"/04-HashiCorp/04-Consul/04-TroubleShooting/Consul%20Sidecar%20Inject%20not%20working%20on%20k8s.html","title":"Consul Sidecar Inject not working on K8S","lang":"ko-KR","frontmatter":{"description":"SSH Too many authentication failures","tag":["Consul","ServiceMesh","SideCar","Kubernetes","K8S"],"head":[["meta",{"property":"og:url","content":"https://docmoa.github.io/04-HashiCorp/04-Consul/04-TroubleShooting/Consul%20Sidecar%20Inject%20not%20working%20on%20k8s.html"}],["meta",{"property":"og:site_name","content":"docmoa"}],["meta",{"property":"og:title","content":"Consul Sidecar Inject not working on K8S"}],["meta",{"property":"og:description","content":"SSH Too many authentication failures"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"ko-KR"}],["meta",{"property":"og:updated_time","content":"2023-09-18T13:12:54.000Z"}],["meta",{"property":"article:tag","content":"Consul"}],["meta",{"property":"article:tag","content":"ServiceMesh"}],["meta",{"property":"article:tag","content":"SideCar"}],["meta",{"property":"article:tag","content":"Kubernetes"}],["meta",{"property":"article:tag","content":"K8S"}],["meta",{"property":"article:modified_time","content":"2023-09-18T13:12:54.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Consul Sidecar Inject not working on K8S\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2023-09-18T13:12:54.000Z\\",\\"author\\":[]}"]]},"headers":[{"level":2,"title":"Log 확인","slug":"log-확인","link":"#log-확인","children":[]},{"level":2,"title":"Kubernetes API 확인","slug":"kubernetes-api-확인","link":"#kubernetes-api-확인","children":[]}],"git":{"createdTime":1628250600000,"updatedTime":1695042774000,"contributors":[{"name":"Great-Stone","email":"hahohh@gmail.com","commits":2}]},"readingTime":{"minutes":4.17,"words":250},"filePathRelative":"04-HashiCorp/04-Consul/04-TroubleShooting/Consul Sidecar Inject not working on k8s.md","localizedDate":"2021년 8월 6일","excerpt":"\\n<blockquote>\\n<p>Consul Version : 1.9.x<br>\\nHelm Chart : 0.30.0</p>\\n</blockquote>\\n<p>Consul을 쿠버네티스 상에 구성하게 되면 <code>annotation</code> 구성만으로도 쉽게 Sidecar를 애플리케이션과 함께 배포 가능하다.</p>\\n<p>참고 : <a href=\\"https://www.consul.io/docs/k8s/connect#controlling-injection-via-annotation\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">Controlling Injection Via Annotation</a></p>"}');export{u as comp,m as data};
