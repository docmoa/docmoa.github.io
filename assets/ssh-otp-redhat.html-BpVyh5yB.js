import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{o as a,c as e,h as n}from"./app-DVMlqOhY.js";const t={},l=n(`<h1 id="ssh-otp-redhat-계열" tabindex="-1"><a class="header-anchor" href="#ssh-otp-redhat-계열"><span>SSH OTP - RedHat 계열</span></a></h1><blockquote><p><a href="https://learn.hashicorp.com/tutorials/vault/pki-engine" target="_blank" rel="noopener noreferrer">https://learn.hashicorp.com/tutorials/vault/pki-engine</a></p></blockquote><h2 id="vault설정" tabindex="-1"><a class="header-anchor" href="#vault설정"><span>Vault설정</span></a></h2><p>시크릿 엔진 활성화</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ vault secrets <span class="token builtin class-name">enable</span> <span class="token parameter variable">-path</span> <span class="token function">ssh</span> <span class="token function">ssh</span></span>
<span class="line"></span></code></pre></div><p>롤 생성</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ vault <span class="token function">write</span> ssh/roles/otp_key_role <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token assign-left variable">key_type</span><span class="token operator">=</span>otp <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token assign-left variable">default_user</span><span class="token operator">=</span>test <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token assign-left variable">allowed_users</span><span class="token operator">=</span>test <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token assign-left variable">key_bits</span><span class="token operator">=</span><span class="token number">2048</span> <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token assign-left variable">cidr_list</span><span class="token operator">=</span><span class="token number">172.28</span>.128.0/24</span>
<span class="line">Success<span class="token operator">!</span> Data written to: ssh/roles/otp_key_role</span>
<span class="line"></span></code></pre></div><blockquote><p>e.g. cidr_list=127.0.0.1/32,172.28.128.1/32 or 0.0.0.0/0</p></blockquote><h2 id="대상-서버-설정" tabindex="-1"><a class="header-anchor" href="#대상-서버-설정"><span>대상 서버 설정</span></a></h2><p>접속할 사용자 생성</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ <span class="token function">sudo</span> adduser <span class="token builtin class-name">test</span></span>
<span class="line"></span></code></pre></div><p>vault-ssh-helper 구성 &lt;config.hcl&gt;</p><blockquote><p><a href="https://github.com/hashicorp/vault-ssh-helper" target="_blank" rel="noopener noreferrer">https://github.com/hashicorp/vault-ssh-helper</a></p></blockquote><div class="language-ruby" data-highlighter="prismjs" data-ext="rb" data-title="rb"><pre class="language-ruby"><code><span class="line">vault_addr <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;http://172.28.128.21:8200&quot;</span></span></span>
<span class="line">ssh_mount_point <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;ssh&quot;</span></span></span>
<span class="line">namespace <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;&quot;</span></span></span>
<span class="line">tls_skip_verify <span class="token operator">=</span> <span class="token boolean">true</span></span>
<span class="line">allowed_roles <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;*&quot;</span></span></span>
<span class="line">allowed_cidr_list <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;0.0.0.0/0&quot;</span></span></span>
<span class="line"></span></code></pre></div><p>vault-ssh-helper 다운로드</p><blockquote><p><a href="https://releases.hashicorp.com/vault-ssh-helper/" target="_blank" rel="noopener noreferrer">https://releases.hashicorp.com/vault-ssh-helper/</a></p></blockquote><p>vault-ssh-helper verify</p><blockquote><p>tls를 사용하지 않는 경우. <code>-dev</code></p></blockquote><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">vault-ssh-helper -verify-only <span class="token parameter variable">-config</span><span class="token operator">=</span>config.hcl <span class="token parameter variable">-dev</span></span>
<span class="line"></span></code></pre></div><p>Pam 설정</p><p><code>/etc/pam.d/sshd</code> 파일의 <code>@include common-auth</code> 부분을 다음과 같이 변경 추가</p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="line"><span class="token comment">#%PAM-1.0</span></span>
<span class="line"><span class="token key attr-name">auth</span> <span class="token value attr-value">       required    pam_sepermit.so</span></span>
<span class="line"><span class="token comment">#auth       substack    password-auth # COMMENT OUT FOR SSH-HELPER</span></span>
<span class="line"><span class="token key attr-name">auth</span> <span class="token value attr-value">       include     postlogin</span></span>
<span class="line"><span class="token key attr-name">auth</span> <span class="token value attr-value">       requisite   pam_exec.so quiet expose_authtok log=/var/log/vaultssh.log /usr/local/bin/vault-ssh-helper -config=/etc/vault-ssh-helper.d/config.hcl -dev</span></span>
<span class="line"><span class="token key attr-name">auth</span> <span class="token value attr-value">       optional    pam_unix.so not_set_pass use_first_pass nodelay</span></span>
<span class="line"><span class="token comment"># Used with polkit to reauthorize users in remote sessions</span></span>
<span class="line"><span class="token key attr-name">-auth</span> <span class="token value attr-value">      optional    pam_reauthorize.so prepare</span></span>
<span class="line"><span class="token key attr-name">account</span> <span class="token value attr-value">    required    pam_nologin.so</span></span>
<span class="line"><span class="token key attr-name">account</span> <span class="token value attr-value">    include     password-auth</span></span>
<span class="line"><span class="token comment">#password   include     password-auth # COMMENT OUT FOR SSH-HELPER</span></span>
<span class="line"><span class="token comment"># pam_selinux.so close should be the first session rule</span></span>
<span class="line"><span class="token key attr-name">session</span> <span class="token value attr-value">    required    pam_selinux.so close</span></span>
<span class="line"><span class="token key attr-name">session</span> <span class="token value attr-value">    required    pam_loginuid.so</span></span>
<span class="line"><span class="token comment"># pam_selinux.so open should only be followed by sessions to be executed in the user context</span></span>
<span class="line"><span class="token key attr-name">session</span> <span class="token value attr-value">    required    pam_selinux.so open env_params</span></span>
<span class="line"><span class="token key attr-name">session</span> <span class="token value attr-value">    required    pam_namespace.so</span></span>
<span class="line"><span class="token key attr-name">session</span> <span class="token value attr-value">    optional    pam_keyinit.so force revoke</span></span>
<span class="line"><span class="token key attr-name">session</span> <span class="token value attr-value">    include     password-auth</span></span>
<span class="line"><span class="token key attr-name">session</span> <span class="token value attr-value">    include     postlogin</span></span>
<span class="line"><span class="token comment"># Used with polkit to reauthorize users in remote sessions</span></span>
<span class="line"><span class="token key attr-name">-session</span> <span class="token value attr-value">  optional     pam_reauthorize.so prepare</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ssh 설정</p><p><code>/etc/ssh/sshd_config</code> 파일의 다음 항목을 수정</p><blockquote><p>이미 있는 옵션은 값 수정, 없는 옵션은 추가</p></blockquote><div class="language-properties" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="line"><span class="token key attr-name">ChallengeResponseAuthentication</span> <span class="token value attr-value">yes</span></span>
<span class="line"><span class="token key attr-name">UsePAM</span> <span class="token value attr-value">yes</span></span>
<span class="line"><span class="token key attr-name">PasswordAuthentication</span> <span class="token value attr-value">no</span></span>
<span class="line"></span></code></pre></div><p>ssh 서비스 재시작</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ systemctl restart sshd</span>
<span class="line"></span></code></pre></div><h2 id="테스트" tabindex="-1"><a class="header-anchor" href="#테스트"><span>테스트</span></a></h2><p>otp 발급</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ vault <span class="token function">write</span> ssh/creds/otp_key_role <span class="token assign-left variable">ip</span><span class="token operator">=</span><span class="token number">172.28</span>.128.31</span>
<span class="line">Key                Value</span>
<span class="line">---                -----</span>
<span class="line">lease_id           ssh/creds/otp_key_role/r2SFjhwt3brVT0msL1KEq2Dv</span>
<span class="line">lease_duration     768h</span>
<span class="line">lease_renewable    <span class="token boolean">false</span></span>
<span class="line"><span class="token function">ip</span>                 <span class="token number">172.28</span>.128.31</span>
<span class="line">key                f8a32d6c-beec-383c-62d6-3718b367f88d</span>
<span class="line">key_type           otp</span>
<span class="line">port               <span class="token number">22</span></span>
<span class="line">username           <span class="token builtin class-name">test</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>접속 방법 1. ssh</p><blockquote><p>Password: 에 앞서 요청한 롤의 credential 값의 <code>key</code> 를 넣어준다.</p></blockquote><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ <span class="token function">ssh</span> test@172.28.128.31</span>
<span class="line">Password:</span>
<span class="line"></span></code></pre></div><p>접속 방법 2. vault ssh</p><blockquote><p>Vault로 해당 ssh otp에 권한이 있는 사용자인 경우 <code>sshpass</code> 가 설치되어있으면 자동 입력</p></blockquote><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ vault <span class="token function">ssh</span> <span class="token parameter variable">-role</span> otp_key_role <span class="token parameter variable">-mode</span> otp test@172.28.128.31</span>
<span class="line">or</span>
<span class="line">$ vault <span class="token function">ssh</span> <span class="token parameter variable">-role</span> otp_key_role <span class="token parameter variable">-mode</span> otp -strict-host-key-checking<span class="token operator">=</span>no test@172.28.128.31</span>
<span class="line"></span></code></pre></div>`,37),p=[l];function o(i,r){return a(),e("div",null,p)}const u=s(t,[["render",o],["__file","ssh-otp-redhat.html.vue"]]),h=JSON.parse('{"path":"/04-HashiCorp/06-Vault/02-Secret_Engine/ssh-otp-redhat.html","title":"SSH OTP - RedHat 계열","lang":"ko-KR","frontmatter":{"description":"Vault SSH Rocky에 구성하는 예제","tag":["vault","SSH","OTP","Rocky","RHEL","CentOS"],"head":[["meta",{"property":"og:url","content":"https://docmoa.github.io/04-HashiCorp/06-Vault/02-Secret_Engine/ssh-otp-redhat.html"}],["meta",{"property":"og:site_name","content":"docmoa"}],["meta",{"property":"og:title","content":"SSH OTP - RedHat 계열"}],["meta",{"property":"og:description","content":"Vault SSH Rocky에 구성하는 예제"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"ko-KR"}],["meta",{"property":"og:updated_time","content":"2023-09-18T13:12:54.000Z"}],["meta",{"property":"article:tag","content":"vault"}],["meta",{"property":"article:tag","content":"SSH"}],["meta",{"property":"article:tag","content":"OTP"}],["meta",{"property":"article:tag","content":"Rocky"}],["meta",{"property":"article:tag","content":"RHEL"}],["meta",{"property":"article:tag","content":"CentOS"}],["meta",{"property":"article:modified_time","content":"2023-09-18T13:12:54.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"SSH OTP - RedHat 계열\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2023-09-18T13:12:54.000Z\\",\\"author\\":[]}"]]},"headers":[{"level":2,"title":"Vault설정","slug":"vault설정","link":"#vault설정","children":[]},{"level":2,"title":"대상 서버 설정","slug":"대상-서버-설정","link":"#대상-서버-설정","children":[]},{"level":2,"title":"테스트","slug":"테스트","link":"#테스트","children":[]}],"git":{"createdTime":1628563561000,"updatedTime":1695042774000,"contributors":[{"name":"Administrator","email":"admin@example.com","commits":2},{"name":"Great-Stone","email":"hahohh@gmail.com","commits":1}]},"readingTime":{"minutes":5.25,"words":315},"filePathRelative":"04-HashiCorp/06-Vault/02-Secret_Engine/ssh-otp-redhat.md","localizedDate":"2021년 8월 10일","excerpt":"\\n<blockquote>\\n<p><a href=\\"https://learn.hashicorp.com/tutorials/vault/pki-engine\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">https://learn.hashicorp.com/tutorials/vault/pki-engine</a></p>\\n</blockquote>\\n<h2>Vault설정</h2>\\n<p>시크릿 엔진 활성화</p>\\n<div class=\\"language-bash\\" data-highlighter=\\"prismjs\\" data-ext=\\"sh\\" data-title=\\"sh\\"><pre class=\\"language-bash\\"><code><span class=\\"line\\">$ vault secrets <span class=\\"token builtin class-name\\">enable</span> <span class=\\"token parameter variable\\">-path</span> <span class=\\"token function\\">ssh</span> <span class=\\"token function\\">ssh</span></span>\\n<span class=\\"line\\"></span></code></pre></div>"}');export{u as comp,h as data};
