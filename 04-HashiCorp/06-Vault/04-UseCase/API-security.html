<!doctype html>
<html lang="ko-KR" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.14" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.50" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://docmoa.github.io/04-HashiCorp/06-Vault/04-UseCase/API-security.html"><meta property="og:site_name" content="docmoa"><meta property="og:title" content="API 보안을 위한 Vault 활용 (API Key)"><meta property="og:description" content="API 보안을 위한 Vault 활용"><meta property="og:type" content="article"><meta property="og:locale" content="ko-KR"><meta property="og:updated_time" content="2024-03-19T23:38:02.000Z"><meta property="article:author" content="GS"><meta property="article:tag" content="vault"><meta property="article:tag" content="token"><meta property="article:tag" content="pki"><meta property="article:tag" content="mTLS"><meta property="article:modified_time" content="2024-03-19T23:38:02.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"API 보안을 위한 Vault 활용 (API Key)","image":[""],"dateModified":"2024-03-19T23:38:02.000Z","author":[{"@type":"Person","name":"GS"}]}</script><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap"><link rel="icon" href="/logo.png"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><link rel="apple-touch-icon" href="/assets/icon/apple-icon-152.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileImage" content="/assets/icon/ms-icon-144.png"><meta name="msapplication-TileColor" content="#ffffff"><link rel="alternate" type="application/rss+xml" href="https://docmoa.github.io/rss.xml" title="docmoa RSS Feed"><title>API 보안을 위한 Vault 활용 (API Key) | docmoa</title><meta name="description" content="API 보안을 위한 Vault 활용">
    <link rel="preload" href="/assets/style-CkODk6eP.css" as="style"><link rel="stylesheet" href="/assets/style-CkODk6eP.css">
    <link rel="modulepreload" href="/assets/app-DVMlqOhY.js"><link rel="modulepreload" href="/assets/API-security.html-Co2lnay7.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">본문으로 건너뛰기</a><!--]--><!--[--><div class="theme-container external-link-icon has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="/logo.png" alt><!----><span class="vp-site-name hide-in-pad">docmoa</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/" aria-label="docmoa"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span><!--]-->docmoa<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/00-Howto/" aria-label="How To"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-rocket" style=""></span><!--]-->How To<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Infra"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-server" style=""></span>Infra<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/01-Infrastructure/" aria-label="Infrastructure"><!---->Infrastructure<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/02-PrivatePlatform/" aria-label="Private-Platform"><!---->Private-Platform<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/03-PublicCloud/" aria-label="Public-Cloud"><!---->Public-Cloud<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/05-Software/" aria-label="Software"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-code" style=""></span><!--]-->Software<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link route-link-active auto-link" href="/04-HashiCorp/" aria-label="HashiCorp"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-layer-group" style=""></span><!--]-->HashiCorp<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/07-Kubernetes/" aria-label="Kubernetes"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-dharmachakra" style=""></span><!--]-->Kubernetes<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/06-etc/" aria-label="Etc."><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-mug-hot" style=""></span><!--]-->Etc.<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="MORE"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-circle-info" style=""></span>MORE<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/99-about/01-About.html" aria-label="About"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-house-circle-exclamation" style=""></span><!--]-->About<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/99-about/02-Thanks.html" aria-label="Thank you"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-heart" style=""></span><!--]-->Thank you<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/timeline/" aria-label="Recently"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-clock-rotate-left" style=""></span><!--]-->Recently<!----></a></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/docmoa/docs" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon" name="outlook"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-outlook-dropdown"><!----></div></button></div><!--[--><button type="button" class="search-pro-button" aria-label="검색"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon" name="search"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">검색</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!----><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/04-HashiCorp/" aria-label="HashiCorp"><!---->HashiCorp<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">01 Packer</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">02 Vagrant</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">03 Terraform</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">04 Consul</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">05 Boundary</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">06 Vault</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">01 Information</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">02 Secret Engine</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">03 Auth Method</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">04 Use Case</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/04-HashiCorp/06-Vault/04-UseCase/API-security.html" aria-label="API 보안을 위한 Vault 활용 (API Key)"><!---->API 보안을 위한 Vault 활용 (API Key)<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/04-HashiCorp/06-Vault/04-UseCase/argocd-vault-plugin.html" aria-label="ArgoCD Vault Plugin"><!---->ArgoCD Vault Plugin<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/04-HashiCorp/06-Vault/04-UseCase/gitlabci-with-vault.html" aria-label="Gitlab 파이프라인의 Secret을 Vault로 관리"><!---->Gitlab 파이프라인의 Secret을 Vault로 관리<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/04-HashiCorp/06-Vault/04-UseCase/vault-k8s-usecase-csi-injection.html" aria-label="How to integrate Vault with K8s (CSI &amp; Injection &amp; VSO)"><!---->How to integrate Vault with K8s (CSI &amp; Injection &amp; VSO)<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/04-HashiCorp/06-Vault/04-UseCase/jenkins-pipeilne-vault-approle.html" aria-label="Jenkins Pipeline Vault Approle (with Nomad)"><!---->Jenkins Pipeline Vault Approle (with Nomad)<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/04-HashiCorp/06-Vault/04-UseCase/jenkins-with-vault.html" aria-label="jenkins with vault"><!---->jenkins with vault<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/04-HashiCorp/06-Vault/04-UseCase/jenkins-with-vault-otp.html" aria-label="jenkins with vault otp"><!---->jenkins with vault otp<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/04-HashiCorp/06-Vault/04-UseCase/vault-k8s-integration-three-methods.html" aria-label="Kubernetes Vault 통합방안 3가지 비교"><!---->Kubernetes Vault 통합방안 3가지 비교<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/04-HashiCorp/06-Vault/04-UseCase/vault-k8s-manually-using-the-sidecar.html" aria-label="Kubernetes에 Vault Agent(Sidecar) 수동 구성"><!---->Kubernetes에 Vault Agent(Sidecar) 수동 구성<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/04-HashiCorp/06-Vault/04-UseCase/sentinel-check-identity-cidr.html" aria-label="Sentinel - (Identity &amp; CIDR)"><!---->Sentinel - (Identity &amp; CIDR)<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/04-HashiCorp/06-Vault/04-UseCase/terraform-with-aws-secret-engine.html" aria-label="Terraform 코드 상에서 Vault 연동하기"><!---->Terraform 코드 상에서 Vault 연동하기<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/04-HashiCorp/06-Vault/04-UseCase/nomad-integration.html" aria-label="Vault &amp; Nomad Integration Test"><!---->Vault &amp; Nomad Integration Test<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/04-HashiCorp/06-Vault/04-UseCase/mtls.html" aria-label="Vault PKI - mTLS demo"><!---->Vault PKI - mTLS demo<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/04-HashiCorp/06-Vault/04-UseCase/get-all-secret-engine.html" aria-label="Vault Secret Engine 조회 스크립트"><!---->Vault Secret Engine 조회 스크립트<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/04-HashiCorp/06-Vault/04-UseCase/secret-sync.html" aria-label="Vault Secret를 AWS Secret manager 연동"><!---->Vault Secret를 AWS Secret manager 연동<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/04-HashiCorp/06-Vault/04-UseCase/transit-stress-test.html" aria-label="Vault Stress Test"><!---->Vault Stress Test<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/04-HashiCorp/06-Vault/04-UseCase/spring-boot.html" aria-label="Vault로 Spring Boot 구성관리"><!---->Vault로 Spring Boot 구성관리<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/04-HashiCorp/06-Vault/04-UseCase/spring-boot-with-vault.html" aria-label="Vault로 Spring Boot 구성관리 aws-auth Version"><!---->Vault로 Spring Boot 구성관리 aws-auth Version<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/04-HashiCorp/06-Vault/04-UseCase/mtls-authentication-to-secure-web-services.html" aria-label="Vault를 활용한 mTLS 인증 자동화로 웹 서비스 보안 강화하기"><!---->Vault를 활용한 mTLS 인증 자동화로 웹 서비스 보안 강화하기<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/04-HashiCorp/06-Vault/04-UseCase/windows-password-rotation.html" aria-label="Windows Password rotation"><!---->Windows Password rotation<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/04-HashiCorp/06-Vault/04-UseCase/Secured-RAG-with-Vault-on-aws.html" aria-label="안전한 RAG 시스템 구축: HashiCorp Vault와 Amazon Bedrock 활용"><!---->안전한 RAG 시스템 구축: HashiCorp Vault와 Amazon Bedrock 활용<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">05 Trouble Shooting</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">06 Config</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">07 Sentinel Sample</span><span class="vp-arrow end"></span></button><!----></section></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">07 Nomad</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">08 Updates</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->API 보안을 위한 Vault 활용 (API Key)</h1><div class="page-info"><span class="page-author-info" aria-label="작성자🖊" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">GS</span></span><span property="author" content="GS"></span></span><!----><span class="page-date-info" aria-label="작성일📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-03-19T14:41:45.000Z"></span><!----><span class="page-reading-time-info" aria-label="읽는 시간⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>약 31 분</span><meta property="timeRequired" content="PT31M"></span><!----><span class="page-tag-info" aria-label="태그🏷" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color2 clickable" role="navigation">vault</span><span class="page-tag-item color2 clickable" role="navigation">token</span><span class="page-tag-item color3 clickable" role="navigation">pki</span><span class="page-tag-item color4 clickable" role="navigation">mTLS</span><!--]--><meta property="keywords" content="vault,token,pki,mTLS"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!----><div class="vp-toc-header">이 페이지에서<button type="button" class="print-button" title="인쇄"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_1-api를-위한-인증과-인가-api-key">1. API를 위한 인증과 인가, API Key</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_2-api-key를-위한-vault-요소">2. API Key를 위한 Vault 요소</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_2-1-vault-token">2.1 Vault Token</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_2-2-vault-token-role">2.2 Vault Token Role</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_2-3-자동화">2.3 자동화</a></li><!----><!--]--></ul></li><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content"><h1 id="api-보안을-위한-vault-활용-api-key" tabindex="-1"><a class="header-anchor" href="#api-보안을-위한-vault-활용-api-key"><span>API 보안을 위한 Vault 활용 (API Key)</span></a></h1><blockquote><p>참고 1: <a href="https://owasp.org/API-Security/editions/2023/en/0x11-t10/" target="_blank" rel="noopener noreferrer">OWASP Top 10 API Securit Risks - 2023</a><br> 참고 2: <a href="https://cf-assets.www.cloudflare.com/slt3lc6tev37/5zfIEoxvRDHLRbkBaLJqsT/c712b0273971194774fc7326b3b1da34/Whitepaper_A-Guide-to-API-Security_Korean_20220622.pdf" target="_blank" rel="noopener noreferrer">Cloudflare API 보안 가이드</a></p></blockquote><p>API는 서로 다른 앱 간 통신을 가능하게 하여 서로 다른 앱, 서로 다른 기업 및 조직 간 데이터 교환으로 더큰 서비스와 다양한 비즈니스를 구성하도록 합니다. 이는 개별 앱이 보유한 다양한 기능과 데이터가 결합되기 때문입니다. API 전략은 엔드유저와 대면하는 서비스와 별개로 앱과 앱 간의 소비하는 모델을 만들기도 합니다.</p><p>데이터와 기능이 호출되면 여기에 비용이 발생함은 물론 데이터의 보안과 접근에 대한 보호가 필요해집니다. 내외부의 API에 대한 공격은 지속적으로 증가하고 있고, 공격자는 API의 취약점을 지속적으로, 그리고 이전보다 더 많이 공격합니다. API의 보안이 설계단계에서 취약하거나 보안을 고려하지 않고 개발하는 경우에는 이후 수많은 API간 통신이 발생하는 중이라 수정에 대한 영향도가 커질 수 있습니다.</p><p>API 보안으로 인해 데이터가 누출되는 사건은 국내외로 지속적으로 발생하고 있습니다.</p><ul><li><a href="https://www.joongang.co.kr/article/25158501#home" target="_blank" rel="noopener noreferrer">(기사)초기 비번 그대로 쓴 LG유플</a></li><li><a href="https://www.businesspost.co.kr/BP?command=article_view&amp;num=333412" target="_blank" rel="noopener noreferrer">(기사)삼성전자 영국 온라인 스토어 고객 정보 유출</a></li><li><a href="https://threatpost.com/facebook-accounts-leaked-check-exposed/165245/" target="_blank" rel="noopener noreferrer">(기사)Facebook Accounts Leaked Online</a></li><li><a href="https://www.vice.com/en/article/wjx3e4/t-mobile-website-allowed-hackers-to-access-your-account-data-with-just-your-phone-number" target="_blank" rel="noopener noreferrer">(기사)T-Mobile Website Allowed Hackers to Access Your Account Data</a></li></ul><p>OWASP에서는 API의 보안위험 상위 10가지를 다음과 같이 정의합니다.</p><table><thead><tr><th>위협</th><th>설명</th></tr></thead><tbody><tr><td>손상된 객체 수준의 권한 부여</td><td>API는 종종 객체 식별자를 처리하는 엔드포인트를 노출시키며, 객체 수준의 액세스 제어 문제의 넓은 공격 표면을 만듭니다. 사용자 ID를 사용하여 데이터 소스에 액세스하는 모든 함수에 권한 확인을 구현하는 것이 중요합니다.</td></tr><tr><td>손상된 인증</td><td>인증 메커니즘을 잘못 구현하면 공격자가 인증 토큰을 침해하거나 다른 사용자의 신원을 일시적 또는 영구적으로 가로챌 수 있습니다. 이는 API 보안을 저해할 수 있습니다.</td></tr><tr><td>손상된 객체 속성 수준의 권한 부여</td><td>이는 과도한 데이터 노출과 대량 할당과 관련된 문제를 결합하며, 객체 속성 수준에서의 권한 검증 부재로 인해 권한이 없는 당사자에 의한 정보 노출 또는 조작이 발생합니다.</td></tr><tr><td>제한 없는 리소스 소비</td><td>API에 대한 성공적인 공격은 네트워크 대역폭, CPU, 메모리 및 저장소와 같은 리소스를 소비하거나, 이메일이나 생체 인증과 같은 기타 리소스를 소비하여 서비스 공급 업체를 통해 제공됩니다. 이는 서비스 거부 또는 운영 비용 증가로 이어질 수 있습니다.</td></tr><tr><td>손상된 함수 수준의 권한 부여</td><td>복잡한 액세스 제어 정책과 관리 및 일반 기능 사이의 명확한 분리 부재로 인해 권한 결함이 발생할 수 있으며, 공격자가 다른 사용자의 리소스 또는 관리 기능에 액세스할 수 있습니다.</td></tr><tr><td>민감한 비즈니스 흐름에 대한 제한 없는 액세스</td><td>이 위험이 있는 API는 비즈니스 흐름을 노출시키며, 자동화된 방식으로 과도하게 사용될 경우 비즈니스에 해를 끼칠 수 있는 기능을 보완하지 않습니다.</td></tr><tr><td>서버 측 요청 위조</td><td>SSRF 결함은 사용자 제공 URI를 유효성 검사하지 않고 원격 리소스를 가져올 때 발생하며, 이를 통해 공격자는 응용 프로그램이 예상치 못한 대상으로 조작된 요청을 보내도록 강제할 수 있습니다.</td></tr><tr><td>보안 구성 오류</td><td>API 및 이를 지원하는 시스템의 복잡한 구성은 종종 무시되거나 안전한 방식으로 구성되지 않을 수 있으며, 이는 다양한 유형의 공격으로 이어질 수 있습니다.</td></tr><tr><td>부적절한 인벤토리 관리</td><td>API는 종종 더 많은 엔드포인트를 노출시키며, 적절하고 최신의 문서 및 호스트 및 배포된 API 버전의 인벤토리 관리가 중요합니다.</td></tr><tr><td>API의 안전하지 않은 사용</td><td>개발자는 사용자 입력보다 제3자 API에서 받은 데이터를 더 신뢰하며, 더 약한 보안 표준을 채택합니다. 공격자는 목표 API를 직접 공격하는 대신 통합된 제3자 서비스를 대상으로하기 때문에 API를 손상시킬 수 있습니다.</td></tr></tbody></table><p>보안 위협에 대해 HashiCorp의 솔루션들이 지원하는 방식은 다음과 같습니다.</p><table><thead><tr><th>솔루션</th><th>설명</th></tr></thead><tbody><tr><td>Vault</td><td>1) API에서 사용되는 인증 메커니즘을 제공하고, 인가에 대한 데이터를 함께 관리하여 통합된 인증/인가를 설계합니다. 2) 발행된 인증 정보는 수명이 짧고 자동화된 갱신 프로세스를 제공합니다. 3) 인증된 앱, 장비간 통신을 위한 인증서 서비스를 제공합니다. 4) 데이터의 암호화 복호화 서비스를 제공합니다.</td></tr><tr><td>Consul</td><td>1) 비즈니스 흐름 및 인벤토리 관리를 정의하여 의도된 API 흐름을 정의합니다. 2) 서비스 메시를 통해 신뢰관계인 서비스 간에 통신할 수 있도록 정의합니다. 3) 서비스 마다 요청에 대한 제한을 적용합니다.</td></tr><tr><td>Terraform</td><td>인프라 보안 구성을 표준화 하고, 보안 정책을 준수하는 인프라 구성을 하도록 돕습니다.</td></tr><tr><td>Nomad</td><td>앱 배포 자동화와 더불어 Consul 연계한 서비스 메시, Vault 연계된 시크릿 자동화를 플랫폼 수준에서 지원 합니다.</td></tr></tbody></table><p>여기서는 Vault의 API 보안에 대한 인증 메커니즘을 설명 합니다.</p><blockquote><p>기타 참고</p><ul><li><a href="https://youtu.be/eFdwlCNLL8s?si=oocJgV8HTXai1gcX" target="_blank" rel="noopener noreferrer">(Consul) 서비스 메시로 트래픽 제어(영상)</a></li><li><a href="https://youtu.be/_TbhKFp2sd4?si=PFh7_SekV40UL7Ax" target="_blank" rel="noopener noreferrer">(Terraform) 센티널, 코드화된 정책 적용 익히기(영상)</a></li><li><a href="https://docmoa.github.io/04-HashiCorp/06-Vault/04-UseCase/mtls.html" target="_blank" rel="noopener noreferrer">(Vault) PKI를 사용하여 mTLS 구성의 인증서 자동화</a></li><li><a href="https://docmoa.github.io/04-HashiCorp/06-Vault/04-UseCase/nomad-integration.html" target="_blank" rel="noopener noreferrer">(Nomad) 플랫폼 수준의 시크릿 자동화 지원</a></li></ul></blockquote><h2 id="_1-api를-위한-인증과-인가-api-key" tabindex="-1"><a class="header-anchor" href="#_1-api를-위한-인증과-인가-api-key"><span>1. API를 위한 인증과 인가, API Key</span></a></h2><p>API로 서비스를 기획하는 경우 요청을 식별하고 적절한 권한을 부여하기 위해 API 키 또는 API 토큰을 사용할 수 있습니다(API Key로 설명합니다). 우리가 이야기하는 클라우드 또한 API로 구성된 인프라와 서비스 덩어리 입니다. 서비스를 사용하고 외부 서비스와 연계하기 위해 클라우드를 비롯 수많은 API 서비스는 식별가능한 인증과 사용에 대한 권한 용도로 <code>API Key</code>을 제공 합니다.</p><figure><img src="/assets/aws-key-DiiBrSjT.png" alt="AWS API 인증을 위한 Key 관리 화면" tabindex="0" loading="lazy"><figcaption>AWS API 인증을 위한 Key 관리 화면</figcaption></figure><p><a href="https://aws.amazon.com/ko/what-is/api-key/" target="_blank" rel="noopener noreferrer">API 키란 무엇인가요?</a> 라는 AWS 문서에 보면 API 키 모범 사례에서 인증과 인가를 위한 <mark>중요한</mark> API 키/토큰에 대해 어떻게 관리해야 하는지 알려줍니다.</p><ul><li>사용자 인증에 API 키를 사용하지 마세요. API 키는 사용자 액세스를 규제하기 위한 것이 아닙니다. 마찬가지로 전송 중에 표시될 수 있으므로 기밀 정보를 API 키에 포함하지 마세요.</li><li>API 키를 소스 코드나 리포지토리에 직접 임베드하지 마세요. 삭제하지 않으면 애플리케이션을 게시할 때 일반에 노출될 수 있습니다.</li><li>API 키를 더 이상 사용하지 않을 때는 삭제하세요. 보다 강력한 API 보안을 위해 키에 만료 시간을 추가하는 것을 고려해 보세요.</li></ul><div class="hint-container tip"><p class="hint-container-title">모범 사례를 정리해보면</p><ol><li>사용자(사람)보다는 앱 인증에 사용하고</li><li>평문의 고정된 값으로 기록하지 않기를 권장하고</li><li>사용하지 않는 경우 삭제하고 만료 시간을 정의해야 합니다.</li></ol></div><p>API 키/토큰이 제공하는 인증 및 인가에 더불어, 위의 모범 사례를 적용하면 OWASP에서 지적한 위협중 다음을 해결할 수 있습니다.</p><ul><li>손상된 객체 수준의 권한 부여</li><li>손상된 인증</li><li>손상된 객체 속성 수준의 권한 부여</li><li>손상된 함수 수준의 권한 부여</li></ul><div class="hint-container caution"><p class="hint-container-title">하지만 다음과 같은 이유로 이같은 모범사례를 직접 구현하기란 어렵습니다.</p><ul><li>기록하지 않는다면 누군가 대신 넣어주거나(Injection) 별도 API 키/토큰 저장소를 두어 가져올 수 있어야 한다. (이때 또 저장소에 대한 인증이 필요하다.)</li><li>삭제에 대한 훈련이 부족하고, 서비스의 끊김 없이 교체할 수 있는 자동화 방안이 필요하다.</li></ul></div><p>API 서비스를 위한 API 키/토큰 발급 및 관리 시스템을 제공하고, 모범사례를 구현하기위해 Vault를 활용할 수 있습니다.</p><h2 id="_2-api-key를-위한-vault-요소" tabindex="-1"><a class="header-anchor" href="#_2-api-key를-위한-vault-요소"><span>2. API Key를 위한 Vault 요소</span></a></h2><p>Vault에는 플랫폼 및 소프트웨어와 인터페이싱하기위해 요구되는 인증 정보를 모범사례에 따라 관리하고 자동화할 수 있도록 다양한 <a href="https://developer.hashicorp.com/vault/docs/secrets" target="_blank" rel="noopener noreferrer">Secret Engine</a>이 준비되어있습니다. 이들 시크릿 요소는 평문으로 저장하지 않고 짧은 수명주기를 갖으며 관리되도록 하는데 중점을 두며, 각각의 플랫폼과 소프트웨어의 특성에 맞춰 정의할 수 있습니다.</p><p>여기서는 준비된 <code>Secret Engine</code>외에 자체 개발되는 API 기반 서비스를 위해 Vault가 갖는 특성을 통해 모범사례를 달성하여 API 보안을 달성하는데 도움이 될만한 요소를 설명합니다.</p><h3 id="_2-1-vault-token" tabindex="-1"><a class="header-anchor" href="#_2-1-vault-token"><span>2.1 Vault Token</span></a></h3><blockquote><p><a href="https://docmoa.github.io/04-HashiCorp/06-Vault/01-Information/vault-token.html" target="_blank" rel="noopener noreferrer">Vault Token의 이해</a></p></blockquote><p><code>Vault Token</code>은 Vault 내에서는 인증 이후의 API 인증/인가를 담당하는 요소입니다. API 키/토큰 요소 및 발급 서비스로서 다음의 특징을 갖습니다.</p><ul><li>영구적이지 않고 생생 시 마다 고유한 값을 갖습니다</li><li>메타 데이터 정의를 통해 사용자가 API 앱을 개발함에 있어 필요한 데이터를 담아 사용자와 권한을 구분하는 용도로도 활용가능합니다.</li><li>Vault Audit Log를 통해 생성 요청을 감사할 수 있습니다.</li><li>손상된 API 키/토큰으로 확인 된 경우 강제 만료(Revoke)</li><li><code>token_bound_cidrs</code> 옵션을 통해 Vault Token에 대해 검증 요청이 가능하(사용) 네트워크 CIDR 대역을 지장할 수 있습니다.</li><li>Vault Sentinel 기능을 통해 발급 요청에 대한 옵션값 정책을 정의할 수 있습니다.</li><li>Vault Rate Limit 기능과 Quota를 사용하여 Vault Token 발급 및 검증에 호출 건수를 제한할 수 있습니다.</li><li>Vault Performance Replication 기능을 사용하여 다수의 클러스터 환경에서 동일한 구성을 중앙 관리합니다.</li><li>Vault Disaster Recovery 기능을 사용하여 Vault 장애시 전환을 통해 기존 발급된 Vault Token 내역을 복구할 수 있습니다.</li></ul><p><code>API 키 관리 서비스</code>로서의 Vault는 분산 및 클라우드 환경에서 관리를 담당하는 요소를 격리 및 가용성을 확보할 수 있습니다.</p><figure><img src="/assets/vault-api-key-as-a-service-mI8jiCP6.png" alt="Vault API Key as a Service" tabindex="0" loading="lazy"><figcaption>Vault API Key as a Service</figcaption></figure><p>Token을 생성하는 CLI를 다음과 같이 실행하여 출력된 결과를 확인해봅니다.</p><details class="hint-container details"><summary>Vault Dev 모드로 실행</summary><p><a href="https://developer.hashicorp.com/vault/install?product_intent=vault" target="_blank" rel="noopener noreferrer">Vault Download 안내 링크</a></p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line"><span class="token comment"># 서버 실행</span></span>
<span class="line">vault server <span class="token parameter variable">-dev</span> -dev-root-token-id<span class="token operator">=</span>root</span>
<span class="line"></span></code></pre></div><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line"><span class="token comment"># Dev용 ROOT Token</span></span>
<span class="line"><span class="token assign-left variable">VAULT_TOKEN</span><span class="token operator">=</span>root</span>
<span class="line"></span></code></pre></div></details><div class="language-json" data-highlighter="prismjs" data-ext="json" data-title="json"><pre class="language-json"><code><span class="line">$ vault token create -format=json \</span>
<span class="line">  -policy=default \</span>
<span class="line">  -ttl=<span class="token number">30</span> \</span>
<span class="line">  -metadata=type=api-admin \</span>
<span class="line">  -orphan=<span class="token boolean">true</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;request_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;8e2a416d-5587-90d1-68bd-d930a2005442&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;lease_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;lease_duration&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;renewable&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;warnings&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;auth&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line highlighted">    <span class="token property">&quot;client_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;hvs.CAESIJz-I42G1S4nWalCu3yrKwV63FW-3wKV4H****&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;accessor&quot;</span><span class="token operator">:</span> <span class="token string">&quot;JOmunQGBUBgC4gaYzOt3gL8k&quot;</span><span class="token punctuation">,</span></span>
<span class="line highlighted">    <span class="token property">&quot;policies&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token string">&quot;default&quot;</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;token_policies&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token string">&quot;default&quot;</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;identity_policies&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span></span>
<span class="line highlighted">    <span class="token property">&quot;metadata&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line highlighted">      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;api-admin&quot;</span></span>
<span class="line highlighted">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;orphan&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;entity_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span></span>
<span class="line highlighted">    <span class="token property">&quot;lease_duration&quot;</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;renewable&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;mfa_requirement&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre></div><p>API 키/토큰 요소로 활용되는 Vault Token의 요소와 특성은 다음과 같습니다.</p><table><thead><tr><th>요소</th><th>특성</th></tr></thead><tbody><tr><td>auth.client_token</td><td>발생된 고유 API 키/토큰으로 활용합니다. 발급 시마다 고유한 값을 갖습니다.</td></tr><tr><td>auth.policies</td><td><code>default</code> 정책은 해당 토큰으로 Vault내에서 자기 자신의 상태 및 정보를 확인할 수 있는 권한을 부여 합니다.</td></tr><tr><td>auth.metadata</td><td>API 키/토큰을 구분할 메타데이터로 활용됩니다. 사용자 식별 데이터를 저장하거나 권한에 대해 정의할 수 있습니다.</td></tr><tr><td>auth.lease_duration</td><td>발생된 토큰의 유효 기간을 나타냅니다.</td></tr></tbody></table><p>검증을 위한 절차로 Token(auth.client_token 값)을 조회한 경우 정상인 경우 다음의 결과를 확인할 수 있습니다.</p><div class="language-json" data-highlighter="prismjs" data-ext="json" data-title="json"><pre class="language-json"><code><span class="line">$ vault token lookup -format=json hvs.CAESIFIvewF8ayV-6Qe_YYtrYjnFRUJaMXHOOHNuo23****</span>
<span class="line"></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;request_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;8d7af9d6-5af4-8f30-da8d-3bcfd3f10d44&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;lease_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;lease_duration&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;renewable&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;accessor&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1tn5yr9Ybadum7I1EIirgaBN&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;creation_time&quot;</span><span class="token operator">:</span> <span class="token number">1710836854</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;creation_ttl&quot;</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;display_name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;token&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;entity_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;expire_time&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2024-03-19T17:28:04.530353+09:00&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;explicit_max_ttl&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;hvs.CAESIFIvewF8ayV-6Qe_YYtrYjnFRUJaMXHOOHNuo23****&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;issue_time&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2024-03-19T17:27:34.530355+09:00&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;meta&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;api-admin&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;num_uses&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;orphan&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;auth/token/create&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;policies&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token string">&quot;default&quot;</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;renewable&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;ttl&quot;</span><span class="token operator">:</span> <span class="token number">26</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;service&quot;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;warnings&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre></div><p>Vault Token의 TTL이 만료된 경우 Vault 내에서 이미 Token이 만료처리(Revoke) 되므로 권한없음의 에러를 반환 합니다.</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ vault token lookup <span class="token parameter variable">-format</span><span class="token operator">=</span>json hvs.CAESIFIvewF8ayV-6Qe_YYtrYjnFRUJaMXHOOHNuo23****</span>
<span class="line">Error looking up token: Error making API request.</span>
<span class="line"></span>
<span class="line">URL: POST http://127.0.0.1:8200/v1/auth/token/lookup</span>
<span class="line">Code: <span class="token number">403</span>. Errors:</span>
<span class="line"></span>
<span class="line">* bad token</span>
<span class="line"></span></code></pre></div><h3 id="_2-2-vault-token-role" tabindex="-1"><a class="header-anchor" href="#_2-2-vault-token-role"><span>2.2 Vault Token Role</span></a></h3><p>Cloud 서비스, IAM, 인증 서비스 등을 다뤄본 사용자라면 정책(policy)과 역할(role)에 대한 개념을 지속적으로 접하게 됩니다. 역할은 다수의 정책이 부여된 권한 템플릿이라 볼 수도 있습니다.</p><table><thead><tr><th>용어</th><th>설명</th></tr></thead><tbody><tr><td>정책(Policy)</td><td>리소스에 대한 사용 권한을 정의합니다.</td></tr><tr><td>역할(Role)</td><td>Identity 요소로, 정책이 부여된 대상으로, 다수의 정책을 갖습니다.</td></tr></tbody></table><p>앞서 <a href="#21-vault-token">2.1 Vault Token</a>에서 정의되는 Vault Token은 발급 할 때마다 수명(TTL)과 메타데이터 등의 옵션을 항상 지정해야 하는 반면, Vault Token Role을 정의하면 미리 설정된 값으로 매번 같은 조건의 Vault Token이 생성되게 됩니다.</p><p>다음과 같이 역할을 정의할 수 있습니다.</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">vault <span class="token function">write</span> /auth/token/roles/api-admin <span class="token punctuation">\</span></span>
<span class="line">  <span class="token assign-left variable">orphan</span><span class="token operator">=</span>true <span class="token punctuation">\</span></span>
<span class="line">  <span class="token assign-left variable">token_explicit_max_ttl</span><span class="token operator">=</span><span class="token number">30</span> <span class="token punctuation">\</span></span>
<span class="line">  <span class="token assign-left variable">token_period</span><span class="token operator">=</span><span class="token number">30</span> <span class="token punctuation">\</span></span>
<span class="line">  <span class="token assign-left variable">token_type</span><span class="token operator">=</span>service <span class="token punctuation">\</span></span>
<span class="line">  <span class="token assign-left variable">allowed_policies</span><span class="token operator">=</span>default <span class="token punctuation">\</span></span>
<span class="line">  <span class="token assign-left variable">disallowed_policies</span><span class="token operator">=</span>root</span>
<span class="line"></span></code></pre></div><p>정의된 <code>api-admin</code> 역할을 지정하여 Vault Token을 생성합니다. (<code>metadata</code>는 생성시 넣어주는 값으로 미리 역할에 지정할 수는 없습니다.)</p><div class="language-json" data-highlighter="prismjs" data-ext="json" data-title="json"><pre class="language-json"><code><span class="line">$ vault token create -format=json -role=api-admin -metadata=foo=bar</span>
<span class="line"></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;request_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;f09c2ed5-00d9-50d1-125d-c11422aa688f&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;lease_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;lease_duration&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;renewable&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;warnings&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;auth&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;client_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;hvs.CAESIKuBuHgqkFZ3IIuY80JzQq5kGci-9Jd2Xix****&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;accessor&quot;</span><span class="token operator">:</span> <span class="token string">&quot;asIKCp1Wtyb0VdzjPHEvN4EE&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;policies&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token string">&quot;default&quot;</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;token_policies&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token string">&quot;default&quot;</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;identity_policies&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;metadata&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;foo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bar&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;orphan&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;entity_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;lease_duration&quot;</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;renewable&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;mfa_requirement&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre></div><p>앞서 Vault Token을 직접 생성하는 것과의 차이는 대부분의 옵션(수명주기, 독립된 Token 여부, 불필요한 Vault의 정책 부여 막기)이 미리 선언 되었다는 점과, 역할 고유의 값이 조회시 확인됩니다.</p><div class="language-json" data-highlighter="prismjs" data-ext="json" data-title="json"><pre class="language-json"><code><span class="line">$ vault token lookup -format=json hvs.CAESIKuBuHgqkFZ3IIuY80JzQq5kGci-9Jd2X****</span>
<span class="line"></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;request_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;809a0395-b33c-ebf1-9ff4-f98a984d2ba8&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;lease_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;lease_duration&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;renewable&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;accessor&quot;</span><span class="token operator">:</span> <span class="token string">&quot;asIKCp1Wtyb0VdzjPHEvN4EE&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;creation_time&quot;</span><span class="token operator">:</span> <span class="token number">1710837749</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;creation_ttl&quot;</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;display_name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;token&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;entity_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;expire_time&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2024-03-19T17:42:59.684424+09:00&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;explicit_max_ttl&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;hvs.CAESIKuBuHgqkFZ3IIuY80JzQq5kGci-9Jd2Xix2****&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;issue_time&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2024-03-19T17:42:29.684426+09:00&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;meta&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;foo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bar&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;num_uses&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;orphan&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line highlighted">    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;auth/token/create/api-admin&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;policies&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token string">&quot;default&quot;</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;renewable&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line highlighted">    <span class="token property">&quot;role&quot;</span><span class="token operator">:</span> <span class="token string">&quot;api-admin&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;ttl&quot;</span><span class="token operator">:</span> <span class="token number">26</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;service&quot;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;warnings&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre></div><p><code>role</code> 항목이 추가되어 해당 토큰이 어떤 역할로 부터 생성되었는지 확인 가능합니다. 앱에서는 이런 역할 값을 조회하여 내부적으로 권한 부여를 추가할 수 있습니다.</p><h3 id="_2-3-자동화" tabindex="-1"><a class="header-anchor" href="#_2-3-자동화"><span>2.3 자동화</span></a></h3><p>Vault Token이 제공하는 API Key에 수명주기 기능은 모범사례인 비영구성을 만족하나, 이경우 자동화가 뒷받침되어야 합니다. 앱 및 API를 호출하는 외부 서비스는 API Key를 수명주기 만료 전에 갱신할 수 있어야 합니다. 앱으로 개발되는 경우 개발 로직에 자동화 행위를 추가할 수 있지만, 정적인 파일이나 구성에 존재해야 하는 경우 분산된 서비스 수만큼의 수작업이 발생할 수 있습니다.</p><div class="hint-container tip"><p class="hint-container-title">자동화의 핵심은 인증!</p><p>API Key를 요청하는 대상 또한 믿을 수 있는 대상이여야 합니다. 기존 클라우드 서비스 또는 SaaS 서비스에서 API Key를 생성하는 경우, 관리자인 사람이 어떤 방식(ID/PW, OIDC 등)을 통해 믿을 수 있는 사용자인지 인증 한뒤 API Key를 생성하였습니다. 이같은 수동 작업을 자동화하려면 API Key를 사용하려는 대상이 직접 인증 방식을 통해 API Key를 발급 및 갱신할 수 있어야 합니다.</p></div><p>Vault는 다음의 기전을 사용하여 모범사례를 준수하면서 자동화가능한 방안을 제공합니다. 기본 구조와 행위의 순서는 다음과 같습니다.</p><figure><img src="/assets/api-key-default-architecture-BapFQ2nW.png" alt="API Token Service Default Architecture" tabindex="0" loading="lazy"><figcaption>API Token Service Default Architecture</figcaption></figure><ol><li>API Token이 필요한 서비스는 Token을 요청할 수 있는 권한이 있음을 인증받아야 합니다.</li><li>Token 발급을 담당하는 Vault로 직접 접속하기 보다 제한된 기능만 수행하는 <code>Vault Proxy</code>를 통해 요청합니다.</li><li>인증이 통과하면 <code>Vault Proxy</code>는 Vault 서버로부터 Token을 생성하고, 요청한 서비스로 반환 합니다.</li><li>서비스는 Token을 API 요청에 담아 API 서비스로 요청합니다.</li><li>API 서비스는 전달받은 API Token을 Vault 서버에 검증하고 부여된 권한을 확인하여 응답합니다.</li></ol><h4 id="🚀-자동화-방안-1-앱에서-인증과-token-발급-처리" tabindex="-1"><a class="header-anchor" href="#🚀-자동화-방안-1-앱에서-인증과-token-발급-처리"><span>🚀 [자동화 방안 1] 앱에서 인증과 Token 발급 처리</span></a></h4><p>개발되는 앱은 Vault의 다양한 인증 방식들을 사용하여 신뢰할 수 있는 앱임을 증명할 수 있습니다. 앱이 독자적으로 Vault에 인증 받는데 가장 많이 사용되는 수단은 AppRole 방식 입니다.</p><blockquote><p>참고 : <a href="https://docmoa.github.io/04-HashiCorp/06-Vault/04-UseCase/spring-boot.html" target="_blank" rel="noopener noreferrer">Vault로 Spring Boot 구성관리</a></p></blockquote><ul><li>CICD 도구는 Vault와 상호 인증됩니다.</li><li>배포 파이프라인상에서 Vault AppRole의 인증 정보(App ID, Secret ID)를 획득합니다.</li><li>앱이 배포될 때 AppRole 인증정보로 Vault Proxy에 인증 받습니다.</li><li>앱은 Vault Proxy로 API 요청에 필요한 API Key(Token)를 Vault Token Role 기반으로 발급 받습니다.</li></ul><figure><img src="/assets/api-key-automation-1-Dg3vr5DR.png" alt="API Key 자동화 - 앱 자체 인증 및 인가" tabindex="0" loading="lazy"><figcaption>API Key 자동화 - 앱 자체 인증 및 인가</figcaption></figure><h4 id="🚀-자동화-방안-2-mtls를-이용하여-네트워크-인증-처리" tabindex="-1"><a class="header-anchor" href="#🚀-자동화-방안-2-mtls를-이용하여-네트워크-인증-처리"><span>🚀 [자동화 방안 2] mTLS를 이용하여 네트워크 인증 처리</span></a></h4><p>mTLS(Mutual TLS)는 네트워크 연결 시 상호간 인증서를 검증하여 신뢰할 수 있는 네트워킹을 가능하게 합니다. Vault Proxy로의 접속이 가능하려면 앱은 인증서를 기반으로 해당 앱/장치가 신뢰할 수 있음을 증명 합니다. 이경우 Vault Proxy가 Vault 서버로 미리 인증을 받기 때문에 API Key를 요청하는 서비스는 요청하는 Vault Token Role 이름만 알면 됩니다. 주로 Public 네트워크를 통해 들어오는 요청을 처리하는 ATM기, POS기, IoT 등 장치에 대한 인증에 활용됩니다.</p><p>인증서 또한 유효기간이 있으므로, 인증서 교체를 자동화 하기 위해서는 <a href="#%EC%9E%90%EB%8F%99%ED%99%94-%EB%B0%A9%EC%95%88-3-vault-agent%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EC%9E%90%EB%8F%99%ED%99%94-%EC%9C%84%EC%9E%84">방안 3</a>에서 활용하는 <code>Vault Agent</code>를 활용할 수 있습니다.</p><blockquote><p>참고 : <a href="https://docmoa.github.io/04-HashiCorp/06-Vault/04-UseCase/mtls.html" target="_blank" rel="noopener noreferrer">mTLS 를 사용한 상호간 인증</a><br> 사례 : <a href="https://www.hashicorp.com/resources/starbucks-secrets-at-the-retail-edge-with-hashicorp-vault" target="_blank" rel="noopener noreferrer">Starbucks</a></p></blockquote><figure><img src="/assets/api-key-automation-2-BCD4lBXi.png" alt="API Key 자동화 - mTLS를 통한 인증" tabindex="0" loading="lazy"><figcaption>API Key 자동화 - mTLS를 통한 인증</figcaption></figure><ul><li>최초 배포 시 유효한 인증서를 함께 배포 합니다.</li><li>API Key를 요청하는 서비스는 Vault Proxy로의 mTLS로 상호한 보안네트워크를 구성합니다.</li><li>API Key를 요청하는 서비스는 Vault Token Role 기반으로 API Key(Token)를 요청합니다.</li></ul><h4 id="🚀-자동화-방안-3-vault-agent를-이용한-자동화-위임" tabindex="-1"><a class="header-anchor" href="#🚀-자동화-방안-3-vault-agent를-이용한-자동화-위임"><span>🚀 [자동화 방안 3] Vault Agent를 이용한 자동화 위임</span></a></h4><p>API Key를 요구하는 대상 서비스가 외부에 별도 구성되거나, 독립된 시스템, 또는 [방안 1](#자동화-방안-1-앱에서-인증과-token-발급-처리)과 <a href="#%EC%9E%90%EB%8F%99%ED%99%94-%EB%B0%A9%EC%95%88-2-mtls%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%98%EC%97%AC-%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-%EC%9D%B8%EC%A6%9D-%EC%B2%98%EB%A6%AC">방안 2</a>로 해결이 불가능한 경우 대상 시스템에 인증 및 발급 후 처리를 담당하는 <code>Vault Agent</code>를 구성할 수 있습니다. <code>Vault Agent</code>는 앱/사람 대신 1) Vault에 인증하고 2) Token을 발급 및 갱신하고 3) 필요시 파일로 저장히고 4) 추가적인 작업을 실행할 수 있는 도구 입니다.</p><blockquote><p>참고 : <a href="https://docmoa.github.io/04-HashiCorp/06-Vault/02-Secret_Engine/pki-nginx.html" target="_blank" rel="noopener noreferrer">Vault Agent를 사용한 인증서 교체</a></p></blockquote><figure><img src="/assets/api-key-automation-3-Dumipc_0.png" alt="API Key 자동화 - Vault Agent 활용" tabindex="0" loading="lazy"><figcaption>API Key 자동화 - Vault Agent 활용</figcaption></figure><ul><li>API를 요청하는 앱이 구성되어있는 인프라에 Vault Agent를 구성합니다.</li><li>Vault Agent가 Vault Proxy(또는 Server) 인증 및 인가 합니다.</li><li>API Key를 획득하려는 앱은 Vault Agent를 통해 API Key를 요청하거나, Vault Agent가 생성해주는 파일을 읽어 API Key를 획득 합니다.</li></ul><details class="hint-container details"><summary>Vault Agent로 Token 발급/갱신 테스트</summary><p>Vault Agent의 Token생성 권한을 정의하는 <code>admin-role-token-create.hcl</code> 정책 정의 파일을 생성합니다.</p><div class="language-hcl" data-highlighter="prismjs" data-ext="hcl" data-title="admin-role-token-create.hcl"><pre class="language-hcl"><code><span class="line">path <span class="token string">&quot;auth/token/create/api-admin&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">capabilities</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;create&quot;</span>, <span class="token string">&quot;update&quot;</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">path <span class="token string">&quot;auth/token/lookup-self&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">capabilities</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;read&quot;</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre></div><p>정책을 생성합니다.</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">vault policy <span class="token function">write</span> admin-role-token-create admin-role-token-create.hcl</span>
<span class="line"></span></code></pre></div><p>Vault Agent는 <code>admin-role-token-create</code> 정책의 권한이 있는 인증 수단이면 됩니다. 다양한 방식을 지원하고, 여기서는 단순하게 Token을 생성하여 권한을 부여합니다.</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">vault token create <span class="token parameter variable">-field</span><span class="token operator">=</span>token <span class="token parameter variable">-policy</span><span class="token operator">=</span>admin-role-token-create -no-default-policy <span class="token operator">&gt;</span> vault-token</span>
<span class="line"></span></code></pre></div><p>API Key를 파일로 랜더링하기위한 <code>token.tpl</code> 템플릿 파일의 예는 다음과 같습니다.</p><div class="language-hcl" data-highlighter="prismjs" data-ext="hcl" data-title="token.tpl"><pre class="language-hcl"><code><span class="line"><span class="token punctuation">{</span><span class="token punctuation">{</span>- with secret <span class="token string">&quot;auth/token/create/api-admin&quot;</span> <span class="token string">&quot;meta=foo=bar&quot;</span> -<span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">{</span><span class="token punctuation">{</span> .Auth.ClientToken <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">{</span><span class="token punctuation">{</span>- end <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre></div><p>다음으로 Vault Agent의 동작을 확인하기 위한 <code>config.hcl</code>은 다음과 같습니다.</p><div class="language-hcl line-numbers-mode" data-highlighter="prismjs" data-ext="hcl" data-title="config.hcl"><pre class="language-hcl"><code><span class="line"><span class="token property">pid_file</span> <span class="token punctuation">=</span> <span class="token string">&quot;./pidfile&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">vault</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">address</span> <span class="token punctuation">=</span> <span class="token string">&quot;http://127.0.0.1:8200&quot;</span></span>
<span class="line">  <span class="token keyword">retry</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">num_retries</span> <span class="token punctuation">=</span> <span class="token number">3</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">auto_auth</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">method</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">type</span> <span class="token punctuation">=</span> <span class="token string">&quot;token_file&quot;</span></span>
<span class="line"></span>
<span class="line">    <span class="token property">config</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span></span>
<span class="line highlighted">      <span class="token property">token_file_path</span> <span class="token punctuation">=</span> <span class="token string">&quot;vault-token&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line highlighted"><span class="token keyword">template</span> <span class="token punctuation">{</span></span>
<span class="line highlighted">  <span class="token property">source</span> <span class="token punctuation">=</span> <span class="token string">&quot;./token.tpl&quot;</span></span>
<span class="line highlighted">  <span class="token property">destination</span> <span class="token punctuation">=</span> <span class="token string">&quot;./template.txt&quot;</span></span>
<span class="line highlighted">  <span class="token property">command</span> <span class="token punctuation">=</span> <span class="token string">&quot;VAULT_TOKEN=$(cat template.txt) vault token lookup&quot;</span></span>
<span class="line highlighted"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>token_file_path</code>는 앞서 생성한 Vault Agent 인증/인가를 위해 생성한 Token이 저장되어 있습니다.</li><li><code>template</code>에 동적으로 생성할 정의가 되어있습니다. <ul><li><code>token.tpl</code>에 정의된 Vault에서 Token 생성 후 저장되는 정보는 <code>template.txt</code>에 저장됩니다.</li><li>후속 작업에 대한 정의로 Token을 검증하는 커맨드를 실행합니다.</li></ul></li></ul><p>다음의 명령어로 Vault Agent를 실행합니다.</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">vault agent <span class="token parameter variable">-config</span><span class="token operator">=</span>./config.hcl</span>
<span class="line"></span></code></pre></div><p>실행 후 Token을 새로 생성한 결과와, 잠시 후 Token의 TTL이 만료되면, 다시 갱신하는 로그를 확인할 수 있습니다.</p><div class="language-log line-numbers-mode" data-highlighter="prismjs" data-ext="log" data-title="log"><pre class="language-log"><code><span class="line"><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">&gt;</span> Vault Agent started<span class="token operator">!</span> Log data will stream in below<span class="token operator">:</span></span>
<span class="line"></span>
<span class="line"><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">&gt;</span> Vault Agent configuration<span class="token operator">:</span></span>
<span class="line"></span>
<span class="line">           <span class="token property">Api Address 1:</span> <span class="token url">http://bufconn</span></span>
<span class="line">                     <span class="token property">Cgo:</span> disabled</span>
<span class="line">               <span class="token property">Log Level:</span> </span>
<span class="line">                 <span class="token property">Version:</span> Vault <span class="token number">v1.15.6</span><span class="token punctuation">,</span> built <span class="token date number">2024-02-28T</span><span class="token time number">17:07:34Z</span></span>
<span class="line">             <span class="token property">Version Sha:</span> <span class="token number">615cf6f1dce9aa91bc2035ce33b9f689952218f0</span></span>
<span class="line"></span>
<span class="line"><span class="token date number">2024-03-19T</span><span class="token time number">21:47:39.977+0900</span> <span class="token punctuation">[</span><span class="token level info keyword">INFO</span><span class="token punctuation">]</span>  <span class="token property">agent.exec.server:</span> starting exec server</span>
<span class="line"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line"><span class="token date number">2024-03-19T</span><span class="token time number">21:47:39.979+0900</span> <span class="token punctuation">[</span><span class="token level info keyword">INFO</span><span class="token punctuation">]</span>  <span class="token property">agent:</span> <span class="token operator">(</span>runner<span class="token operator">)</span> starting</span>
<span class="line"><span class="token date number">2024-03-19T</span><span class="token time number">21:47:39.986+0900</span> <span class="token punctuation">[</span><span class="token level info keyword">INFO</span><span class="token punctuation">]</span>  <span class="token property">agent:</span> <span class="token operator">(</span>runner<span class="token operator">)</span> rendered <span class="token string">&quot;./token.tpl&quot;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;./template.txt&quot;</span></span>
<span class="line"><span class="token date number">2024-03-19T</span><span class="token time number">21:47:39.986+0900</span> <span class="token punctuation">[</span><span class="token level info keyword">INFO</span><span class="token punctuation">]</span>  <span class="token property">agent:</span> <span class="token operator">(</span>runner<span class="token operator">)</span> executing command <span class="token string">&quot;[\&quot;VAULT_TOKEN=$(cat template.txt) vault token lookup\&quot;]&quot;</span> from <span class="token string">&quot;./token.tpl&quot;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;./template.txt&quot;</span></span>
<span class="line"><span class="token date number">2024-03-19T</span><span class="token time number">21:47:39.986+0900</span> <span class="token punctuation">[</span><span class="token level info keyword">INFO</span><span class="token punctuation">]</span>  <span class="token property">agent:</span> <span class="token operator">(</span>child<span class="token operator">)</span> spawning<span class="token operator">:</span> sh <span class="token operator">-</span>c VAULT_TOKEN<span class="token operator">=</span><span class="token operator">$</span><span class="token operator">(</span>cat template<span class="token punctuation">.</span>txt<span class="token operator">)</span> vault token lookup</span>
<span class="line">Key                  Value</span>
<span class="line"><span class="token separator comment">---</span>                  <span class="token separator comment">-----</span></span>
<span class="line">accessor             QL767YYmSy31S7c9p6ahuyMH</span>
<span class="line">creation_time        <span class="token number">1710852459</span></span>
<span class="line">creation_ttl         <span class="token number">30s</span></span>
<span class="line">display_name         token</span>
<span class="line">entity_id            n<span class="token operator">/</span>a</span>
<span class="line">expire_time          <span class="token date number">2024-03-19T</span><span class="token time number">21:48:09.983135+09:00</span></span>
<span class="line">explicit_max_ttl     <span class="token number">0s</span></span>
<span class="line">id                   hvs<span class="token punctuation">.</span>CAESIFPtfDQGPlyDzkA5wmCkU5A5XmhhJX4Gh4KHGh<span class="token separator comment">****</span></span>
<span class="line">issue_time           <span class="token date number">2024-03-19T</span><span class="token time number">21:47:39.982003+09:00</span></span>
<span class="line">last_renewal         <span class="token date number">2024-03-19T</span><span class="token time number">21:47:39.983135+09:00</span></span>
<span class="line">last_renewal_time    <span class="token number">1710852459</span></span>
<span class="line">meta                 map<span class="token punctuation">[</span>foo<span class="token operator">:</span>bar<span class="token punctuation">]</span></span>
<span class="line">num_uses             <span class="token number">0</span></span>
<span class="line">orphan               <span class="token boolean">true</span></span>
<span class="line">path                 auth<span class="token operator">/</span>token<span class="token operator">/</span>create<span class="token operator">/</span>api<span class="token operator">-</span>admin</span>
<span class="line">policies             <span class="token punctuation">[</span>default<span class="token punctuation">]</span></span>
<span class="line">renewable            <span class="token boolean">true</span></span>
<span class="line">role                 api<span class="token operator">-</span>admin</span>
<span class="line">ttl                  <span class="token number">29s</span></span>
<span class="line">type                 service</span>
<span class="line"><span class="token date number">2024-03-19T</span><span class="token time number">21:48:01.901+0900</span> <span class="token punctuation">[</span><span class="token level warning important">WARN</span><span class="token punctuation">]</span>  <span class="token property">agent:</span> vault<span class="token punctuation">.</span>write<span class="token operator">(</span>auth<span class="token operator">/</span>token<span class="token operator">/</span>create<span class="token operator">/</span>api<span class="token operator">-</span>admin <span class="token operator">-</span><span class="token operator">&gt;</span> dafc7ee0<span class="token operator">)</span><span class="token operator">:</span> TTL of <span class="token string">&quot;30s&quot;</span> exceeded the effective max_ttl of <span class="token string">&quot;8s&quot;</span><span class="token operator">;</span> TTL value is capped accordingly</span>
<span class="line"><span class="token date number">2024-03-19T</span><span class="token time number">21:48:01.901+0900</span> <span class="token punctuation">[</span><span class="token level warning important">WARN</span><span class="token punctuation">]</span>  <span class="token property">agent:</span> vault<span class="token punctuation">.</span>write<span class="token operator">(</span>auth<span class="token operator">/</span>token<span class="token operator">/</span>create<span class="token operator">/</span>api<span class="token operator">-</span>admin <span class="token operator">-</span><span class="token operator">&gt;</span> dafc7ee0<span class="token operator">)</span><span class="token operator">:</span> renewer done <span class="token operator">(</span>maybe the lease expired<span class="token operator">)</span></span>
<span class="line"><span class="token date number">2024-03-19T</span><span class="token time number">21:48:01.905+0900</span> <span class="token punctuation">[</span><span class="token level info keyword">INFO</span><span class="token punctuation">]</span>  <span class="token property">agent:</span> <span class="token operator">(</span>runner<span class="token operator">)</span> rendered <span class="token string">&quot;./token.tpl&quot;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;./template.txt&quot;</span></span>
<span class="line"><span class="token date number">2024-03-19T</span><span class="token time number">21:48:01.905+0900</span> <span class="token punctuation">[</span><span class="token level info keyword">INFO</span><span class="token punctuation">]</span>  <span class="token property">agent:</span> <span class="token operator">(</span>runner<span class="token operator">)</span> executing command <span class="token string">&quot;[\&quot;VAULT_TOKEN=$(cat template.txt) vault token lookup\&quot;]&quot;</span> from <span class="token string">&quot;./token.tpl&quot;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;./template.txt&quot;</span></span>
<span class="line"><span class="token date number">2024-03-19T</span><span class="token time number">21:48:01.905+0900</span> <span class="token punctuation">[</span><span class="token level info keyword">INFO</span><span class="token punctuation">]</span>  <span class="token property">agent:</span> <span class="token operator">(</span>child<span class="token operator">)</span> spawning<span class="token operator">:</span> sh <span class="token operator">-</span>c VAULT_TOKEN<span class="token operator">=</span><span class="token operator">$</span><span class="token operator">(</span>cat template<span class="token punctuation">.</span>txt<span class="token operator">)</span> vault token lookup</span>
<span class="line">Key                  Value</span>
<span class="line"><span class="token separator comment">---</span>                  <span class="token separator comment">-----</span></span>
<span class="line">accessor             RqB3ArHnIIYbjDWSQni7gTx2</span>
<span class="line">creation_time        <span class="token number">1710852481</span></span>
<span class="line">creation_ttl         <span class="token number">30s</span></span>
<span class="line">display_name         token</span>
<span class="line">entity_id            n<span class="token operator">/</span>a</span>
<span class="line">expire_time          <span class="token date number">2024-03-19T</span><span class="token time number">21:48:31.902519+09:00</span></span>
<span class="line">explicit_max_ttl     <span class="token number">0s</span></span>
<span class="line">id                   hvs<span class="token punctuation">.</span>CAESIHr<span class="token operator">-</span>v_t37t0twlNhOhTTj3PyYzhtHQrDYvV1SLuhV<span class="token separator comment">****</span></span>
<span class="line">issue_time           <span class="token date number">2024-03-19T</span><span class="token time number">21:48:01.902053+09:00</span></span>
<span class="line">last_renewal         <span class="token date number">2024-03-19T</span><span class="token time number">21:48:01.902519+09:00</span></span>
<span class="line">last_renewal_time    <span class="token number">1710852481</span></span>
<span class="line">meta                 map<span class="token punctuation">[</span>foo<span class="token operator">:</span>bar<span class="token punctuation">]</span></span>
<span class="line">num_uses             <span class="token number">0</span></span>
<span class="line">orphan               <span class="token boolean">true</span></span>
<span class="line">path                 auth<span class="token operator">/</span>token<span class="token operator">/</span>create<span class="token operator">/</span>api<span class="token operator">-</span>admin</span>
<span class="line">policies             <span class="token punctuation">[</span>default<span class="token punctuation">]</span></span>
<span class="line">renewable            <span class="token boolean">true</span></span>
<span class="line">role                 api<span class="token operator">-</span>admin</span>
<span class="line">ttl                  <span class="token number">29s</span></span>
<span class="line">type                 service</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><h4 id="🚀-자동화-방안-4-플랫폼-수준에서의-자동화" tabindex="-1"><a class="header-anchor" href="#🚀-자동화-방안-4-플랫폼-수준에서의-자동화"><span>🚀 [자동화 방안 4] 플랫폼 수준에서의 자동화</span></a></h4><p>API Key 발급과 갱신을 플랫폼 수준에서 자동화 할 수 있습니다. HashiCorp의 Nomad나 Kubernetes같은 오케스트레이터 수준에서 Vault와 통합되고, 생성되는 Token을 Secret 리소스로 갱신할 수 있습니다.</p><blockquote><p>참고 : <a href="https://docmoa.github.io/04-HashiCorp/06-Vault/04-UseCase/nomad-integration.html" target="_blank" rel="noopener noreferrer">Integrate Nomad</a><br> 참고 : <a href="https://docmoa.github.io/04-HashiCorp/06-Vault/04-UseCase/vault-k8s-usecase-csi-injection.html#_3-vso-vault-secret-operator" target="_blank" rel="noopener noreferrer">Integrate Kubernetes</a></p></blockquote><figure><img src="/assets/api-key-automation-4-BAXCDtQ3.png" alt="API Key 자동화 - 플랫폼 수준" tabindex="0" loading="lazy"><figcaption>API Key 자동화 - 플랫폼 수준</figcaption></figure><p>Kubernetes의 경우 VSO는 Secret만을 지원하기 때문에 Auth 유형인 Token인 경우 Sidecar injector 방식으로 연동합니다.</p><details class="hint-container details"><summary>Kubernetes 예제</summary><p>먼저 Vault Helm 차트를 등록합니다.</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">helm repo <span class="token function">add</span> hashicorp https://helm.releases.hashicorp.com</span>
<span class="line"></span></code></pre></div><p>Vault가 Kubernetes 외부에 있다는 가정하에 다음과 같이 설치 합니다. <code>global.externalVaultAddr</code>는 Kubernetes상에서 연동가능한 외부 Vault 주소 입니다.</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">helm <span class="token function">install</span> vault hashicorp/vault <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--set</span> <span class="token string">&quot;global.externalVaultAddr=<span class="token variable">$EXTERNAL_VAULT_ADDR</span>&quot;</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token parameter variable">--set</span> <span class="token string">&quot;injector.enabled=true&quot;</span></span>
<span class="line"></span></code></pre></div><p>정상적으로 설치되면 <code>vault-agent-injector-*</code> Pod를 확인할 수 있습니다.</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ kubectl get pods</span>
<span class="line"></span>
<span class="line">NAME                                    READY   STATUS    RESTARTS   AGE</span>
<span class="line">vault-agent-injector-598675d8dd-fjxdz   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m19s</span>
<span class="line"></span></code></pre></div><p>Kuberntes에 구성된 <code>vault</code> Service Account를 확인합니다.</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">kubectl describe serviceaccount vault</span>
<span class="line"></span></code></pre></div><p>Kubernetes 1.24+ 에서는 <code>vault</code> Service Account Token이 자동생성되지 않으므로, 해당 버전인 경우 다음을 실행하여 <code>Secret</code>을 생성합니다.</p><p>Service Account를 위한 Token을 생성합니다.</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">kubectl apply <span class="token parameter variable">-f</span> - <span class="token operator">&lt;&lt;</span><span class="token string">EOF</span>
<span class="line">apiVersion: v1</span>
<span class="line">kind: Secret</span>
<span class="line">metadata:</span>
<span class="line">  name: vault-token-g955r</span>
<span class="line">  annotations:</span>
<span class="line">    kubernetes.io/service-account.name: vault</span>
<span class="line">type: kubernetes.io/service-account-token</span>
<span class="line">EOF</span></span>
<span class="line"></span></code></pre></div><p><code>VAULT_HELM_SECRET_NAME</code> 환경변수에 시크릿 이름을 선언합니다.</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line"><span class="token assign-left variable">VAULT_HELM_SECRET_NAME</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get secrets <span class="token parameter variable">--output</span><span class="token operator">=</span>json <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> &#39;.items<span class="token punctuation">[</span><span class="token punctuation">]</span>.metadata <span class="token operator">|</span> select<span class="token punctuation">(</span>.name<span class="token operator">|</span>startswith<span class="token punctuation">(</span><span class="token string">&quot;vault-token-&quot;</span><span class="token punctuation">)</span><span class="token variable">)</span></span>.name&#39;<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre></div><p>Vault와 Kubernetes간 인증/인가를 위한 인증 방식을 추가합니다.</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">vault auth <span class="token builtin class-name">enable</span> kubernetes</span>
<span class="line"></span></code></pre></div><p>앞서 시크릿에서 JWT, CA, Host 정보를 환경변수에 선언합니다.</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line"><span class="token assign-left variable">TOKEN_REVIEW_JWT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get secret $VAULT_HELM_SECRET_NAME <span class="token parameter variable">--output</span><span class="token operator">=</span><span class="token string">&#39;go-template={{ .data.token }}&#39;</span> <span class="token operator">|</span> base64 <span class="token parameter variable">--decode</span><span class="token variable">)</span></span></span>
<span class="line"><span class="token assign-left variable">KUBE_CA_CERT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl config view <span class="token parameter variable">--raw</span> <span class="token parameter variable">--minify</span> <span class="token parameter variable">--flatten</span> <span class="token parameter variable">--output</span><span class="token operator">=</span><span class="token string">&#39;jsonpath={.clusters[].cluster.certificate-authority-data}&#39;</span> <span class="token operator">|</span> base64 <span class="token parameter variable">--decode</span><span class="token variable">)</span></span></span>
<span class="line"><span class="token assign-left variable">KUBE_HOST</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl config view <span class="token parameter variable">--raw</span> <span class="token parameter variable">--minify</span> <span class="token parameter variable">--flatten</span> <span class="token parameter variable">--output</span><span class="token operator">=</span><span class="token string">&#39;jsonpath={.clusters[].cluster.server}&#39;</span><span class="token variable">)</span></span></span>
<span class="line"></span></code></pre></div><p>Vault의 Kubernetes 인증/인가 방식에 구성 정보를 추가합니다.</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">vault <span class="token function">write</span> auth/kubernetes/config <span class="token punctuation">\</span></span>
<span class="line">     <span class="token assign-left variable">token_reviewer_jwt</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$TOKEN_REVIEW_JWT</span>&quot;</span> <span class="token punctuation">\</span></span>
<span class="line">     <span class="token assign-left variable">kubernetes_host</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$KUBE_HOST</span>&quot;</span> <span class="token punctuation">\</span></span>
<span class="line">     <span class="token assign-left variable">kubernetes_ca_cert</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$KUBE_CA_CERT</span>&quot;</span> <span class="token punctuation">\</span></span>
<span class="line">     <span class="token assign-left variable">issuer</span><span class="token operator">=</span><span class="token string">&quot;https://kubernetes.default.svc.cluster.local&quot;</span></span>
<span class="line"></span></code></pre></div><p>Kubernetes Service Account 및 맵핑할 Vault의 정책을 정의합니다.</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">vault <span class="token function">write</span> auth/kubernetes/role/injection <span class="token punctuation">\</span></span>
<span class="line">    <span class="token assign-left variable">bound_service_account_names</span><span class="token operator">=</span>webapp-vault <span class="token punctuation">\</span></span>
<span class="line">    <span class="token assign-left variable">bound_service_account_namespaces</span><span class="token operator">=</span>default <span class="token punctuation">\</span></span>
<span class="line">    <span class="token assign-left variable">policies</span><span class="token operator">=</span>admin-role-token-create <span class="token punctuation">\</span></span>
<span class="line">    <span class="token assign-left variable">ttl</span><span class="token operator">=</span>20m</span>
<span class="line"></span></code></pre></div><p>다음과 같이 정의된 Deployment를 적용합니다.</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">kubectl apply <span class="token parameter variable">-f</span> - <span class="token operator">&lt;&lt;</span><span class="token string">EOF</span>
<span class="line">apiVersion: v1</span>
<span class="line">kind: Pod</span>
<span class="line">metadata:</span>
<span class="line">  name: webapp-injection</span>
<span class="line">  labels:</span>
<span class="line">    app: issues</span>
<span class="line">  annotations:</span>
<span class="line">    vault.hashicorp.com/agent-inject: &quot;true&quot;</span>
<span class="line">    vault.hashicorp.com/agent-inject-status: &quot;update&quot;</span>
<span class="line">    vault.hashicorp.com/agent-inject-secret-my-api-key.txt: &quot;auth/token/create/api-admin&quot;</span>
<span class="line">    vault.hashicorp.com/agent-inject-template-my-api-key.txt: |</span>
<span class="line">      {{- with secret &quot;auth/token/create/api-admin&quot; &quot;meta=foo=bar&quot; -}}</span>
<span class="line">      {{ .Auth.ClientToken }}</span>
<span class="line">      {{- end }}</span>
<span class="line">    # Vault의 Kubernetes인증으로 등록되어있는 Role 이름</span>
<span class="line">    vault.hashicorp.com/role: &quot;injection&quot;</span>
<span class="line">  labels:</span>
<span class="line">    app: issues</span>
<span class="line">spec:</span>
<span class="line">  serviceAccountName: webapp-vault</span>
<span class="line">  containers:</span>
<span class="line">  - name: webapp</span>
<span class="line">    image: nginx</span>
<span class="line">EOF</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>내부에 저장된 API Key를 확인합니다.</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">$ kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> webapp-injection <span class="token parameter variable">-c</span> webapp -- <span class="token function">cat</span> /vault/secrets/my-api-key.txt</span>
<span class="line"></span>
<span class="line">hvs.CAESICi60HIi3mA8nG3rgx2WTGfI6HQVsHMWJkqcJg68znyDGh****</span>
<span class="line"></span></code></pre></div><p>약 20초 후 자동으로 갱신됨을 확인합니다.</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> webapp-injection <span class="token parameter variable">-c</span> webapp -- <span class="token function">cat</span> /vault/secrets/my-api-key.txt</span>
<span class="line"></span>
<span class="line">hvs.CAESIIj-RS6NxOFpRWMXlwYCcnG2wfb-WwGJxhlTqSI4hhbBGh****</span>
<span class="line"></span></code></pre></div></details></div><!----><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/docmoa/docs/edit/main/docs/04-HashiCorp/06-Vault/04-UseCase/API-security.md" aria-label="Edit this page on GitHub" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page on GitHub<!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">마지막 수정: </span><!----></div><div class="contributors"><span class="vp-meta-label">기여자: </span><!--[--><!--[--><span class="vp-meta-info" title="email: hahohh@gmail.com">Great-Stone</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><!----><a class="route-link auto-link next" href="/04-HashiCorp/06-Vault/04-UseCase/argocd-vault-plugin.html" aria-label="ArgoCD Vault Plugin"><div class="hint">다음<span class="arrow end"></span></div><div class="link">ArgoCD Vault Plugin<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">CC BY-NC-ND 4.0 Licensed | ⓒ 2021-present docmoa™ contributers all rights reserved.</div><div class="vp-copyright">Copyright © 2025 GS </div></footer></div><!--]--><!--]--><!--[--><!----><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-DVMlqOhY.js" defer></script>
  </body>
</html>
